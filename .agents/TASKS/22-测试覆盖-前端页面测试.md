# ä»»åŠ¡ï¼šå‰ç«¯é¡µé¢æµ‹è¯•

**ä¼˜å…ˆçº§**: ğŸŸ¡ P1 - é«˜ä¼˜å…ˆçº§
**ç±»å‹**: æµ‹è¯•è¦†ç›–
**é¢„ä¼°å·¥æ—¶**: 3-4 å¤©
**å½±å“èŒƒå›´**: apps/web/app/ ç›®å½•

---

## é—®é¢˜æè¿°

å‰ç«¯é¡µé¢ç»„ä»¶ç¼ºå°‘æµ‹è¯•è¦†ç›–ï¼Œæ— æ³•ä¿è¯ï¼š
1. é¡µé¢æ¸²æŸ“æ­£ç¡®æ€§
2. ç”¨æˆ·äº¤äº’è¡Œä¸º
3. çŠ¶æ€ç®¡ç†æ­£ç¡®æ€§
4. é”™è¯¯è¾¹ç•Œå¤„ç†

---

## éœ€è¦æµ‹è¯•çš„é¡µé¢

| é¡µé¢ | è·¯å¾„ | æµ‹è¯•é‡ç‚¹ |
|------|------|----------|
| ç™»å½•é¡µ | `/login` | è¡¨å•éªŒè¯ã€ç™»å½•æµç¨‹ |
| æ³¨å†Œé¡µ | `/register` | è¡¨å•éªŒè¯ã€æ³¨å†Œæµç¨‹ |
| Dashboard | `/dashboard` | æ•°æ®åŠ è½½ã€æƒé™æ£€æŸ¥ |
| Agent åˆ—è¡¨ | `/agents` | åˆ†é¡µã€æœç´¢ã€CRUD |
| Agent è¯¦æƒ… | `/agents/[id]` | æ•°æ®å±•ç¤ºã€ç¼–è¾‘ |
| ä¼šè¯é¡µ | `/chat/[id]` | æ¶ˆæ¯å‘é€ã€SSE |

---

## æµ‹è¯•ç”¨ä¾‹

### 1. ç™»å½•é¡µæµ‹è¯•

```typescript
// apps/web/__tests__/pages/login.test.tsx

import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { describe, it, expect, vi, beforeEach } from 'vitest'
import LoginPage from '../../app/(auth)/login/page'
import { useRouter } from 'next/navigation'

// Mock next/navigation
vi.mock('next/navigation', () => ({
  useRouter: vi.fn()
}))

// Mock API
vi.mock('../../lib/api', () => ({
  login: vi.fn()
}))

import { login } from '../../lib/api'

describe('LoginPage', () => {
  const mockPush = vi.fn()

  beforeEach(() => {
    vi.clearAllMocks()
    ;(useRouter as any).mockReturnValue({ push: mockPush })
  })

  describe('æ¸²æŸ“', () => {
    it('åº”è¯¥æ¸²æŸ“ç™»å½•è¡¨å•', () => {
      render(<LoginPage />)

      expect(screen.getByLabelText(/é‚®ç®±/i)).toBeInTheDocument()
      expect(screen.getByLabelText(/å¯†ç /i)).toBeInTheDocument()
      expect(screen.getByRole('button', { name: /ç™»å½•/i })).toBeInTheDocument()
    })

    it('åº”è¯¥æ˜¾ç¤ºæ³¨å†Œé“¾æ¥', () => {
      render(<LoginPage />)

      expect(screen.getByText(/æ²¡æœ‰è´¦å·/i)).toBeInTheDocument()
      expect(screen.getByRole('link', { name: /æ³¨å†Œ/i })).toBeInTheDocument()
    })
  })

  describe('è¡¨å•éªŒè¯', () => {
    it('åº”è¯¥éªŒè¯å¿…å¡«å­—æ®µ', async () => {
      render(<LoginPage />)

      const submitButton = screen.getByRole('button', { name: /ç™»å½•/i })
      await userEvent.click(submitButton)

      await waitFor(() => {
        expect(screen.getByText(/é‚®ç®±ä¸èƒ½ä¸ºç©º/i)).toBeInTheDocument()
        expect(screen.getByText(/å¯†ç ä¸èƒ½ä¸ºç©º/i)).toBeInTheDocument()
      })
    })

    it('åº”è¯¥éªŒè¯é‚®ç®±æ ¼å¼', async () => {
      render(<LoginPage />)

      const emailInput = screen.getByLabelText(/é‚®ç®±/i)
      await userEvent.type(emailInput, 'invalid-email')

      const submitButton = screen.getByRole('button', { name: /ç™»å½•/i })
      await userEvent.click(submitButton)

      await waitFor(() => {
        expect(screen.getByText(/é‚®ç®±æ ¼å¼ä¸æ­£ç¡®/i)).toBeInTheDocument()
      })
    })

    it('åº”è¯¥éªŒè¯å¯†ç é•¿åº¦', async () => {
      render(<LoginPage />)

      const passwordInput = screen.getByLabelText(/å¯†ç /i)
      await userEvent.type(passwordInput, '123')

      const submitButton = screen.getByRole('button', { name: /ç™»å½•/i })
      await userEvent.click(submitButton)

      await waitFor(() => {
        expect(screen.getByText(/å¯†ç è‡³å°‘ 6 ä½/i)).toBeInTheDocument()
      })
    })
  })

  describe('ç™»å½•æµç¨‹', () => {
    it('æˆåŠŸç™»å½•åº”è¯¥è·³è½¬åˆ° Dashboard', async () => {
      ;(login as any).mockResolvedValue({
        success: true,
        data: { accessToken: 'token', user: { id: '1', name: 'Test' } }
      })

      render(<LoginPage />)

      await userEvent.type(screen.getByLabelText(/é‚®ç®±/i), 'test@example.com')
      await userEvent.type(screen.getByLabelText(/å¯†ç /i), 'password123')
      await userEvent.click(screen.getByRole('button', { name: /ç™»å½•/i }))

      await waitFor(() => {
        expect(mockPush).toHaveBeenCalledWith('/dashboard')
      })
    })

    it('ç™»å½•å¤±è´¥åº”è¯¥æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯', async () => {
      ;(login as any).mockRejectedValue(new Error('Invalid credentials'))

      render(<LoginPage />)

      await userEvent.type(screen.getByLabelText(/é‚®ç®±/i), 'test@example.com')
      await userEvent.type(screen.getByLabelText(/å¯†ç /i), 'wrongpassword')
      await userEvent.click(screen.getByRole('button', { name: /ç™»å½•/i }))

      await waitFor(() => {
        expect(screen.getByText(/ç™»å½•å¤±è´¥/i)).toBeInTheDocument()
      })
    })

    it('ç™»å½•ä¸­åº”è¯¥ç¦ç”¨æäº¤æŒ‰é’®', async () => {
      ;(login as any).mockImplementation(() => new Promise(() => {}))  // æ°¸ä¸ resolve

      render(<LoginPage />)

      await userEvent.type(screen.getByLabelText(/é‚®ç®±/i), 'test@example.com')
      await userEvent.type(screen.getByLabelText(/å¯†ç /i), 'password123')
      await userEvent.click(screen.getByRole('button', { name: /ç™»å½•/i }))

      await waitFor(() => {
        expect(screen.getByRole('button', { name: /ç™»å½•ä¸­/i })).toBeDisabled()
      })
    })
  })
})
```

### 2. Agent åˆ—è¡¨é¡µæµ‹è¯•

```typescript
// apps/web/__tests__/pages/agents.test.tsx

import { render, screen, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { describe, it, expect, vi, beforeEach } from 'vitest'
import AgentsPage from '../../app/(dashboard)/agents/page'

// Mock API
vi.mock('../../lib/api', () => ({
  getAgents: vi.fn()
}))

import { getAgents } from '../../lib/api'

describe('AgentsPage', () => {
  const mockAgents = [
    { id: '1', name: 'Agent 1', description: 'Description 1', isActive: true },
    { id: '2', name: 'Agent 2', description: 'Description 2', isActive: false }
  ]

  beforeEach(() => {
    vi.clearAllMocks()
    ;(getAgents as any).mockResolvedValue({
      data: mockAgents,
      meta: { total: 2, page: 1, limit: 20, totalPages: 1 }
    })
  })

  describe('æ•°æ®åŠ è½½', () => {
    it('åº”è¯¥æ˜¾ç¤ºåŠ è½½çŠ¶æ€', () => {
      ;(getAgents as any).mockImplementation(() => new Promise(() => {}))

      render(<AgentsPage />)

      expect(screen.getByText(/åŠ è½½ä¸­/i)).toBeInTheDocument()
    })

    it('åº”è¯¥æ˜¾ç¤º Agent åˆ—è¡¨', async () => {
      render(<AgentsPage />)

      await waitFor(() => {
        expect(screen.getByText('Agent 1')).toBeInTheDocument()
        expect(screen.getByText('Agent 2')).toBeInTheDocument()
      })
    })

    it('åº”è¯¥æ˜¾ç¤ºç©ºçŠ¶æ€', async () => {
      ;(getAgents as any).mockResolvedValue({
        data: [],
        meta: { total: 0, page: 1, limit: 20, totalPages: 0 }
      })

      render(<AgentsPage />)

      await waitFor(() => {
        expect(screen.getByText(/æš‚æ—  Agent/i)).toBeInTheDocument()
      })
    })

    it('åº”è¯¥æ˜¾ç¤ºé”™è¯¯çŠ¶æ€', async () => {
      ;(getAgents as any).mockRejectedValue(new Error('Failed to fetch'))

      render(<AgentsPage />)

      await waitFor(() => {
        expect(screen.getByText(/åŠ è½½å¤±è´¥/i)).toBeInTheDocument()
      })
    })
  })

  describe('æœç´¢åŠŸèƒ½', () => {
    it('åº”è¯¥æ”¯æŒæœç´¢', async () => {
      render(<AgentsPage />)

      await waitFor(() => {
        expect(screen.getByText('Agent 1')).toBeInTheDocument()
      })

      const searchInput = screen.getByPlaceholderText(/æœç´¢/i)
      await userEvent.type(searchInput, 'Agent 1')

      await waitFor(() => {
        expect(getAgents).toHaveBeenCalledWith(
          expect.objectContaining({ search: 'Agent 1' })
        )
      })
    })
  })

  describe('åˆ†é¡µåŠŸèƒ½', () => {
    it('åº”è¯¥æ˜¾ç¤ºåˆ†é¡µä¿¡æ¯', async () => {
      ;(getAgents as any).mockResolvedValue({
        data: mockAgents,
        meta: { total: 50, page: 1, limit: 20, totalPages: 3 }
      })

      render(<AgentsPage />)

      await waitFor(() => {
        expect(screen.getByText(/å…± 50 æ¡/i)).toBeInTheDocument()
      })
    })

    it('åº”è¯¥æ”¯æŒç¿»é¡µ', async () => {
      ;(getAgents as any).mockResolvedValue({
        data: mockAgents,
        meta: { total: 50, page: 1, limit: 20, totalPages: 3 }
      })

      render(<AgentsPage />)

      await waitFor(() => {
        expect(screen.getByText('Agent 1')).toBeInTheDocument()
      })

      const nextButton = screen.getByRole('button', { name: /ä¸‹ä¸€é¡µ/i })
      await userEvent.click(nextButton)

      await waitFor(() => {
        expect(getAgents).toHaveBeenCalledWith(
          expect.objectContaining({ page: 2 })
        )
      })
    })
  })

  describe('CRUD æ“ä½œ', () => {
    it('åº”è¯¥æœ‰åˆ›å»ºæŒ‰é’®', async () => {
      render(<AgentsPage />)

      await waitFor(() => {
        expect(screen.getByRole('button', { name: /åˆ›å»º/i })).toBeInTheDocument()
      })
    })

    it('ç‚¹å‡» Agent åº”è¯¥è·³è½¬åˆ°è¯¦æƒ…é¡µ', async () => {
      render(<AgentsPage />)

      await waitFor(() => {
        expect(screen.getByText('Agent 1')).toBeInTheDocument()
      })

      // ç‚¹å‡» Agent è¡Œæˆ–é“¾æ¥
      // ...
    })
  })
})
```

### 3. ä¼šè¯é¡µæµ‹è¯•

```typescript
// apps/web/__tests__/pages/chat.test.tsx

import { render, screen, waitFor } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { describe, it, expect, vi, beforeEach } from 'vitest'
import ChatPage from '../../app/(dashboard)/chat/[id]/page'

// Mock API
vi.mock('../../lib/api', () => ({
  getSession: vi.fn(),
  getMessages: vi.fn(),
  sendMessage: vi.fn()
}))

// Mock SSE
vi.mock('../../lib/sse', () => ({
  useSSE: vi.fn()
}))

import { getSession, getMessages, sendMessage } from '../../lib/api'
import { useSSE } from '../../lib/sse'

describe('ChatPage', () => {
  const mockSession = {
    id: 'session-1',
    agentId: 'agent-1',
    agentName: 'Test Agent',
    createdAt: new Date().toISOString()
  }

  const mockMessages = [
    { id: '1', role: 'user', content: 'Hello' },
    { id: '2', role: 'assistant', content: 'Hi there!' }
  ]

  beforeEach(() => {
    vi.clearAllMocks()
    ;(getSession as any).mockResolvedValue({ data: mockSession })
    ;(getMessages as any).mockResolvedValue({ data: mockMessages })
    ;(useSSE as any).mockReturnValue({ connected: true, messages: [] })
  })

  describe('æ¶ˆæ¯å±•ç¤º', () => {
    it('åº”è¯¥æ˜¾ç¤ºå†å²æ¶ˆæ¯', async () => {
      render(<ChatPage params={{ id: 'session-1' }} />)

      await waitFor(() => {
        expect(screen.getByText('Hello')).toBeInTheDocument()
        expect(screen.getByText('Hi there!')).toBeInTheDocument()
      })
    })

    it('åº”è¯¥åŒºåˆ†ç”¨æˆ·å’ŒåŠ©æ‰‹æ¶ˆæ¯', async () => {
      render(<ChatPage params={{ id: 'session-1' }} />)

      await waitFor(() => {
        const userMessage = screen.getByText('Hello').closest('[data-role]')
        const assistantMessage = screen.getByText('Hi there!').closest('[data-role]')

        expect(userMessage).toHaveAttribute('data-role', 'user')
        expect(assistantMessage).toHaveAttribute('data-role', 'assistant')
      })
    })
  })

  describe('å‘é€æ¶ˆæ¯', () => {
    it('åº”è¯¥èƒ½å‘é€æ¶ˆæ¯', async () => {
      ;(sendMessage as any).mockResolvedValue({ success: true })

      render(<ChatPage params={{ id: 'session-1' }} />)

      await waitFor(() => {
        expect(screen.getByText('Hello')).toBeInTheDocument()
      })

      const input = screen.getByPlaceholderText(/è¾“å…¥æ¶ˆæ¯/i)
      await userEvent.type(input, 'New message')

      const sendButton = screen.getByRole('button', { name: /å‘é€/i })
      await userEvent.click(sendButton)

      await waitFor(() => {
        expect(sendMessage).toHaveBeenCalledWith(
          'session-1',
          expect.objectContaining({ content: 'New message' })
        )
      })
    })

    it('ç©ºæ¶ˆæ¯ä¸åº”è¯¥å‘é€', async () => {
      render(<ChatPage params={{ id: 'session-1' }} />)

      await waitFor(() => {
        expect(screen.getByText('Hello')).toBeInTheDocument()
      })

      const sendButton = screen.getByRole('button', { name: /å‘é€/i })
      await userEvent.click(sendButton)

      expect(sendMessage).not.toHaveBeenCalled()
    })

    it('å‘é€ä¸­åº”è¯¥ç¦ç”¨è¾“å…¥', async () => {
      ;(sendMessage as any).mockImplementation(() => new Promise(() => {}))

      render(<ChatPage params={{ id: 'session-1' }} />)

      await waitFor(() => {
        expect(screen.getByText('Hello')).toBeInTheDocument()
      })

      const input = screen.getByPlaceholderText(/è¾“å…¥æ¶ˆæ¯/i)
      await userEvent.type(input, 'New message')

      const sendButton = screen.getByRole('button', { name: /å‘é€/i })
      await userEvent.click(sendButton)

      await waitFor(() => {
        expect(input).toBeDisabled()
        expect(sendButton).toBeDisabled()
      })
    })
  })

  describe('SSE è¿æ¥', () => {
    it('åº”è¯¥æ˜¾ç¤ºè¿æ¥çŠ¶æ€', async () => {
      ;(useSSE as any).mockReturnValue({ connected: true, messages: [] })

      render(<ChatPage params={{ id: 'session-1' }} />)

      await waitFor(() => {
        expect(screen.getByText(/å·²è¿æ¥/i)).toBeInTheDocument()
      })
    })

    it('åº”è¯¥æ˜¾ç¤ºæ–­å¼€çŠ¶æ€', async () => {
      ;(useSSE as any).mockReturnValue({ connected: false, messages: [] })

      render(<ChatPage params={{ id: 'session-1' }} />)

      await waitFor(() => {
        expect(screen.getByText(/å·²æ–­å¼€/i)).toBeInTheDocument()
      })
    })
  })
})
```

---

## æµ‹è¯•ç›®å½•ç»“æ„

```
apps/web/__tests__/
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ login.test.tsx
â”‚   â”œâ”€â”€ register.test.tsx
â”‚   â”œâ”€â”€ dashboard.test.tsx
â”‚   â”œâ”€â”€ agents.test.tsx
â”‚   â”œâ”€â”€ agent-detail.test.tsx
â”‚   â””â”€â”€ chat.test.tsx
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ Button.test.tsx
â”‚   â”œâ”€â”€ Input.test.tsx
â”‚   â”œâ”€â”€ Modal.test.tsx
â”‚   â””â”€â”€ ...
â””â”€â”€ setup.ts
```

---

## ä¿®å¤æ¸…å•

### æµ‹è¯•æ–‡ä»¶
- [ ] åˆ›å»º `__tests__/setup.ts`
- [ ] åˆ›å»º `__tests__/pages/login.test.tsx`
- [ ] åˆ›å»º `__tests__/pages/register.test.tsx`
- [ ] åˆ›å»º `__tests__/pages/dashboard.test.tsx`
- [ ] åˆ›å»º `__tests__/pages/agents.test.tsx`
- [ ] åˆ›å»º `__tests__/pages/agent-detail.test.tsx`
- [ ] åˆ›å»º `__tests__/pages/chat.test.tsx`

### è¦†ç›–ç›®æ ‡
- [ ] é¡µé¢ç»„ä»¶è¦†ç›–ç‡ >= 70%
- [ ] å…³é”®ç”¨æˆ·æµç¨‹æœ‰æµ‹è¯•

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰æ ¸å¿ƒé¡µé¢æœ‰æµ‹è¯•
- [ ] æµ‹è¯•è¦†ç›–ç‡ >= 70%
- [ ] ç”¨æˆ·äº¤äº’æµ‹è¯•å®Œæ•´
- [ ] CI é›†æˆé€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•è§„èŒƒ](docs/design/TESTING.md)
- [å‰ç«¯å¼€å‘è§„èŒƒ](docs/design/FRONTEND.md)
