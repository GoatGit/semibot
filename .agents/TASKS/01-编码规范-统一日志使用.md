# ä»»åŠ¡ï¼šç»Ÿä¸€æ—¥å¿—ä½¿ç”¨

**ä¼˜å…ˆçº§**: ğŸ”´ P0 - ä¸¥é‡
**ç±»å‹**: ç¼–ç è§„èŒƒ
**é¢„ä¼°å·¥æ—¶**: 4-6 å°æ—¶
**å½±å“èŒƒå›´**: 50+ ä¸ªæ–‡ä»¶ï¼Œçº¦ 150+ å¤„ä¿®æ”¹

---

## é—®é¢˜æè¿°

é¡¹ç›®ä¸­å¤§é‡ä½¿ç”¨ `console.log/warn/error/debug/info` è€Œéé¡¹ç›®ç»Ÿä¸€çš„ logger å·¥å…·ï¼Œè¿åäº†ç¼–ç è§„èŒƒã€‚

### è¿è§„ç»Ÿè®¡
- `console.log`: çº¦ 30 å¤„
- `console.warn`: çº¦ 25 å¤„
- `console.error`: çº¦ 35 å¤„
- `console.info`: çº¦ 10 å¤„
- `console.debug`: çº¦ 5 å¤„
- **æ€»è®¡**: çº¦ 135 å¤„

### ä¸»è¦è¿è§„æ–‡ä»¶
1. `apps/api/src/services/chat.service.ts` (15 å¤„)
2. `apps/api/src/adapters/runtime.adapter.ts` (10 å¤„)
3. `apps/api/src/services/mcp.service.ts` (9 å¤„)
4. `apps/api/src/middleware/rateLimit.ts` (8 å¤„)
5. `apps/api/src/lib/redis.ts` (9 å¤„)
6. `apps/api/src/repositories/agent.repository.ts` (9 å¤„)
7. å…¶ä»– 40+ ä¸ªæ–‡ä»¶

---

## è§„èŒƒè¦æ±‚

æ ¹æ® `.claude/rules/coding-standards.md`:

```typescript
// âŒ é”™è¯¯
console.log('[Chat] SSE è¿æ¥å·²åˆ›å»º')
console.warn('[Redis] è¿æ¥å¤±è´¥')
console.error('[MCP] è¿æ¥é”™è¯¯:', error)

// âœ… æ­£ç¡®
import { chatLogger } from '../lib/logger'
chatLogger.info('SSE è¿æ¥å·²åˆ›å»º', { connectionId, sessionId })

import { createLogger } from '../lib/logger'
const redisLogger = createLogger('redis')
redisLogger.warn('è¿æ¥å¤±è´¥', { attempt, maxRetries })

import { mcpLogger } from '../lib/logger'
mcpLogger.error('è¿æ¥é”™è¯¯', error, { serverId })
```

---

## ä¿®å¤æ­¥éª¤

### 1. ç¡®è®¤ Logger å·¥å…·
æ£€æŸ¥ `apps/api/src/lib/logger.ts` æ˜¯å¦å·²å®ç°ï¼š
- âœ… å·²å­˜åœ¨ pino logger
- âœ… å·²å¯¼å‡ºæ¨¡å—çº§ logger: `authLogger`, `chatLogger`, `mcpLogger` ç­‰

### 2. æ‰¹é‡æ›¿æ¢è§„åˆ™

| åŸä»£ç  | æ›¿æ¢ä¸º | æ—¥å¿—çº§åˆ« |
|--------|--------|----------|
| `console.log(...)` | `logger.debug(...)` | DEBUG |
| `console.info(...)` | `logger.info(...)` | INFO |
| `console.warn(...)` | `logger.warn(...)` | WARN |
| `console.error(...)` | `logger.error(...)` | ERROR |
| `console.debug(...)` | `logger.debug(...)` | DEBUG |

### 3. æ—¥å¿—æ ¼å¼è½¬æ¢

```typescript
// åŸä»£ç 
console.log('[Chat] å†å²æ¶ˆæ¯æˆªæ–­ (æ€»æ•°: 20, ä¿ç•™: 10)')

// è½¬æ¢ä¸º
import { chatLogger } from '../lib/logger'
chatLogger.debug('å†å²æ¶ˆæ¯æˆªæ–­', {
  total: 20,
  kept: 10,
  dropped: 10
})
```

### 4. é”™è¯¯æ—¥å¿—è½¬æ¢

```typescript
// åŸä»£ç 
console.error('[MCP] è¿æ¥é”™è¯¯:', error)

// è½¬æ¢ä¸º
import { mcpLogger } from '../lib/logger'
mcpLogger.error('è¿æ¥é”™è¯¯', {
  error: error.message,
  stack: error.stack,
  serverId
})
```

---

## ä¿®å¤æ¸…å•

### Phase 1: Services å±‚ (15 ä¸ªæ–‡ä»¶)
- [ ] `apps/api/src/services/chat.service.ts` (15 å¤„)
- [ ] `apps/api/src/services/mcp.service.ts` (9 å¤„)
- [ ] `apps/api/src/services/llm.service.ts` (3 å¤„)
- [ ] `apps/api/src/services/auth.service.ts` (3 å¤„)
- [ ] å…¶ä»– 11 ä¸ª service æ–‡ä»¶

### Phase 2: Adapters å±‚ (2 ä¸ªæ–‡ä»¶)
- [ ] `apps/api/src/adapters/runtime.adapter.ts` (10 å¤„)

### Phase 3: Middleware å±‚ (3 ä¸ªæ–‡ä»¶)
- [ ] `apps/api/src/middleware/rateLimit.ts` (8 å¤„)
- [ ] `apps/api/src/middleware/auth.ts` (6 å¤„)
- [ ] `apps/api/src/middleware/errorHandler.ts` (1 å¤„)

### Phase 4: Lib å±‚ (1 ä¸ªæ–‡ä»¶)
- [ ] `apps/api/src/lib/redis.ts` (9 å¤„)

### Phase 5: Repositories å±‚ (12 ä¸ªæ–‡ä»¶)
- [ ] `apps/api/src/repositories/agent.repository.ts` (9 å¤„)
- [ ] å…¶ä»– 11 ä¸ª repository æ–‡ä»¶

---

## éªŒè¯æ–¹æ³•

### 1. ä»£ç æ£€æŸ¥
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ console.* ä½¿ç”¨
grep -r "console\." apps/api/src --include="*.ts" --exclude-dir=node_modules
```

### 2. ESLint è§„åˆ™
æ·»åŠ åˆ° `.eslintrc.json`:
```json
{
  "rules": {
    "no-console": ["error", {
      "allow": []
    }]
  }
}
```

### 3. è¿è¡Œæµ‹è¯•
```bash
cd apps/api
pnpm test
```

---

## æ³¨æ„äº‹é¡¹

1. **ä¿ç•™æµ‹è¯•æ–‡ä»¶ä¸­çš„ console.log**
   - æµ‹è¯•æ–‡ä»¶ (`*.test.ts`) ä¸­çš„ console.log å¯ä»¥ä¿ç•™
   - å·¥å…·è„šæœ¬ä¸­çš„ console.log å¯ä»¥ä¿ç•™

2. **æ—¥å¿—çº§åˆ«é€‰æ‹©**
   - å¢åˆ æ”¹æˆåŠŸ â†’ INFO
   - æŸ¥è¯¢/æœç´¢ç»“æœ â†’ DEBUG
   - è¾¹ç•Œ/é™åˆ¶è§¦å‘ â†’ WARN
   - é”™è¯¯/å¼‚å¸¸ â†’ ERROR

3. **ç»“æ„åŒ–æ—¥å¿—**
   - ä½¿ç”¨å¯¹è±¡ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯
   - é¿å…å­—ç¬¦ä¸²æ‹¼æ¥
   - åŒ…å«å…³é”®æ ‡è¯†ç¬¦ï¼ˆuserId, orgId, sessionId ç­‰ï¼‰

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰ 135 å¤„ console.* å·²æ›¿æ¢ä¸º logger
- [ ] ESLint è§„åˆ™å·²æ·»åŠ 
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] æ–‡æ¡£å·²æ›´æ–°ï¼ˆå¦‚éœ€è¦ï¼‰

---

## ç›¸å…³æ–‡æ¡£

- [ç¼–ç è§„èŒƒ - æ—¥å¿—è§„èŒƒ](.claude/rules/coding-standards.md#æ—¥å¿—è§„èŒƒ)
- [Logger å·¥å…·å®ç°](apps/api/src/lib/logger.ts)
