# ä»»åŠ¡ï¼šè¿›åŒ–ç³»ç»Ÿ â€” é›†æˆæµ‹è¯•ä¸ E2E

**ä¼˜å…ˆçº§**: ğŸŸ¡ P1 - é‡è¦
**ç±»å‹**: æµ‹è¯•è¦†ç›–
**é¢„ä¼°å·¥æ—¶**: 3-4 å¤©
**å½±å“èŒƒå›´**: runtime/tests/evolution/ã€apps/api/tests/ã€tests/e2e/

---

## é—®é¢˜æè¿°

è¿›åŒ–ç³»ç»Ÿæ¶‰åŠ Runtimeï¼ˆPythonï¼‰å’Œ APIï¼ˆTypeScriptï¼‰ä¸¤ä¾§çš„åä½œï¼Œéœ€è¦é›†æˆæµ‹è¯•éªŒè¯å®Œæ•´æµç¨‹ï¼šreflect â†’ evolve â†’ skill createdï¼ŒAPI ç«¯ç‚¹æµ‹è¯•ï¼Œä»¥åŠ PLAN é˜¶æ®µæŠ€èƒ½å¤ç”¨æµ‹è¯•ã€‚å•å…ƒæµ‹è¯•æ— æ³•è¦†ç›–è·¨æ¨¡å—äº¤äº’å’Œæ•°æ®æµè½¬çš„æ­£ç¡®æ€§ã€‚

---

## è¯¦ç»†å®ç°

### 1. Runtime é›†æˆæµ‹è¯• â€” å®Œæ•´è¿›åŒ–æµç¨‹

```python
# runtime/tests/evolution/test_integration.py

import pytest
import asyncio
from unittest.mock import Mock, AsyncMock, patch
from src.evolution.engine import EvolutionEngine
from src.evolution.models import SkillDraft


@pytest.mark.integration
class TestEvolutionIntegration:
    """è¿›åŒ–ç³»ç»Ÿé›†æˆæµ‹è¯•"""

    @pytest.fixture
    def mock_db(self):
        """Mock æ•°æ®åº“"""
        db = Mock()
        db.execute = AsyncMock(return_value="skill-001")
        db.fetch = AsyncMock(return_value=[])
        return db

    @pytest.fixture
    def mock_llm(self):
        """Mock LLM"""
        llm = Mock()
        llm.chat = AsyncMock()
        llm.embed = AsyncMock(return_value=[0.1] * 1536)
        return llm

    @pytest.fixture
    def mock_memory(self):
        """Mock Memory System"""
        memory = Mock()
        memory.search_evolved_skills = AsyncMock(return_value=[])
        memory.embed = AsyncMock(return_value=[0.1] * 1536)
        return memory

    @pytest.fixture
    def mock_registry(self):
        """Mock SkillRegistry"""
        registry = Mock()
        registry.refresh_cache = AsyncMock()
        return registry

    @pytest.fixture
    def engine(self, mock_llm, mock_memory, mock_registry, mock_db):
        engine = EvolutionEngine(mock_llm, mock_memory, mock_registry, mock_db)
        engine._check_cooldown = Mock(return_value=True)
        engine._check_rate_limit = Mock(return_value=True)
        return engine

    def _make_state(self):
        return {
            "reflection": {"success": True, "summary": "æˆåŠŸå®Œæˆè®¢å•æŸ¥è¯¢ä»»åŠ¡"},
            "tool_results": [
                {"tool": "order_query", "result": {"status": "shipped"}},
                {"tool": "formatter", "result": "è®¢å•å·²å‘è´§"},
                {"tool": "notifier", "result": "å·²é€šçŸ¥ç”¨æˆ·"},
            ],
            "agent_config": {
                "evolution": {
                    "enabled": True,
                    "auto_approve": False,
                    "min_quality_score": 0.6,
                }
            },
            "agent_id": "agent-001",
            "org_id": "org-001",
            "session_id": "session-001",
            "messages": [
                {"role": "user", "content": "å¸®æˆ‘æŸ¥è¯¢è®¢å• ORD-123 çš„çŠ¶æ€"},
                {"role": "assistant", "content": "æ­£åœ¨æŸ¥è¯¢..."},
            ],
            "plan": {"steps": [{"action": "æŸ¥è¯¢è®¢å•"}]},
        }

    @pytest.mark.asyncio
    async def test_full_evolution_flow(self, engine, mock_llm, mock_db):
        """æµ‹è¯•å®Œæ•´è¿›åŒ–æµç¨‹: EXTRACT â†’ VALIDATE â†’ REGISTER â†’ INDEX"""
        import json

        # Mock LLM è¿”å›æœ‰æ•ˆçš„æŠ€èƒ½è‰ç¨¿
        mock_llm.chat.side_effect = [
            # _extract è°ƒç”¨
            json.dumps({
                "name": "æŸ¥è¯¢è®¢å•çŠ¶æ€",
                "description": "æ ¹æ®è®¢å•å·æŸ¥è¯¢è®¢å•å½“å‰çŠ¶æ€å¹¶é€šçŸ¥ç”¨æˆ·",
                "trigger_keywords": ["è®¢å•", "æŸ¥è¯¢", "çŠ¶æ€"],
                "steps": [
                    {"order": 1, "action": "æŸ¥è¯¢è®¢å•", "tool": "order_query",
                     "params_template": {"order_id": "{order_id}"}},
                    {"order": 2, "action": "æ ¼å¼åŒ–ç»“æœ", "tool": "formatter",
                     "params_template": {}},
                    {"order": 3, "action": "é€šçŸ¥ç”¨æˆ·", "tool": "notifier",
                     "params_template": {}},
                ],
                "tools_used": ["order_query", "formatter", "notifier"],
                "parameters": {
                    "order_id": {"type": "string", "description": "è®¢å•å·", "required": True}
                },
                "preconditions": {"required_tools": ["order_query"]},
                "expected_outcome": "ç”¨æˆ·æ”¶åˆ°è®¢å•çŠ¶æ€é€šçŸ¥",
                "reusability_score": 0.85,
            }),
            # _assess_quality è°ƒç”¨
            json.dumps({
                "score": 0.82,
                "reusability": 0.85,
                "reasoning": "é€šç”¨æ€§å¼ºï¼Œæ­¥éª¤æ¸…æ™°",
            }),
        ]

        state = self._make_state()

        # æ‰§è¡Œå®Œæ•´è¿›åŒ–æµç¨‹
        await engine._evolve(state)

        # éªŒè¯: REGISTER è¢«è°ƒç”¨ï¼ˆå†™å…¥æ•°æ®åº“ï¼‰
        assert mock_db.execute.call_count >= 1

        # éªŒè¯: INDEX è¢«è°ƒç”¨ï¼ˆç”Ÿæˆ embeddingï¼‰
        mock_llm.embed.assert_called_once()

        # éªŒè¯: SkillRegistry ç¼“å­˜è¢«åˆ·æ–°
        engine.skill_registry.refresh_cache.assert_called_once()

    @pytest.mark.asyncio
    async def test_evolution_stops_on_extract_failure(self, engine, mock_llm, mock_db):
        """EXTRACT å¤±è´¥æ—¶æµç¨‹ç»ˆæ­¢"""
        mock_llm.chat.return_value = "æ— æ•ˆçš„ JSON è¾“å‡º"

        state = self._make_state()
        await engine._evolve(state)

        # REGISTER ä¸åº”è¢«è°ƒç”¨
        # åªæœ‰ log_stage çš„ execute è°ƒç”¨
        register_calls = [
            c for c in mock_db.execute.call_args_list
            if 'evolved_skills' in str(c)
        ]
        assert len(register_calls) == 0

    @pytest.mark.asyncio
    async def test_evolution_stops_on_validate_failure(self, engine, mock_llm, mock_db):
        """VALIDATE å¤±è´¥æ—¶æµç¨‹ç»ˆæ­¢ï¼ˆå»é‡å‘½ä¸­ï¼‰"""
        import json

        mock_llm.chat.return_value = json.dumps({
            "name": "å·²æœ‰æŠ€èƒ½",
            "description": "é‡å¤çš„æŠ€èƒ½",
            "steps": [{"order": 1, "action": "test", "tool": "t"}],
            "tools_used": ["t"],
        })

        # æ¨¡æ‹Ÿå»é‡å‘½ä¸­
        engine.memory.search_evolved_skills.return_value = [
            {"name": "å·²æœ‰æŠ€èƒ½", "similarity": 0.9}
        ]

        state = self._make_state()
        await engine._evolve(state)

        # embedding ä¸åº”è¢«ç”Ÿæˆï¼ˆINDEX æœªæ‰§è¡Œï¼‰
        mock_llm.embed.assert_not_called()

    @pytest.mark.asyncio
    async def test_evolution_does_not_block_main_flow(self, engine, mock_llm):
        """è¿›åŒ–å¼‚å¸¸ä¸é˜»å¡ä¸»æµç¨‹"""
        mock_llm.chat.side_effect = Exception("LLM æœåŠ¡ä¸å¯ç”¨")

        state = self._make_state()

        # ä¸åº”æŠ›å‡ºå¼‚å¸¸
        await engine._evolve(state)

    @pytest.mark.asyncio
    async def test_maybe_evolve_fires_and_forgets(self, engine):
        """maybe_evolve ä½¿ç”¨ fire-and-forget æ¨¡å¼"""
        engine._evolve = AsyncMock()

        state = self._make_state()
        await engine.maybe_evolve(state)

        # ç­‰å¾…å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ
        await asyncio.sleep(0.1)

        engine._evolve.assert_called_once_with(state)

    @pytest.mark.asyncio
    async def test_auto_approve_high_quality(self, engine, mock_llm, mock_db):
        """é«˜è´¨é‡ + auto_approve æ—¶è‡ªåŠ¨é€šè¿‡"""
        import json

        mock_llm.chat.side_effect = [
            json.dumps({
                "name": "é«˜è´¨é‡æŠ€èƒ½",
                "description": "éå¸¸å¥½çš„æŠ€èƒ½",
                "steps": [{"order": 1, "action": "test", "tool": "t"}],
                "tools_used": ["t"],
                "reusability_score": 0.9,
            }),
            json.dumps({"score": 0.85, "reusability": 0.9, "reasoning": "ä¼˜ç§€"}),
        ]

        state = self._make_state()
        state["agent_config"]["evolution"]["auto_approve"] = True

        await engine._evolve(state)

        # éªŒè¯å†™å…¥æ—¶ status ä¸º auto_approved
        insert_call = [
            c for c in mock_db.execute.call_args_list
            if 'INSERT INTO evolved_skills' in str(c)
        ]
        # æ£€æŸ¥ status å‚æ•°
        if insert_call:
            args = insert_call[0]
            assert "auto_approved" in str(args)
```

### 2. API ç«¯ç‚¹é›†æˆæµ‹è¯•

```typescript
// apps/api/tests/routes/evolved-skills.test.ts

// æµ‹è¯•è¦ç‚¹ï¼š

// GET /api/v1/evolved-skills
// - è¿”å›åˆ†é¡µåˆ—è¡¨
// - status è¿‡æ»¤æ­£ç¡®
// - agentId è¿‡æ»¤æ­£ç¡®
// - org_id ç§Ÿæˆ·éš”ç¦»ï¼ˆä¸åŒ org çœ‹ä¸åˆ°å¯¹æ–¹æ•°æ®ï¼‰

// GET /api/v1/evolved-skills/:id
// - è¿”å›å®Œæ•´æŠ€èƒ½è¯¦æƒ…
// - ä¸å­˜åœ¨æ—¶è¿”å› 404
// - è·¨ç§Ÿæˆ·è®¿é—®è¿”å› 404

// POST /api/v1/evolved-skills/:id/review
// - approve æˆåŠŸï¼ŒçŠ¶æ€å˜ä¸º approved
// - reject æˆåŠŸï¼ŒçŠ¶æ€å˜ä¸º rejected
// - é pending_review çŠ¶æ€å®¡æ ¸è¿”å› 400
// - ç¼ºå°‘ action å­—æ®µè¿”å› 400

// DELETE /api/v1/evolved-skills/:id
// - è½¯åˆ é™¤æˆåŠŸï¼Œstatus å˜ä¸º deprecated
// - ä¸å­˜åœ¨æ—¶è¿”å› 404

// POST /api/v1/evolved-skills/:id/promote
// - approved çŠ¶æ€å¯æå‡
// - auto_approved çŠ¶æ€å¯æå‡
// - pending_review çŠ¶æ€ä¸å¯æå‡ï¼Œè¿”å› 400
// - rejected çŠ¶æ€ä¸å¯æå‡ï¼Œè¿”å› 400

// GET /api/v1/agents/:agentId/evolution/stats
// - è¿”å›æ­£ç¡®çš„ç»Ÿè®¡æ•°æ®
// - topSkills æŒ‰ use_count æ’åº

// PUT /api/v1/agents/:agentId/evolution
// - æ›´æ–°é…ç½®æˆåŠŸ
// - æ— æ•ˆå‚æ•°è¿”å› 400ï¼ˆå¦‚ minQualityScore > 1ï¼‰
```

### 3. PLAN é˜¶æ®µæŠ€èƒ½å¤ç”¨æµ‹è¯•

```python
# runtime/tests/evolution/test_skill_reuse.py

import pytest
from unittest.mock import Mock, AsyncMock
from src.evolution.retriever import EvolvedSkillRetriever
from src.evolution.formatter import format_skills_for_prompt


class TestSkillRetriever:
    """è¿›åŒ–æŠ€èƒ½æ£€ç´¢æµ‹è¯•"""

    @pytest.fixture
    def retriever(self):
        memory = Mock()
        memory.embed = AsyncMock(return_value=[0.1] * 1536)
        db = Mock()
        db.fetch = AsyncMock()
        return EvolvedSkillRetriever(memory, db)

    @pytest.mark.asyncio
    async def test_search_returns_top5(self, retriever):
        """æ£€ç´¢è¿”å› top-5 ç»“æœ"""
        retriever.db.fetch.return_value = [
            {"id": f"skill-{i}", "name": f"æŠ€èƒ½{i}", "similarity": 0.9 - i * 0.05,
             "description": f"æè¿°{i}", "steps": [], "tools_used": [],
             "parameters": {}, "quality_score": 0.8,
             "use_count": 10, "success_count": 8}
            for i in range(5)
        ]

        results = await retriever.search(
            query="æŸ¥è¯¢è®¢å•", org_id="org-001", limit=5
        )
        assert len(results) == 5
        assert results[0]["similarity"] > results[-1]["similarity"]

    @pytest.mark.asyncio
    async def test_search_empty_results(self, retriever):
        """æ— åŒ¹é…ç»“æœ"""
        retriever.db.fetch.return_value = []

        results = await retriever.search(
            query="å®Œå…¨æ— å…³çš„æŸ¥è¯¢", org_id="org-001", limit=5
        )
        assert len(results) == 0

    @pytest.mark.asyncio
    async def test_search_respects_org_isolation(self, retriever):
        """æ£€ç´¢åŒ…å« org_id è¿‡æ»¤"""
        await retriever.search(query="test", org_id="org-001", limit=5)

        # éªŒè¯ SQL æŸ¥è¯¢åŒ…å« org_id å‚æ•°
        call_args = retriever.db.fetch.call_args
        assert "org-001" in str(call_args)


class TestSkillFormatter:
    """æŠ€èƒ½æ ¼å¼åŒ–æµ‹è¯•"""

    def test_format_empty_skills(self):
        """ç©ºåˆ—è¡¨è¿”å›ç©ºå­—ç¬¦ä¸²"""
        result = format_skills_for_prompt([])
        assert result == ""

    def test_format_single_skill(self):
        """æ ¼å¼åŒ–å•ä¸ªæŠ€èƒ½"""
        skills = [{
            "id": "skill-001",
            "name": "æŸ¥è¯¢è®¢å•",
            "description": "æŸ¥è¯¢è®¢å•çŠ¶æ€",
            "similarity": 0.92,
            "steps": [{"order": 1, "action": "æŸ¥è¯¢"}],
            "use_count": 10,
            "success_count": 8,
        }]
        result = format_skills_for_prompt(skills)
        assert "æŸ¥è¯¢è®¢å•" in result
        assert "0.92" in result
        assert "80%" in result
        assert "skill-001" in result

    def test_format_skill_zero_use_count(self):
        """ä½¿ç”¨æ¬¡æ•°ä¸º 0 æ—¶æˆåŠŸç‡æ˜¾ç¤º N/A"""
        skills = [{
            "id": "skill-001",
            "name": "æ–°æŠ€èƒ½",
            "description": "æè¿°",
            "similarity": 0.8,
            "steps": [],
            "use_count": 0,
            "success_count": 0,
        }]
        result = format_skills_for_prompt(skills)
        assert "N/A" in result

    def test_format_multiple_skills(self):
        """æ ¼å¼åŒ–å¤šä¸ªæŠ€èƒ½"""
        skills = [
            {"id": f"s-{i}", "name": f"æŠ€èƒ½{i}", "description": f"æè¿°{i}",
             "similarity": 0.9 - i * 0.1, "steps": [], "use_count": i, "success_count": i}
            for i in range(3)
        ]
        result = format_skills_for_prompt(skills)
        assert "æŠ€èƒ½ 1" in result
        assert "æŠ€èƒ½ 2" in result
        assert "æŠ€èƒ½ 3" in result
```

### 4. E2E æµ‹è¯•ï¼ˆPlaywrightï¼‰

```typescript
// tests/e2e/evolution.spec.ts

// E2E æµ‹è¯•è¦ç‚¹ï¼ˆéœ€è¦å®Œæ•´ç¯å¢ƒï¼‰ï¼š

// 1. å®Œæ•´è¿›åŒ–æµç¨‹
//    - åˆ›å»º Agent å¹¶å¯ç”¨è¿›åŒ–
//    - å‘é€å¤šæ­¥éª¤ä»»åŠ¡
//    - ç­‰å¾…è¿›åŒ–å®Œæˆ
//    - éªŒè¯ evolved_skills è¡¨æœ‰æ–°è®°å½•

// 2. å®¡æ ¸å·¥ä½œæµ
//    - åˆ—å‡º pending_review æŠ€èƒ½
//    - å®¡æ ¸é€šè¿‡
//    - éªŒè¯çŠ¶æ€å˜ä¸º approved

// 3. æŠ€èƒ½å¤ç”¨
//    - åˆ›å»ºå·²å®¡æ ¸é€šè¿‡çš„è¿›åŒ–æŠ€èƒ½
//    - å‘é€ç›¸ä¼¼ä»»åŠ¡
//    - éªŒè¯ PLAN é˜¶æ®µæ£€ç´¢åˆ°è¿›åŒ–æŠ€èƒ½
//    - éªŒè¯ use_count å¢åŠ 
```

---

## æµ‹è¯•ç›®å½•ç»“æ„

```
runtime/tests/evolution/
â”œâ”€â”€ test_integration.py         # å®Œæ•´è¿›åŒ–æµç¨‹é›†æˆæµ‹è¯•
â””â”€â”€ test_skill_reuse.py         # æŠ€èƒ½å¤ç”¨æµ‹è¯•

apps/api/tests/
â””â”€â”€ routes/
    â””â”€â”€ evolved-skills.test.ts  # API ç«¯ç‚¹é›†æˆæµ‹è¯•

tests/e2e/
â””â”€â”€ evolution.spec.ts           # E2E æµ‹è¯•
```

---

## ä¿®å¤æ¸…å•

- [ ] åˆ›å»º `runtime/tests/evolution/test_integration.py` â€” å®Œæ•´è¿›åŒ–æµç¨‹æµ‹è¯•ï¼ˆ7 ä¸ªç”¨ä¾‹ï¼‰
- [ ] åˆ›å»º `runtime/tests/evolution/test_skill_reuse.py` â€” æŠ€èƒ½æ£€ç´¢å’Œæ ¼å¼åŒ–æµ‹è¯•ï¼ˆ7 ä¸ªç”¨ä¾‹ï¼‰
- [ ] åˆ›å»º `apps/api/tests/routes/evolved-skills.test.ts` â€” API ç«¯ç‚¹æµ‹è¯•
- [ ] åˆ›å»º `tests/e2e/evolution.spec.ts` â€” E2E æµ‹è¯•
- [ ] éªŒè¯è·¨æ¨¡å—æ•°æ®æµè½¬æ­£ç¡®ï¼ˆRuntime â†’ DB â†’ APIï¼‰
- [ ] éªŒè¯ç§Ÿæˆ·éš”ç¦»åœ¨é›†æˆå±‚é¢æ­£ç¡®
- [ ] è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç¡®ä¿é€šè¿‡

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] API ç«¯ç‚¹æµ‹è¯•è¦†ç›–å…¨éƒ¨ 7 ä¸ªç«¯ç‚¹
- [ ] å®Œæ•´è¿›åŒ–æµç¨‹ï¼ˆreflect â†’ evolve â†’ skill createdï¼‰å¯ç«¯åˆ°ç«¯éªŒè¯
- [ ] æŠ€èƒ½å¤ç”¨æµç¨‹ï¼ˆplan â†’ search â†’ reuse â†’ count updateï¼‰å¯éªŒè¯
- [ ] ç§Ÿæˆ·éš”ç¦»åœ¨é›†æˆå±‚é¢éªŒè¯é€šè¿‡
- [ ] E2E æµ‹è¯•å¯åœ¨ CI ç¯å¢ƒè¿è¡Œ
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•è§„èŒƒ](.claude/rules/testing.md)
- [PRD: è¿›åŒ–æŠ€èƒ½å¤ç”¨](.agents/PRDS/evolution-skill-reuse.md)
- [PRD: è¿›åŒ– API](.agents/PRDS/evolution-api.md)
