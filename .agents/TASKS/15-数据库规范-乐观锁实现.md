# ä»»åŠ¡ï¼šå®ç°ä¹è§‚é”ç‰ˆæœ¬æ£€æŸ¥

**ä¼˜å…ˆçº§**: ğŸŸ¡ P1 - é«˜ä¼˜å…ˆçº§
**ç±»å‹**: æ•°æ®åº“è§„èŒƒ
**é¢„ä¼°å·¥æ—¶**: 2-3 å°æ—¶
**å½±å“èŒƒå›´**: å¤šä¸ª Repository

---

## é—®é¢˜æè¿°

è™½ç„¶æ•°æ®åº“è¡¨å·²æ·»åŠ  `version` å­—æ®µï¼Œæ›´æ–°æ—¶ä¹Ÿé€’å¢ç‰ˆæœ¬å·ï¼Œä½†**æœªæ£€æŸ¥ç‰ˆæœ¬å†²çª**ï¼Œæ— æ³•é˜²æ­¢å¹¶å‘æ›´æ–°è¦†ç›–ã€‚

---

## è§„èŒƒè¦æ±‚

æ ¹æ® `.claude/rules/database.md`:

```typescript
// âœ… æ­£ç¡®çš„ä¹è§‚é”å®ç°
const result = await sql`
  UPDATE skills
  SET name = ${name}, version = version + 1
  WHERE id = ${id} AND version = ${currentVersion}
`
if (result.rowCount === 0) {
  throw createError(409, 'CONFLICT', 'æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹')
}
```

---

## å½“å‰å®ç°

**æ–‡ä»¶**: `apps/api/src/repositories/agent.repository.ts:292`

```typescript
// âš ï¸ åªé€’å¢ç‰ˆæœ¬ï¼Œæœªæ£€æŸ¥å†²çª
UPDATE agents SET name = ${data.name}, version = version + 1, updated_at = NOW()
WHERE id = ${id} AND org_id = ${orgId}
```

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. Repository å±‚æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥

```typescript
// apps/api/src/repositories/agent.repository.ts

export async function update(
  id: string,
  orgId: string,
  data: UpdateAgentData,
  updatedBy: string,
  expectedVersion: number  // âœ… æ·»åŠ ç‰ˆæœ¬å‚æ•°
): Promise<AgentRow | null> {
  const result = await sql`
    UPDATE agents
    SET name = ${data.name},
        description = ${data.description},
        version = version + 1,
        updated_at = NOW(),
        updated_by = ${updatedBy}
    WHERE id = ${id}
    AND org_id = ${orgId}
    AND version = ${expectedVersion}  -- âœ… æ£€æŸ¥ç‰ˆæœ¬
    RETURNING *
  `

  return result[0] || null
}
```

### 2. Service å±‚å¤„ç†å†²çª

```typescript
// apps/api/src/services/agent.service.ts

export async function updateAgent(
  agentId: string,
  orgId: string,
  userId: string,
  data: UpdateAgentInput,
  expectedVersion: number  // âœ… æ·»åŠ ç‰ˆæœ¬å‚æ•°
): Promise<Agent> {
  const updated = await agentRepository.update(
    agentId,
    orgId,
    data,
    userId,
    expectedVersion
  )

  if (!updated) {
    // æ£€æŸ¥æ˜¯ Agent ä¸å­˜åœ¨è¿˜æ˜¯ç‰ˆæœ¬å†²çª
    const existing = await agentRepository.findByIdAndOrg(agentId, orgId)
    if (!existing) {
      throw createError(AGENT_NOT_FOUND)
    }
    // ç‰ˆæœ¬å†²çª
    throw createError(409, 'VERSION_CONFLICT', 'æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•')
  }

  return rowToAgent(updated)
}
```

### 3. Route å±‚ä¼ é€’ç‰ˆæœ¬

```typescript
// apps/api/src/routes/v1/agents.ts

const updateAgentSchema = z.object({
  name: z.string().min(1).max(100).optional(),
  description: z.string().max(1000).optional(),
  version: z.number().int().min(1)  // âœ… å¿…é¡»æä¾›ç‰ˆæœ¬
})

router.put(
  '/:id',
  authenticate,
  validate(updateAgentSchema, 'body'),
  asyncHandler(async (req: AuthRequest, res) => {
    const { id } = req.params
    const { orgId, userId } = req.auth!
    const { version, ...data } = req.body

    const agent = await agentService.updateAgent(id, orgId, userId, data, version)

    res.json({
      success: true,
      data: agent
    })
  })
)
```

### 4. å‰ç«¯å¤„ç†å†²çª

```typescript
// apps/web/hooks/useAgent.ts

async function updateAgent(agentId: string, data: UpdateAgentInput) {
  try {
    const response = await fetch(`/api/v1/agents/${agentId}`, {
      method: 'PUT',
      body: JSON.stringify({
        ...data,
        version: agent.version  // âœ… å‘é€å½“å‰ç‰ˆæœ¬
      })
    })

    if (response.status === 409) {
      // ç‰ˆæœ¬å†²çªï¼Œæç¤ºç”¨æˆ·åˆ·æ–°
      toast.error('æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•')
      await refreshAgent()
      return
    }

    // æ›´æ–°æˆåŠŸ
    const result = await response.json()
    setAgent(result.data)
  } catch (error) {
    // å¤„ç†å…¶ä»–é”™è¯¯
  }
}
```

---

## éœ€è¦ä¿®å¤çš„ Repository

| Repository | æ–¹æ³• | çŠ¶æ€ |
|------------|------|------|
| `agent.repository.ts` | update | âš ï¸ éœ€è¦æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥ |
| `skill.repository.ts` | update | âš ï¸ éœ€è¦æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥ |
| `tool.repository.ts` | update | âš ï¸ éœ€è¦æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥ |
| `mcp.repository.ts` | update | âš ï¸ éœ€è¦æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥ |

---

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
```typescript
describe('ä¹è§‚é”æµ‹è¯•', () => {
  it('ç‰ˆæœ¬åŒ¹é…æ—¶åº”è¯¥æ›´æ–°æˆåŠŸ', async () => {
    const agent = await agentRepository.create(data)
    expect(agent.version).toBe(1)

    const updated = await agentRepository.update(
      agent.id, orgId, { name: 'New Name' }, userId, 1
    )

    expect(updated).not.toBeNull()
    expect(updated.version).toBe(2)
  })

  it('ç‰ˆæœ¬ä¸åŒ¹é…æ—¶åº”è¯¥è¿”å› null', async () => {
    const agent = await agentRepository.create(data)

    const updated = await agentRepository.update(
      agent.id, orgId, { name: 'New Name' }, userId, 999  // é”™è¯¯ç‰ˆæœ¬
    )

    expect(updated).toBeNull()
  })

  it('å¹¶å‘æ›´æ–°åº”è¯¥åªæœ‰ä¸€ä¸ªæˆåŠŸ', async () => {
    const agent = await agentRepository.create(data)

    // å¹¶å‘æ›´æ–°
    const [result1, result2] = await Promise.all([
      agentRepository.update(agent.id, orgId, { name: 'Name 1' }, userId, 1),
      agentRepository.update(agent.id, orgId, { name: 'Name 2' }, userId, 1)
    ])

    // åªæœ‰ä¸€ä¸ªæˆåŠŸ
    const successCount = [result1, result2].filter(r => r !== null).length
    expect(successCount).toBe(1)
  })
})
```

---

## ä¿®å¤æ¸…å•

### Repository å±‚
- [ ] `agent.repository.ts` - update æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥
- [ ] `skill.repository.ts` - update æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥
- [ ] `tool.repository.ts` - update æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥
- [ ] `mcp.repository.ts` - update æ·»åŠ ç‰ˆæœ¬æ£€æŸ¥

### Service å±‚
- [ ] `agent.service.ts` - å¤„ç†ç‰ˆæœ¬å†²çª
- [ ] `skill.service.ts` - å¤„ç†ç‰ˆæœ¬å†²çª
- [ ] `tool.service.ts` - å¤„ç†ç‰ˆæœ¬å†²çª
- [ ] `mcp.service.ts` - å¤„ç†ç‰ˆæœ¬å†²çª

### Route å±‚
- [ ] æ›´æ–° Schema æ·»åŠ  version å­—æ®µ
- [ ] ä¼ é€’ version åˆ° Service

### å‰ç«¯
- [ ] å‘é€ version å­—æ®µ
- [ ] å¤„ç† 409 å†²çªå“åº”

### æµ‹è¯•
- [ ] æ·»åŠ ä¹è§‚é”å•å…ƒæµ‹è¯•
- [ ] æ·»åŠ å¹¶å‘æµ‹è¯•

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰ update æ–¹æ³•æ£€æŸ¥ç‰ˆæœ¬
- [ ] ç‰ˆæœ¬å†²çªè¿”å› 409 çŠ¶æ€ç 
- [ ] å‰ç«¯æ­£ç¡®å¤„ç†å†²çª
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] å¹¶å‘æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è§„èŒƒ - ä¹è§‚é”](.claude/rules/database.md#ä¹è§‚é”)
