# ä»»åŠ¡ï¼šç¦ç”¨ç‰©ç†åˆ é™¤

**ä¼˜å…ˆçº§**: ğŸ”´ P0 - ä¸¥é‡
**ç±»å‹**: æ•°æ®åº“è§„èŒƒ
**é¢„ä¼°å·¥æ—¶**: 1-2 å°æ—¶
**å½±å“èŒƒå›´**: 3 ä¸ª Repository

---

## é—®é¢˜æè¿°

éƒ¨åˆ† Repository ä»ä½¿ç”¨ `DELETE FROM` ç‰©ç†åˆ é™¤æ•°æ®ï¼Œè¿åäº†æ•°æ®åº“è§„èŒƒã€‚ç‰©ç†åˆ é™¤ä¼šå¯¼è‡´ï¼š
1. æ•°æ®æ— æ³•æ¢å¤
2. è¿åå®¡è®¡è¦æ±‚
3. å¯èƒ½ç ´åæ•°æ®å®Œæ•´æ€§

---

## è§„èŒƒè¦æ±‚

æ ¹æ® `.claude/rules/database.md`:

**æ ¸å¿ƒè¡¨ä½¿ç”¨è½¯åˆ é™¤æœºåˆ¶ï¼Œç¦æ­¢ç‰©ç†åˆ é™¤ã€‚**

```typescript
// âŒ é”™è¯¯ - ç‰©ç†åˆ é™¤
await sql`DELETE FROM table_name WHERE id = ${id}`

// âœ… æ­£ç¡® - è½¯åˆ é™¤
await sql`
  UPDATE table_name
  SET deleted_at = NOW(), deleted_by = ${userId}, updated_at = NOW()
  WHERE id = ${id}
`
```

---

## è¿è§„ä½ç½®

### 1. Memory Repository âŒ
**æ–‡ä»¶**: `apps/api/src/repositories/memory.repository.ts:206`

```typescript
// âŒ é”™è¯¯ - ç‰©ç†åˆ é™¤
export async function remove(id: string): Promise<boolean> {
  const result = await sql`
    DELETE FROM memories WHERE id = ${id} RETURNING id
  `
  return result.length > 0
}

// âœ… ä¿®å¤ - è½¯åˆ é™¤
export async function softDelete(id: string, deletedBy: string): Promise<boolean> {
  const result = await sql`
    UPDATE memories
    SET deleted_at = NOW(),
        deleted_by = ${deletedBy},
        updated_at = NOW()
    WHERE id = ${id}
    RETURNING id
  `
  return result.length > 0
}
```

### 2. Session Repository âŒ
**æ–‡ä»¶**: `apps/api/src/repositories/session.repository.ts:207`

```typescript
// âŒ é”™è¯¯ - ç‰©ç†åˆ é™¤
export async function remove(id: string, orgId: string): Promise<boolean> {
  const result = await sql`
    DELETE FROM sessions
    WHERE id = ${id} AND org_id = ${orgId}
  `
  return result.length > 0
}

// âœ… ä¿®å¤ - è½¯åˆ é™¤
export async function softDelete(id: string, orgId: string, deletedBy: string): Promise<boolean> {
  const result = await sql`
    UPDATE sessions
    SET deleted_at = NOW(),
        deleted_by = ${deletedBy},
        updated_at = NOW()
    WHERE id = ${id} AND org_id = ${orgId}
    RETURNING id
  `
  return result.length > 0
}
```

### 3. Message Repository âŒ
**æ–‡ä»¶**: `apps/api/src/repositories/message.repository.ts:160`

```typescript
// âŒ é”™è¯¯ - ç‰©ç†åˆ é™¤
export async function deleteBySessionId(sessionId: string): Promise<number> {
  const result = await sql`
    DELETE FROM messages
    WHERE session_id = ${sessionId}
  `
  return result.length
}

// âœ… ä¿®å¤ - è½¯åˆ é™¤
export async function softDeleteBySessionId(sessionId: string, deletedBy: string): Promise<number> {
  const result = await sql`
    UPDATE messages
    SET deleted_at = NOW(),
        deleted_by = ${deletedBy},
        updated_at = NOW()
    WHERE session_id = ${sessionId}
    RETURNING id
  `
  return result.length
}
```

---

## ä¿®å¤æ­¥éª¤

### Phase 1: æ£€æŸ¥è¡¨æ˜¯å¦æœ‰ deleted_at å­—æ®µ

```sql
-- æ£€æŸ¥ memories è¡¨
SELECT column_name
FROM information_schema.columns
WHERE table_name = 'memories'
AND column_name IN ('deleted_at', 'deleted_by');

-- æ£€æŸ¥ sessions è¡¨
SELECT column_name
FROM information_schema.columns
WHERE table_name = 'sessions'
AND column_name IN ('deleted_at', 'deleted_by');

-- æ£€æŸ¥ messages è¡¨
SELECT column_name
FROM information_schema.columns
WHERE table_name = 'messages'
AND column_name IN ('deleted_at', 'deleted_by');
```

**å¦‚æœå­—æ®µä¸å­˜åœ¨ï¼Œéœ€è¦å…ˆåˆ›å»ºè¿ç§»è„šæœ¬æ·»åŠ å­—æ®µã€‚**

### Phase 2: Repository å±‚ä¿®å¤

#### 2.1 Memory Repository
```typescript
// 1. é‡å‘½åæ—§æ–¹æ³•ï¼ˆä¿ç•™å…¼å®¹ï¼‰
/**
 * @deprecated ä½¿ç”¨ softDelete ä»£æ›¿
 */
export async function remove(id: string): Promise<boolean> {
  console.warn('[MemoryRepository] remove() å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ softDelete()')
  return softDelete(id, 'system')
}

// 2. æ·»åŠ æ–°æ–¹æ³•
export async function softDelete(id: string, deletedBy: string): Promise<boolean> {
  const result = await sql`
    UPDATE memories
    SET deleted_at = NOW(),
        deleted_by = ${deletedBy},
        updated_at = NOW()
    WHERE id = ${id}
    RETURNING id
  `
  return result.length > 0
}
```

#### 2.2 Session Repository
```typescript
export async function softDelete(id: string, orgId: string, deletedBy: string): Promise<boolean> {
  const result = await sql`
    UPDATE sessions
    SET deleted_at = NOW(),
        deleted_by = ${deletedBy},
        updated_at = NOW()
    WHERE id = ${id} AND org_id = ${orgId}
    RETURNING id
  `
  return result.length > 0
}
```

#### 2.3 Message Repository
```typescript
// æ‰¹é‡è½¯åˆ é™¤
export async function softDeleteBySessionId(sessionId: string, deletedBy: string): Promise<number> {
  const result = await sql`
    UPDATE messages
    SET deleted_at = NOW(),
        deleted_by = ${deletedBy},
        updated_at = NOW()
    WHERE session_id = ${sessionId}
    RETURNING id
  `
  return result.length
}
```

### Phase 3: Service å±‚ä¿®å¤

#### 3.1 æ›´æ–° Service è°ƒç”¨
```typescript
// âŒ é”™è¯¯
await memoryRepository.remove(memoryId)

// âœ… æ­£ç¡®
await memoryRepository.softDelete(memoryId, userId)
```

#### 3.2 çº§è”è½¯åˆ é™¤
```typescript
// åˆ é™¤ Session æ—¶ï¼ŒåŒæ—¶è½¯åˆ é™¤å…³è”çš„ Messages
export async function deleteSession(sessionId: string, orgId: string, userId: string): Promise<void> {
  // 1. è½¯åˆ é™¤ Session
  await sessionRepository.softDelete(sessionId, orgId, userId)

  // 2. è½¯åˆ é™¤å…³è”çš„ Messages
  await messageRepository.softDeleteBySessionId(sessionId, userId)
}
```

---

## ä¿®å¤æ¸…å•

### Repository å±‚
- [ ] `memory.repository.ts`
  - [ ] æ·»åŠ  `softDelete` æ–¹æ³•
  - [ ] åºŸå¼ƒ `remove` æ–¹æ³•
- [x] `session.repository.ts`
  - [x] æ·»åŠ  `softDelete` æ–¹æ³•
  - [x] åºŸå¼ƒ `remove` æ–¹æ³•
- [x] `message.repository.ts`
  - [x] æ·»åŠ  `softDeleteBySessionId` æ–¹æ³•
  - [x] åºŸå¼ƒ `deleteBySessionId` æ–¹æ³•

### Service å±‚
- [ ] æ›´æ–°æ‰€æœ‰è°ƒç”¨ `remove` çš„åœ°æ–¹
- [ ] ä¼ å…¥ `deletedBy` å‚æ•°ï¼ˆuserIdï¼‰
- [ ] å®ç°çº§è”è½¯åˆ é™¤é€»è¾‘

### æ•°æ®åº“è¿ç§»ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] ä¸º `memories` è¡¨æ·»åŠ  `deleted_at`, `deleted_by`
- [ ] ä¸º `sessions` è¡¨æ·»åŠ  `deleted_at`, `deleted_by`
- [ ] ä¸º `messages` è¡¨æ·»åŠ  `deleted_at`, `deleted_by`

---

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
```typescript
describe('è½¯åˆ é™¤åŠŸèƒ½', () => {
  it('softDelete åº”è¯¥è®¾ç½® deleted_at è€Œéç‰©ç†åˆ é™¤', async () => {
    const memory = await memoryRepository.create(data)

    await memoryRepository.softDelete(memory.id, userId)

    // ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œè®°å½•åº”è¯¥å­˜åœ¨ä½†æœ‰ deleted_at
    const result = await sql`
      SELECT id, deleted_at, deleted_by
      FROM memories
      WHERE id = ${memory.id}
    `
    expect(result[0].deleted_at).not.toBeNull()
    expect(result[0].deleted_by).toBe(userId)
  })

  it('çº§è”è½¯åˆ é™¤åº”è¯¥åˆ é™¤å…³è”è®°å½•', async () => {
    const session = await sessionRepository.create(data)
    const message = await messageRepository.create({ sessionId: session.id, ... })

    await sessionService.deleteSession(session.id, orgId, userId)

    // Session å’Œ Message éƒ½åº”è¯¥è¢«è½¯åˆ é™¤
    const sessionResult = await sessionRepository.findById(session.id)
    const messageResult = await messageRepository.findById(message.id)

    expect(sessionResult).toBeNull()
    expect(messageResult).toBeNull()
  })
})
```

### 2. æ•°æ®æ¢å¤æµ‹è¯•
```typescript
describe('æ•°æ®æ¢å¤', () => {
  it('è½¯åˆ é™¤çš„æ•°æ®å¯ä»¥æ¢å¤', async () => {
    const memory = await memoryRepository.create(data)
    await memoryRepository.softDelete(memory.id, userId)

    // æ¢å¤æ•°æ®
    await sql`
      UPDATE memories
      SET deleted_at = NULL, deleted_by = NULL
      WHERE id = ${memory.id}
    `

    // åº”è¯¥å¯ä»¥å†æ¬¡æŸ¥è¯¢åˆ°
    const result = await memoryRepository.findById(memory.id)
    expect(result).not.toBeNull()
  })
})
```

---

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¿ç§»**
   - å¦‚æœè¡¨æ²¡æœ‰ `deleted_at` å­—æ®µï¼Œéœ€è¦å…ˆè¿è¡Œè¿ç§»
   - è¿ç§»è„šæœ¬åº”è¯¥æ·»åŠ å­—æ®µä½†ä¸å½±å“ç°æœ‰æ•°æ®

2. **çº§è”åˆ é™¤**
   - åˆ é™¤çˆ¶è®°å½•æ—¶ï¼Œè€ƒè™‘æ˜¯å¦éœ€è¦çº§è”åˆ é™¤å­è®°å½•
   - ä¾‹å¦‚ï¼šåˆ é™¤ Session æ—¶ï¼Œæ˜¯å¦åˆ é™¤å…³è”çš„ Messages

3. **æ€§èƒ½è€ƒè™‘**
   - è½¯åˆ é™¤ä¼šå¢åŠ è¡¨å¤§å°
   - è€ƒè™‘å®šæœŸå½’æ¡£æˆ–æ¸…ç†æ—§çš„è½¯åˆ é™¤è®°å½•
   - ä¸º `deleted_at` æ·»åŠ ç´¢å¼•

4. **å®¡è®¡è¦æ±‚**
   - å§‹ç»ˆè®°å½• `deleted_by`
   - ä¿ç•™åˆ é™¤æ—¶é—´ `deleted_at`

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰ç‰©ç†åˆ é™¤å·²æ›¿æ¢ä¸ºè½¯åˆ é™¤
- [ ] æ‰€æœ‰è½¯åˆ é™¤æ“ä½œè®°å½• `deleted_by`
- [ ] çº§è”åˆ é™¤é€»è¾‘å·²å®ç°
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è§„èŒƒ - è½¯åˆ é™¤](.claude/rules/database.md#è½¯åˆ é™¤)
- [è¿ç§»è„šæœ¬](database/migrations/007_add_soft_delete_and_audit.sql)
