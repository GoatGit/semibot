# ä»»åŠ¡ï¼šä¿®å¤å¤šç§Ÿæˆ·éš”ç¦»æ¼æ´

**ä¼˜å…ˆçº§**: ğŸ”´ P0 - ä¸¥é‡
**ç±»å‹**: å®‰å…¨è§„èŒƒ
**é£é™©ç­‰çº§**: HIGH - å¯èƒ½å¯¼è‡´è·¨ç§Ÿæˆ·æ•°æ®æ³„éœ²
**é¢„ä¼°å·¥æ—¶**: 2-3 å°æ—¶
**å½±å“èŒƒå›´**: 4 ä¸ª Repositoryï¼Œå¤šä¸ª Service

---

## é—®é¢˜æè¿°

éƒ¨åˆ† Repository çš„ `findById` æ–¹æ³•ç¼ºå°‘ `org_id` éªŒè¯ï¼Œå¯èƒ½å¯¼è‡´è·¨ç§Ÿæˆ·æ•°æ®æ³„éœ²ã€‚

---

## ä¸¥é‡é—®é¢˜

### 1. Message Repository âš ï¸ HIGH RISK
**æ–‡ä»¶**: `apps/api/src/repositories/message.repository.ts:90-92`

```typescript
// âŒ å½“å‰å®ç° - ç¼ºå°‘ org_id æ£€æŸ¥
export async function findById(id: string): Promise<MessageRow | null> {
  const result = await sql`SELECT * FROM messages WHERE id = ${id}`
  if (result.length === 0) return null
  return result[0] as unknown as MessageRow
}

// âœ… å»ºè®®å®ç° - é€šè¿‡ session å…³è”éªŒè¯
export async function findByIdAndOrg(id: string, orgId: string): Promise<MessageRow | null> {
  const result = await sql`
    SELECT m.* FROM messages m
    JOIN sessions s ON m.session_id = s.id
    WHERE m.id = ${id} AND s.org_id = ${orgId}
  `
  if (result.length === 0) return null
  return result[0] as unknown as MessageRow
}
```

**é£é™©**: ä»»ä½•ç”¨æˆ·å¯ä»¥é€šè¿‡ message_id è®¿é—®å…¶ä»–ç»„ç»‡çš„æ¶ˆæ¯

---

### 2. Tool Repository âš ï¸ MEDIUM RISK
**æ–‡ä»¶**: `apps/api/src/repositories/tool.repository.ts:100-109`

```typescript
// âŒ å½“å‰å®ç° - ç¼ºå°‘ org_id æ£€æŸ¥
export async function findById(id: string): Promise<ToolRow | null> {
  const result = await sql`SELECT * FROM tools WHERE id = ${id}`
  if (result.length === 0) return null
  return result[0] as unknown as ToolRow
}

// âœ… å»ºè®®å®ç° - æ·»åŠ  org_id å‚æ•°
export async function findByIdAndOrg(id: string, orgId: string): Promise<ToolRow | null> {
  const result = await sql`
    SELECT * FROM tools
    WHERE id = ${id}
    AND (org_id = ${orgId} OR is_builtin = true)
  `
  if (result.length === 0) return null
  return result[0] as unknown as ToolRow
}
```

**è¯´æ˜**: Tool æ”¯æŒ `is_builtin` æ ‡å¿—ï¼Œå†…ç½®å·¥å…·å¯ä»¥è·¨ç»„ç»‡è®¿é—®

---

### 3. Skill Repository âš ï¸ MEDIUM RISK
**æ–‡ä»¶**: `apps/api/src/repositories/skill.repository.ts:120-130`

```typescript
// âŒ å½“å‰å®ç° - ç¼ºå°‘ org_id æ£€æŸ¥
export async function findById(id: string): Promise<SkillRow | null> {
  const useDeletedAt = await hasSkillsDeletedAtColumn()
  const result = useDeletedAt
    ? await sql`SELECT * FROM skills WHERE id = ${id} AND deleted_at IS NULL`
    : await sql`SELECT * FROM skills WHERE id = ${id}`
  return result[0] || null
}

// âœ… å»ºè®®å®ç° - æ·»åŠ  org_id å‚æ•°
export async function findByIdAndOrg(id: string, orgId: string): Promise<SkillRow | null> {
  const result = await sql`
    SELECT * FROM skills
    WHERE id = ${id}
    AND (org_id = ${orgId} OR is_builtin = true)
    AND deleted_at IS NULL
  `
  return result[0] || null
}
```

---

### 4. Agent Repository âš ï¸ MEDIUM RISK
**æ–‡ä»¶**: `apps/api/src/repositories/agent.repository.ts:102-111`

```typescript
// âŒ å½“å‰å®ç° - ç¼ºå°‘ org_id æ£€æŸ¥
export async function findById(id: string): Promise<AgentRow | null> {
  const result = await sql`SELECT * FROM agents WHERE id = ${id}`
  if (result.length === 0) return null
  return result[0] as unknown as AgentRow
}

// âœ… å·²æœ‰ findByIdAndOrg æ–¹æ³•ï¼Œä½† findById ä»è¢«ä½¿ç”¨
```

**è¯´æ˜**:
- å·²æœ‰ `findByIdAndOrg` æ–¹æ³•ï¼ˆL120ï¼‰
- Service å±‚åœ¨å…¬å¼€ Agent è®¿é—®æ—¶æœ‰éªŒè¯ï¼ˆL215ï¼‰
- ä½† `findById` æ–¹æ³•ä»å­˜åœ¨ï¼Œå¯èƒ½è¢«è¯¯ç”¨

---

## ä¿®å¤æ­¥éª¤

### Phase 1: Repository å±‚ä¿®å¤

#### 1.1 Message Repository
```typescript
// 1. æ·»åŠ æ–°æ–¹æ³•
export async function findByIdAndOrg(id: string, orgId: string): Promise<MessageRow | null> {
  const result = await sql`
    SELECT m.* FROM messages m
    JOIN sessions s ON m.session_id = s.id
    WHERE m.id = ${id} AND s.org_id = ${orgId}
  `
  return result[0] || null
}

// 2. åºŸå¼ƒæ—§æ–¹æ³•ï¼ˆæ·»åŠ æ³¨é‡Šï¼‰
/**
 * @deprecated ä½¿ç”¨ findByIdAndOrg ä»£æ›¿ï¼Œä»¥ç¡®ä¿å¤šç§Ÿæˆ·éš”ç¦»
 */
export async function findById(id: string): Promise<MessageRow | null> {
  // ä¿ç•™ä»¥å…¼å®¹ï¼Œä½†åº”é€æ­¥è¿ç§»
  const result = await sql`SELECT * FROM messages WHERE id = ${id}`
  return result[0] || null
}
```

#### 1.2 Tool Repository
```typescript
export async function findByIdAndOrg(id: string, orgId: string): Promise<ToolRow | null> {
  const result = await sql`
    SELECT * FROM tools
    WHERE id = ${id}
    AND (org_id = ${orgId} OR is_builtin = true)
  `
  return result[0] || null
}
```

#### 1.3 Skill Repository
```typescript
export async function findByIdAndOrg(id: string, orgId: string): Promise<SkillRow | null> {
  const result = await sql`
    SELECT * FROM skills
    WHERE id = ${id}
    AND (org_id = ${orgId} OR is_builtin = true)
    AND deleted_at IS NULL
  `
  return result[0] || null
}
```

#### 1.4 Agent Repository
```typescript
// ç§»é™¤ findById æ–¹æ³•ï¼Œå¼ºåˆ¶ä½¿ç”¨ findByIdAndOrg
// æˆ–æ·»åŠ  @deprecated æ³¨é‡Š
```

---

### Phase 2: Service å±‚ä¿®å¤

#### 2.1 æ£€æŸ¥æ‰€æœ‰è°ƒç”¨ findById çš„åœ°æ–¹
```bash
# æœç´¢æ‰€æœ‰ findById è°ƒç”¨
grep -rn "\.findById(" apps/api/src/services --include="*.ts"
```

#### 2.2 æ›¿æ¢ä¸º findByIdAndOrg
```typescript
// âŒ é”™è¯¯
const message = await messageRepository.findById(messageId)

// âœ… æ­£ç¡®
const message = await messageRepository.findByIdAndOrg(messageId, orgId)
if (!message) {
  throw createError(RESOURCE_NOT_FOUND)
}
```

---

### Phase 3: æ·»åŠ å®‰å…¨è­¦å‘Šæ—¥å¿—

åœ¨æ‰€æœ‰ Repository çš„æŸ¥è¯¢æ–¹æ³•ä¸­æ·»åŠ ï¼š

```typescript
export async function findAll(params: ListParams): Promise<PaginatedResult<Row>> {
  const { orgId, ... } = params

  // âœ… æ·»åŠ å®‰å…¨è­¦å‘Š
  if (!orgId) {
    logger.warn('[Security] æŸ¥è¯¢æœªæä¾› org_idï¼Œå­˜åœ¨è·¨ç§Ÿæˆ·é£é™©', {
      method: 'findAll',
      repository: 'MessageRepository'
    })
  }

  // ... æŸ¥è¯¢é€»è¾‘
}
```

---

## ä¿®å¤æ¸…å•

### Repository å±‚
- [x] `message.repository.ts` - æ·»åŠ  `findByIdAndOrg`
- [x] `tool.repository.ts` - æ·»åŠ  `findByIdAndOrg`
- [ ] `skill.repository.ts` - æ·»åŠ  `findByIdAndOrg`
- [ ] `agent.repository.ts` - åºŸå¼ƒ `findById`

### Service å±‚
- [ ] æ£€æŸ¥æ‰€æœ‰ `findById` è°ƒç”¨
- [ ] æ›¿æ¢ä¸º `findByIdAndOrg`
- [ ] æ·»åŠ  `org_id` éªŒè¯

### å®‰å…¨æ—¥å¿—
- [ ] æ‰€æœ‰ Repository æ·»åŠ å®‰å…¨è­¦å‘Šæ—¥å¿—
- [ ] ç¼ºå°‘ `org_id` æ—¶æ‰“å° WARN æ—¥å¿—

---

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
```typescript
describe('MessageRepository.findByIdAndOrg', () => {
  it('åº”è¯¥åªè¿”å›å±äºæŒ‡å®šç»„ç»‡çš„æ¶ˆæ¯', async () => {
    const message = await messageRepository.findByIdAndOrg(messageId, orgId)
    expect(message).toBeDefined()
    expect(message.session.org_id).toBe(orgId)
  })

  it('åº”è¯¥æ‹’ç»è®¿é—®å…¶ä»–ç»„ç»‡çš„æ¶ˆæ¯', async () => {
    const message = await messageRepository.findByIdAndOrg(messageId, otherOrgId)
    expect(message).toBeNull()
  })
})
```

### 2. é›†æˆæµ‹è¯•
```typescript
describe('å¤šç§Ÿæˆ·éš”ç¦»', () => {
  it('ç”¨æˆ·Aä¸èƒ½è®¿é—®ç”¨æˆ·Bçš„æ¶ˆæ¯', async () => {
    // åˆ›å»ºä¸¤ä¸ªç»„ç»‡çš„æ•°æ®
    const orgA = await createOrg('Org A')
    const orgB = await createOrg('Org B')

    const messageA = await createMessage(orgA.id)

    // å°è¯•ç”¨ orgB è®¿é—® orgA çš„æ¶ˆæ¯
    const result = await messageRepository.findByIdAndOrg(messageA.id, orgB.id)
    expect(result).toBeNull()
  })
})
```

### 3. æ‰‹åŠ¨æµ‹è¯•
```bash
# 1. åˆ›å»ºä¸¤ä¸ªç»„ç»‡çš„æµ‹è¯•æ•°æ®
# 2. å°è¯•è·¨ç»„ç»‡è®¿é—®
# 3. éªŒè¯è¿”å› 404 æˆ– null
```

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰ Repository éƒ½æœ‰ `findByIdAndOrg` æ–¹æ³•
- [ ] Service å±‚ä¸å†ç›´æ¥è°ƒç”¨ `findById`
- [ ] æ‰€æœ‰æŸ¥è¯¢éƒ½åŒ…å« `org_id` è¿‡æ»¤
- [ ] æ·»åŠ äº†å®‰å…¨è­¦å‘Šæ—¥å¿—
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [å®‰å…¨è§„èŒƒ - å¤šç§Ÿæˆ·éš”ç¦»](.claude/rules/security.md#å¤šç§Ÿæˆ·éš”ç¦»)
- [æ•°æ®æ¨¡å‹è®¾è®¡](docs/design/DATA_MODEL.md)
