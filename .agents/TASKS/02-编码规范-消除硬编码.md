# 任务：消除硬编码魔法数字

**优先级**: 🔴 P0 - 严重
**类型**: 编码规范
**预估工时**: 3-4 小时
**影响范围**: 30+ 个文件，约 100+ 处修改

---

## 问题描述

代码中存在大量硬编码的魔法数字和字符串，违反了编码规范。所有数值常量、超时时间、配置参数必须定义在 `src/constants/config.ts` 中。

---

## 主要违规位置

### 1. Redis 重试配置
**文件**: `apps/api/src/lib/redis.ts`

```typescript
// ❌ 错误 - 硬编码
maxRetriesPerRequest: 3,
if (times > 3) { ... }
const delay = Math.min(times * 200, 2000)

// ✅ 正确
import { REDIS_MAX_RETRIES, REDIS_RETRY_DELAY_BASE, REDIS_RETRY_DELAY_MAX } from '../constants/config'
maxRetriesPerRequest: REDIS_MAX_RETRIES,
if (times > REDIS_MAX_RETRIES) { ... }
const delay = Math.min(times * REDIS_RETRY_DELAY_BASE, REDIS_RETRY_DELAY_MAX)
```

### 2. 历史消息截断
**文件**: `apps/api/src/services/chat.service.ts`

```typescript
// ❌ 错误 - 硬编码 (3处)
if (historyMessages.length > 20) { ... }
history_messages: historyMessages.slice(-20)
...historyMessages.slice(-20)

// ✅ 正确
import { MAX_HISTORY_MESSAGES } from '../constants/config'
if (historyMessages.length > MAX_HISTORY_MESSAGES) { ... }
history_messages: historyMessages.slice(-MAX_HISTORY_MESSAGES)
```

### 3. Skill 相关限制
**文件**: `apps/api/src/services/skill.service.ts`

```typescript
// ❌ 错误 - 硬编码
.slice(0, 20)  // 关键词数量
.slice(0, 100) // 名称长度

// ✅ 正确
import { MAX_SKILL_KEYWORDS, MAX_SKILL_NAME_LENGTH } from '../constants/config'
.slice(0, MAX_SKILL_KEYWORDS)
.slice(0, MAX_SKILL_NAME_LENGTH)
```

### 4. API Key 前缀
**文件**: `apps/api/src/services/api-keys.service.ts`

```typescript
// ❌ 错误 - 硬编码 (2处)
const keyPrefix = key.slice(0, 10)
const searchPrefix = key.slice(0, 10)

// ✅ 正确
import { API_KEY_PREFIX_LENGTH } from '../constants/config'
const keyPrefix = key.slice(0, API_KEY_PREFIX_LENGTH)
```

### 5. Session 标题长度
**文件**: `apps/api/src/services/chat.service.ts`

```typescript
// ❌ 错误
title: input.message.slice(0, 50)

// ✅ 正确
import { MAX_SESSION_TITLE_LENGTH } from '../constants/config'
title: input.message.slice(0, MAX_SESSION_TITLE_LENGTH)
```

### 6. SSE 协议前缀
**文件**: 多个文件

```typescript
// ❌ 错误
const data = line.slice(6)  // "data: " 前缀
const event = line.slice(5) // "event:" 前缀

// ✅ 正确
import { SSE_EVENT_PREFIX_LENGTH, SSE_DATA_PREFIX_LENGTH } from '../constants/config'
const data = line.slice(SSE_DATA_PREFIX_LENGTH)
const event = line.slice(SSE_EVENT_PREFIX_LENGTH)
```

### 7. Zod 验证长度限制
**文件**: 多个路由文件

```typescript
// ❌ 错误
title: z.string().max(200)
avatarUrl: z.string().url().max(500)
endpoint: z.string().min(1).max(500)

// ✅ 正确
import { MAX_TITLE_LENGTH, MAX_URL_LENGTH, MAX_ENDPOINT_LENGTH } from '../constants/config'
title: z.string().max(MAX_TITLE_LENGTH)
avatarUrl: z.string().url().max(MAX_URL_LENGTH)
endpoint: z.string().min(1).max(MAX_ENDPOINT_LENGTH)
```

---

## 需要添加的常量

在 `apps/api/src/constants/config.ts` 中添加：

```typescript
// Redis 配置
export const REDIS_MAX_RETRIES = 3
export const REDIS_RETRY_DELAY_BASE = 200 // 毫秒
export const REDIS_RETRY_DELAY_MAX = 2000 // 毫秒

// 消息和会话
export const MAX_HISTORY_MESSAGES = 20
export const MAX_SESSION_TITLE_LENGTH = 50

// Skill 配置
export const MAX_SKILL_KEYWORDS = 20
export const MAX_SKILL_NAME_LENGTH = 100

// API Key
export const API_KEY_PREFIX_LENGTH = 10

// SSE 协议
export const SSE_DATA_PREFIX_LENGTH = 6  // "data: "
export const SSE_EVENT_PREFIX_LENGTH = 5 // "event:"

// 字段长度限制
export const MAX_TITLE_LENGTH = 200
export const MAX_URL_LENGTH = 500
export const MAX_ENDPOINT_LENGTH = 500
export const MAX_OAUTH_CLIENT_ID_LENGTH = 200
export const MAX_DESCRIPTION_LENGTH = 1000
export const MAX_SYSTEM_PROMPT_LENGTH = 10000
export const MAX_CONTENT_LENGTH = 100000
```

---

## 修复清单

### Phase 1: 添加常量定义
- [x] 在 `apps/api/src/constants/config.ts` 中添加所有常量 ✅
- [x] 添加注释说明每个常量的用途 ✅

### Phase 2: Services 层修复
- [x] `chat.service.ts` - 历史消息、标题长度 ✅
- [x] `skill.service.ts` - Skill 相关限制 ✅
- [x] `api-keys.service.ts` - API Key 前缀 ✅
- [x] `skill-retry-rollback.service.ts` - 重试配置 ✅

### Phase 3: Lib 层修复
- [x] `redis.ts` - Redis 重试配置 ✅

### Phase 4: Adapters 层修复
- [x] `runtime.adapter.ts` - SSE 协议前缀 ✅

### Phase 5: Routes 层修复
- [x] `sessions.ts` - Zod 验证长度 ✅
- [x] `users.ts` - Zod 验证长度 ✅
- [x] `mcp.ts` - Zod 验证长度 ✅
- [x] 其他路由文件 ✅

### Phase 6: Web 层修复
- [x] `apps/web/hooks/useSSE.ts` - SSE 协议前缀 ✅
- [x] `apps/web/lib/utils.ts` - 字符串截断 ✅

---

## 例外情况（可以使用字面量）

以下场景可以使用字面量，无需提取为常量：

1. **数组索引**: `arr[0]`, `arr[1]`
2. **数学运算**: `x * 2`, `y / 2`, `n + 1`
3. **布尔值**: `true`, `false`
4. **空值检查**: `=== 0`, `!== 0`, `> 0`
5. **CSS/样式值**
6. **测试数据**

---

## 验证方法

### 1. 代码检查
```bash
# 检查常见的硬编码模式
grep -rn "\.slice(0, [0-9]" apps/api/src --include="*.ts"
grep -rn "\.max([0-9]" apps/api/src --include="*.ts"
grep -rn "times \* [0-9]" apps/api/src --include="*.ts"
```

### 2. 运行测试
```bash
cd apps/api
pnpm test
```

### 3. 代码审查
- 确保所有常量都有清晰的命名
- 确保所有常量都有注释说明
- 确保常量值合理

---

## 注意事项

1. **常量命名规范**
   - 使用 UPPER_SNAKE_CASE
   - 名称要清晰表达用途
   - 添加单位注释（如毫秒、字节）

2. **常量分组**
   - 按功能模块分组
   - 添加分组注释
   - 保持逻辑顺序

3. **向后兼容**
   - 确保修改不影响现有功能
   - 运行完整测试套件
   - 检查边界条件

---

## 完成标准

- [ ] 所有硬编码值已提取为常量
- [ ] 常量定义在 `constants/config.ts` 中
- [ ] 所有常量都有注释说明
- [ ] 所有测试通过
- [ ] 代码审查通过

---

## 相关文档

- [编码规范 - 禁止硬编码](.claude/rules/coding-standards.md#禁止硬编码值和魔法数字)
- [常量配置文件](apps/api/src/constants/config.ts)
