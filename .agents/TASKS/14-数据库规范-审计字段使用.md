# ä»»åŠ¡ï¼šè¡¥å……å®¡è®¡å­—æ®µä½¿ç”¨

**ä¼˜å…ˆçº§**: ğŸŸ¡ P1 - é«˜ä¼˜å…ˆçº§
**ç±»å‹**: æ•°æ®åº“è§„èŒƒ
**é¢„ä¼°å·¥æ—¶**: 2-3 å°æ—¶
**å½±å“èŒƒå›´**: å¤šä¸ª Repository å’Œ Service

---

## é—®é¢˜æè¿°

è™½ç„¶æ•°æ®åº“è¿ç§»è„šæœ¬å·²æ·»åŠ å®¡è®¡å­—æ®µï¼ˆ`created_by`, `updated_by`, `deleted_by`ï¼‰ï¼Œä½† Repository å±‚åªä½¿ç”¨äº† `created_by`ï¼Œæ›´æ–°å’Œåˆ é™¤æ“ä½œæœªè®°å½•æ“ä½œäººã€‚

---

## è§„èŒƒè¦æ±‚

æ ¹æ® `.claude/rules/database.md`:

**æ ¸å¿ƒè¡¨å¿…é¡»åŒ…å«å®¡è®¡å­—æ®µ**ï¼š
```sql
created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
created_by UUID NOT NULL
updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
updated_by UUID NULL
```

---

## å½“å‰å®ç°

### âœ… åˆ›å»ºæ—¶è®°å½•ï¼ˆå·²å®ç°ï¼‰
```typescript
// skill.repository.ts:99
INSERT INTO skills (..., created_by) VALUES (..., ${data.createdBy ?? null})
```

### âŒ æ›´æ–°æ—¶æœªè®°å½•
```typescript
// agent.repository.ts:292
UPDATE agents SET name = ${data.name}, updated_at = NOW()
WHERE id = ${id} AND org_id = ${orgId}
// âŒ ç¼ºå°‘ updated_by
```

### âŒ è½¯åˆ é™¤æœªè®°å½•
```typescript
// agent.repository.ts:348
UPDATE agents SET is_active = false, updated_at = NOW()
WHERE id = ${id} AND org_id = ${orgId}
// âŒ ç¼ºå°‘ deleted_by
```

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. Repository å±‚ä¿®å¤

#### 1.1 Update æ–¹æ³•æ·»åŠ  updatedBy å‚æ•°

```typescript
// âŒ ä¿®æ”¹å‰
export async function update(
  id: string,
  orgId: string,
  data: UpdateAgentData
): Promise<AgentRow | null> {
  const result = await sql`
    UPDATE agents
    SET name = ${data.name},
        updated_at = NOW()
    WHERE id = ${id} AND org_id = ${orgId}
    RETURNING *
  `
  return result[0] || null
}

// âœ… ä¿®æ”¹å
export async function update(
  id: string,
  orgId: string,
  data: UpdateAgentData,
  updatedBy: string  // âœ… æ·»åŠ å‚æ•°
): Promise<AgentRow | null> {
  const result = await sql`
    UPDATE agents
    SET name = ${data.name},
        updated_at = NOW(),
        updated_by = ${updatedBy}  // âœ… è®°å½•æ“ä½œäºº
    WHERE id = ${id} AND org_id = ${orgId}
    RETURNING *
  `
  return result[0] || null
}
```

#### 1.2 SoftDelete æ–¹æ³•æ·»åŠ  deletedBy å‚æ•°

```typescript
// âŒ ä¿®æ”¹å‰
export async function softDelete(
  id: string,
  orgId: string
): Promise<boolean> {
  const result = await sql`
    UPDATE agents
    SET is_active = false,
        updated_at = NOW()
    WHERE id = ${id} AND org_id = ${orgId}
    RETURNING id
  `
  return result.length > 0
}

// âœ… ä¿®æ”¹å
export async function softDelete(
  id: string,
  orgId: string,
  deletedBy: string  // âœ… æ·»åŠ å‚æ•°
): Promise<boolean> {
  const result = await sql`
    UPDATE agents
    SET deleted_at = NOW(),
        deleted_by = ${deletedBy},  // âœ… è®°å½•åˆ é™¤äºº
        updated_at = NOW(),
        updated_by = ${deletedBy}   // âœ… åŒæ—¶æ›´æ–° updated_by
    WHERE id = ${id} AND org_id = ${orgId}
    RETURNING id
  `
  return result.length > 0
}
```

### 2. Service å±‚ä¿®å¤

#### 2.1 ä¼ å…¥ userId

```typescript
// âŒ ä¿®æ”¹å‰
export async function updateAgent(
  agentId: string,
  orgId: string,
  data: UpdateAgentInput
): Promise<Agent> {
  const updated = await agentRepository.update(agentId, orgId, data)
  // ...
}

// âœ… ä¿®æ”¹å
export async function updateAgent(
  agentId: string,
  orgId: string,
  userId: string,  // âœ… æ·»åŠ å‚æ•°
  data: UpdateAgentInput
): Promise<Agent> {
  const updated = await agentRepository.update(agentId, orgId, data, userId)  // âœ… ä¼ å…¥ userId
  // ...
}
```

#### 2.2 ä»è®¤è¯ä¸Šä¸‹æ–‡è·å– userId

```typescript
// routes/v1/agents.ts

router.put(
  '/:id',
  authenticate,
  validate(updateAgentSchema, 'body'),
  asyncHandler(async (req: AuthRequest, res) => {
    const { id } = req.params
    const { orgId, userId } = req.auth!  // âœ… ä»è®¤è¯ä¸Šä¸‹æ–‡è·å–

    const agent = await agentService.updateAgent(
      id,
      orgId,
      userId,  // âœ… ä¼ å…¥ userId
      req.body
    )

    res.json({
      success: true,
      data: agent
    })
  })
)
```

---

## éœ€è¦ä¿®å¤çš„ Repository

### 1. Agent Repository
- [ ] `update` æ–¹æ³•æ·»åŠ  `updatedBy`
- [ ] `softDelete` æ–¹æ³•æ·»åŠ  `deletedBy`

### 2. Skill Repository
- [ ] `update` æ–¹æ³•æ·»åŠ  `updatedBy`
- [ ] `softDelete` æ–¹æ³•æ·»åŠ  `deletedBy`

### 3. Tool Repository
- [ ] `update` æ–¹æ³•æ·»åŠ  `updatedBy`
- [ ] `softDelete` æ–¹æ³•æ·»åŠ  `deletedBy`

### 4. MCP Repository
- [ ] `update` æ–¹æ³•æ·»åŠ  `updatedBy`
- [ ] `softDelete` æ–¹æ³•æ·»åŠ  `deletedBy`

### 5. Session Repository
- [ ] `updateTitle` æ–¹æ³•æ·»åŠ  `updatedBy`
- [ ] `updateStatus` æ–¹æ³•æ·»åŠ  `updatedBy`
- [ ] `softDelete` æ–¹æ³•æ·»åŠ  `deletedBy`

### 6. Memory Repository
- [ ] `update` æ–¹æ³•æ·»åŠ  `updatedBy`
- [ ] `softDelete` æ–¹æ³•æ·»åŠ  `deletedBy`

---

## å®Œæ•´ç¤ºä¾‹

### Repository å±‚
```typescript
// apps/api/src/repositories/agent.repository.ts

export async function update(
  id: string,
  orgId: string,
  data: UpdateAgentData,
  updatedBy: string
): Promise<AgentRow | null> {
  // æ„å»ºåŠ¨æ€æ›´æ–°å­—æ®µ
  const updates: string[] = []
  const values: unknown[] = []

  if (data.name !== undefined) {
    updates.push(`name = $${values.length + 1}`)
    values.push(data.name)
  }

  if (data.description !== undefined) {
    updates.push(`description = $${values.length + 1}`)
    values.push(data.description)
  }

  // ... å…¶ä»–å­—æ®µ

  // å§‹ç»ˆæ›´æ–°å®¡è®¡å­—æ®µ
  updates.push(`updated_at = NOW()`)
  updates.push(`updated_by = $${values.length + 1}`)
  values.push(updatedBy)

  updates.push(`version = version + 1`)

  const result = await sql`
    UPDATE agents
    SET ${sql.raw(updates.join(', '))}
    WHERE id = ${id} AND org_id = ${orgId}
    RETURNING *
  `

  return result[0] || null
}

export async function softDelete(
  id: string,
  orgId: string,
  deletedBy: string
): Promise<boolean> {
  const result = await sql`
    UPDATE agents
    SET deleted_at = NOW(),
        deleted_by = ${deletedBy},
        updated_at = NOW(),
        updated_by = ${deletedBy}
    WHERE id = ${id} AND org_id = ${orgId}
    RETURNING id
  `

  return result.length > 0
}
```

### Service å±‚
```typescript
// apps/api/src/services/agent.service.ts

export async function updateAgent(
  agentId: string,
  orgId: string,
  userId: string,
  data: UpdateAgentInput
): Promise<Agent> {
  // éªŒè¯ Agent å­˜åœ¨
  const existing = await agentRepository.findByIdAndOrg(agentId, orgId)
  if (!existing) {
    throw createError(AGENT_NOT_FOUND)
  }

  // æ›´æ–° Agent
  const updated = await agentRepository.update(agentId, orgId, data, userId)
  if (!updated) {
    throw createError(AGENT_NOT_FOUND)
  }

  logger.info('[AgentService] Agent å·²æ›´æ–°', {
    agentId,
    orgId,
    userId,
    changes: Object.keys(data)
  })

  return rowToAgent(updated)
}

export async function deleteAgent(
  agentId: string,
  orgId: string,
  userId: string
): Promise<void> {
  const success = await agentRepository.softDelete(agentId, orgId, userId)

  if (!success) {
    throw createError(AGENT_NOT_FOUND)
  }

  logger.info('[AgentService] Agent å·²åˆ é™¤', {
    agentId,
    orgId,
    userId
  })
}
```

### Route å±‚
```typescript
// apps/api/src/routes/v1/agents.ts

router.put(
  '/:id',
  authenticate,
  validate(updateAgentSchema, 'body'),
  asyncHandler(async (req: AuthRequest, res) => {
    const { id } = req.params
    const { orgId, userId } = req.auth!

    const agent = await agentService.updateAgent(id, orgId, userId, req.body)

    res.json({
      success: true,
      data: agent
    })
  })
)

router.delete(
  '/:id',
  authenticate,
  asyncHandler(async (req: AuthRequest, res) => {
    const { id } = req.params
    const { orgId, userId } = req.auth!

    await agentService.deleteAgent(id, orgId, userId)

    res.status(204).send()
  })
)
```

---

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
```typescript
describe('å®¡è®¡å­—æ®µæµ‹è¯•', () => {
  it('æ›´æ–°æ—¶åº”è¯¥è®°å½• updated_by', async () => {
    const agent = await agentRepository.create(data, userId1)

    await agentRepository.update(agent.id, orgId, { name: 'New Name' }, userId2)

    const updated = await agentRepository.findById(agent.id)
    expect(updated.updated_by).toBe(userId2)
    expect(updated.created_by).toBe(userId1)  // åˆ›å»ºäººä¸å˜
  })

  it('è½¯åˆ é™¤æ—¶åº”è¯¥è®°å½• deleted_by', async () => {
    const agent = await agentRepository.create(data, userId1)

    await agentRepository.softDelete(agent.id, orgId, userId2)

    // ç›´æ¥æŸ¥è¯¢æ•°æ®åº“éªŒè¯
    const result = await sql`
      SELECT deleted_by, updated_by
      FROM agents
      WHERE id = ${agent.id}
    `

    expect(result[0].deleted_by).toBe(userId2)
    expect(result[0].updated_by).toBe(userId2)
  })
})
```

### 2. å®¡è®¡æŸ¥è¯¢
```sql
-- æŸ¥è¯¢æŸä¸ªèµ„æºçš„å®Œæ•´å®¡è®¡å†å²
SELECT
  id,
  name,
  created_by,
  created_at,
  updated_by,
  updated_at,
  deleted_by,
  deleted_at
FROM agents
WHERE id = 'xxx';

-- æŸ¥è¯¢æŸç”¨æˆ·çš„æ‰€æœ‰æ“ä½œ
SELECT
  'created' as action,
  id,
  name,
  created_at as action_time
FROM agents
WHERE created_by = 'user-id'

UNION ALL

SELECT
  'updated' as action,
  id,
  name,
  updated_at as action_time
FROM agents
WHERE updated_by = 'user-id'

UNION ALL

SELECT
  'deleted' as action,
  id,
  name,
  deleted_at as action_time
FROM agents
WHERE deleted_by = 'user-id'

ORDER BY action_time DESC;
```

---

## ä¿®å¤æ¸…å•

### Repository å±‚ï¼ˆ6 ä¸ªï¼‰
- [ ] `agent.repository.ts`
- [ ] `skill.repository.ts`
- [ ] `tool.repository.ts`
- [ ] `mcp.repository.ts`
- [ ] `session.repository.ts`
- [ ] `memory.repository.ts`

### Service å±‚ï¼ˆ6 ä¸ªï¼‰
- [ ] `agent.service.ts`
- [ ] `skill.service.ts`
- [ ] `tool.service.ts`
- [ ] `mcp.service.ts`
- [ ] `session.service.ts`
- [ ] `memory.service.ts`

### Route å±‚ï¼ˆ6 ä¸ªï¼‰
- [ ] `agents.ts`
- [ ] `skills.ts`
- [ ] `tools.ts`
- [ ] `mcp.ts`
- [ ] `sessions.ts`
- [ ] `memory.ts`

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰ update æ–¹æ³•è®°å½• `updated_by`
- [ ] æ‰€æœ‰ softDelete æ–¹æ³•è®°å½• `deleted_by`
- [ ] Service å±‚ä¼ å…¥ `userId`
- [ ] Route å±‚ä»è®¤è¯ä¸Šä¸‹æ–‡è·å– `userId`
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] å®¡è®¡æŸ¥è¯¢éªŒè¯é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è§„èŒƒ - å®¡è®¡å­—æ®µ](.claude/rules/database.md#å®¡è®¡å­—æ®µ)
- [è¿ç§»è„šæœ¬](database/migrations/007_add_soft_delete_and_audit.sql)
