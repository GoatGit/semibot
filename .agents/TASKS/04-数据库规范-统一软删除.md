# ä»»åŠ¡ï¼šç»Ÿä¸€è½¯åˆ é™¤å®ç°

**ä¼˜å…ˆçº§**: ğŸ”´ P0 - ä¸¥é‡
**ç±»å‹**: æ•°æ®åº“è§„èŒƒ
**é¢„ä¼°å·¥æ—¶**: 2-3 å°æ—¶
**å½±å“èŒƒå›´**: 6 ä¸ª Repository

---

## é—®é¢˜æè¿°

è™½ç„¶æ•°æ®åº“è¿ç§»è„šæœ¬å·²ä¸ºæ ¸å¿ƒè¡¨æ·»åŠ äº† `deleted_at` å’Œ `deleted_by` å­—æ®µï¼Œä½† Repository å±‚çš„æŸ¥è¯¢æœªå…¨é¢è¿‡æ»¤å·²åˆ é™¤è®°å½•ï¼Œå¯¼è‡´å·²åˆ é™¤æ•°æ®ä»å¯è¢«æŸ¥è¯¢åˆ°ã€‚

---

## è§„èŒƒè¦æ±‚

æ ¹æ® `.claude/rules/database.md`:

```sql
-- å¿…éœ€å­—æ®µ
deleted_at TIMESTAMP NULL DEFAULT NULL
deleted_by UUID NULL

-- æŸ¥è¯¢è§„èŒƒ
SELECT * FROM users WHERE deleted_at IS NULL

-- è½¯åˆ é™¤æ“ä½œ
UPDATE users SET deleted_at = NOW(), deleted_by = $1 WHERE id = $2
```

---

## é—®é¢˜è¯¦æƒ…

### âœ… æ­£ç¡®å®ç°ï¼ˆå‚è€ƒï¼‰
**æ–‡ä»¶**: `apps/api/src/repositories/skill.repository.ts:123`

```typescript
// âœ… æ­£ç¡® - è¿‡æ»¤ deleted_at
const result = await sql`
  SELECT * FROM skills
  WHERE id = ${id} AND deleted_at IS NULL
`
```

### âŒ ç¼ºå¤±è¿‡æ»¤çš„ Repository

#### 1. Agent Repository
**æ–‡ä»¶**: `apps/api/src/repositories/agent.repository.ts:104`

```typescript
// âŒ é”™è¯¯ - æœªè¿‡æ»¤ deleted_at
export async function findById(id: string): Promise<AgentRow | null> {
  const result = await sql`SELECT * FROM agents WHERE id = ${id}`
  return result[0] || null
}

// âœ… ä¿®å¤
export async function findById(id: string): Promise<AgentRow | null> {
  const result = await sql`
    SELECT * FROM agents
    WHERE id = ${id} AND deleted_at IS NULL
  `
  return result[0] || null
}
```

#### 2. Tool Repository
**æ–‡ä»¶**: `apps/api/src/repositories/tool.repository.ts:102`

```typescript
// âŒ é”™è¯¯ - æœªè¿‡æ»¤ deleted_at
export async function findById(id: string): Promise<ToolRow | null> {
  const result = await sql`SELECT * FROM tools WHERE id = ${id}`
  return result[0] || null
}

// âœ… ä¿®å¤
export async function findById(id: string): Promise<ToolRow | null> {
  const result = await sql`
    SELECT * FROM tools
    WHERE id = ${id} AND deleted_at IS NULL
  `
  return result[0] || null
}
```

#### 3. MCP Repository
**æ–‡ä»¶**: `apps/api/src/repositories/mcp.repository.ts`

```typescript
// âŒ é”™è¯¯ - æœªè¿‡æ»¤ deleted_at
export async function findById(id: string): Promise<McpServerRow | null> {
  const result = await sql`SELECT * FROM mcp_servers WHERE id = ${id}`
  return result[0] || null
}

// âœ… ä¿®å¤
export async function findById(id: string): Promise<McpServerRow | null> {
  const result = await sql`
    SELECT * FROM mcp_servers
    WHERE id = ${id} AND deleted_at IS NULL
  `
  return result[0] || null
}
```

#### 4. Memory Collection Repository
**æ–‡ä»¶**: `apps/api/src/repositories/memory.repository.ts`

éœ€è¦æ£€æŸ¥æ‰€æœ‰æŸ¥è¯¢æ˜¯å¦è¿‡æ»¤ `deleted_at`ã€‚

#### 5. API Keys Repository
**æ–‡ä»¶**: `apps/api/src/repositories/api-keys.repository.ts`

éœ€è¦æ£€æŸ¥æ‰€æœ‰æŸ¥è¯¢æ˜¯å¦è¿‡æ»¤ `deleted_at`ã€‚

---

## ä¿®å¤æ­¥éª¤

### Phase 1: æ£€æŸ¥æ•°æ®åº“å­—æ®µ
```sql
-- ç¡®è®¤å“ªäº›è¡¨æœ‰ deleted_at å­—æ®µ
SELECT table_name, column_name
FROM information_schema.columns
WHERE column_name = 'deleted_at'
AND table_schema = 'public';
```

æ ¹æ®è¿ç§»è„šæœ¬ `007_add_soft_delete_and_audit.sql`ï¼Œä»¥ä¸‹è¡¨æœ‰ `deleted_at`:
- organizations
- users
- agents
- skills
- tools
- mcp_servers
- memory_collections
- memory_documents
- api_keys

### Phase 2: Repository å±‚ä¿®å¤

#### 2.1 ä¿®å¤æ‰€æœ‰ findById æ–¹æ³•
```typescript
// æ¨¡æ¿
export async function findById(id: string): Promise<Row | null> {
  const result = await sql`
    SELECT * FROM table_name
    WHERE id = ${id} AND deleted_at IS NULL
  `
  return result[0] || null
}
```

#### 2.2 ä¿®å¤æ‰€æœ‰ findAll/list æ–¹æ³•
```typescript
// æ¨¡æ¿
export async function findAll(params: ListParams): Promise<PaginatedResult<Row>> {
  const { orgId, page, limit } = params

  const result = await sql`
    SELECT * FROM table_name
    WHERE org_id = ${orgId}
    AND deleted_at IS NULL  -- âœ… æ·»åŠ æ­¤è¡Œ
    ORDER BY created_at DESC
    LIMIT ${limit} OFFSET ${(page - 1) * limit}
  `

  return {
    data: result,
    meta: { ... }
  }
}
```

#### 2.3 ä¿®å¤æ‰€æœ‰ search æ–¹æ³•
```typescript
// æ¨¡æ¿
export async function search(params: SearchParams): Promise<Row[]> {
  const { orgId, keyword } = params

  const result = await sql`
    SELECT * FROM table_name
    WHERE org_id = ${orgId}
    AND name ILIKE ${`%${keyword}%`}
    AND deleted_at IS NULL  -- âœ… æ·»åŠ æ­¤è¡Œ
  `

  return result
}
```

### Phase 3: ç»Ÿä¸€è½¯åˆ é™¤æ–¹æ³•

ç§»é™¤ `skill.repository.ts` ä¸­çš„åŠ¨æ€æ£€æŸ¥é€»è¾‘ï¼š

```typescript
// âŒ ç§»é™¤åŠ¨æ€æ£€æŸ¥
const useDeletedAt = await hasSkillsDeletedAtColumn()
const result = useDeletedAt
  ? await sql`... AND deleted_at IS NULL`
  : await sql`...`

// âœ… ç»Ÿä¸€å®ç°ï¼ˆå‡è®¾è¿ç§»å·²å®Œæˆï¼‰
const result = await sql`... AND deleted_at IS NULL`
```

---

## ä¿®å¤æ¸…å•

### Repository å±‚ä¿®å¤
- [ ] `agent.repository.ts`
  - [ ] findById
  - [ ] findByOrg
  - [ ] findAll
  - [ ] search
- [ ] `tool.repository.ts`
  - [ ] findById
  - [ ] findAll
  - [ ] search
- [ ] `mcp.repository.ts`
  - [ ] findById
  - [ ] findByOrg
  - [ ] findAll
- [ ] `memory.repository.ts`
  - [ ] findById
  - [ ] findAll
  - [ ] search
- [ ] `api-keys.repository.ts`
  - [ ] findById
  - [ ] findByOrg
- [ ] `skill.repository.ts`
  - [ ] ç§»é™¤åŠ¨æ€æ£€æŸ¥é€»è¾‘
  - [ ] ç»Ÿä¸€ä½¿ç”¨ deleted_at

### éªŒè¯
- [ ] æ‰€æœ‰æŸ¥è¯¢éƒ½åŒ…å« `deleted_at IS NULL`
- [ ] è½¯åˆ é™¤æ“ä½œè®¾ç½® `deleted_at = NOW()`
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡

---

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
```typescript
describe('è½¯åˆ é™¤åŠŸèƒ½', () => {
  it('findById åº”è¯¥ä¸è¿”å›å·²åˆ é™¤çš„è®°å½•', async () => {
    // åˆ›å»ºè®°å½•
    const agent = await agentRepository.create(data)

    // è½¯åˆ é™¤
    await agentRepository.softDelete(agent.id, orgId)

    // æŸ¥è¯¢åº”è¯¥è¿”å› null
    const result = await agentRepository.findById(agent.id)
    expect(result).toBeNull()
  })

  it('findAll åº”è¯¥ä¸åŒ…å«å·²åˆ é™¤çš„è®°å½•', async () => {
    // åˆ›å»ºä¸¤ä¸ªè®°å½•
    const agent1 = await agentRepository.create(data1)
    const agent2 = await agentRepository.create(data2)

    // è½¯åˆ é™¤ä¸€ä¸ª
    await agentRepository.softDelete(agent1.id, orgId)

    // æŸ¥è¯¢åº”è¯¥åªè¿”å›æœªåˆ é™¤çš„
    const result = await agentRepository.findAll({ orgId })
    expect(result.data).toHaveLength(1)
    expect(result.data[0].id).toBe(agent2.id)
  })
})
```

### 2. æ•°æ®åº“éªŒè¯
```sql
-- éªŒè¯è½¯åˆ é™¤è®°å½•å­˜åœ¨ä½†ä¸å¯æŸ¥è¯¢
SELECT id, name, deleted_at
FROM agents
WHERE deleted_at IS NOT NULL;

-- éªŒè¯åº”ç”¨å±‚æŸ¥è¯¢ä¸è¿”å›å·²åˆ é™¤è®°å½•
-- é€šè¿‡ API æµ‹è¯•
```

---

## æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**
   - ç¡®ä¿æ‰€æœ‰è¡¨éƒ½å·²è¿è¡Œè¿ç§»è„šæœ¬
   - å¦‚æœæœ‰è¡¨æœªè¿ç§»ï¼Œéœ€è¦å…ˆè¿è¡Œè¿ç§»

2. **æ€§èƒ½è€ƒè™‘**
   - ä¸º `deleted_at` å­—æ®µæ·»åŠ ç´¢å¼•ï¼ˆå¦‚æœæœªæ·»åŠ ï¼‰
   - è€ƒè™‘å®šæœŸæ¸…ç†æ—§çš„è½¯åˆ é™¤è®°å½•

3. **å®¡è®¡è¦æ±‚**
   - è½¯åˆ é™¤æ—¶è®°å½• `deleted_by`
   - ä¿ç•™åˆ é™¤è®°å½•ç”¨äºå®¡è®¡

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰ Repository çš„æŸ¥è¯¢éƒ½è¿‡æ»¤ `deleted_at IS NULL`
- [ ] ç§»é™¤åŠ¨æ€æ£€æŸ¥é€»è¾‘
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] æ–‡æ¡£å·²æ›´æ–°

---

## ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“è§„èŒƒ - è½¯åˆ é™¤](.claude/rules/database.md#è½¯åˆ é™¤)
- [è¿ç§»è„šæœ¬](database/migrations/007_add_soft_delete_and_audit.sql)
