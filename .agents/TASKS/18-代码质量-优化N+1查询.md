# ä»»åŠ¡ï¼šä¼˜åŒ– N+1 æŸ¥è¯¢

**ä¼˜å…ˆçº§**: ğŸŸ¡ P1 - é«˜ä¼˜å…ˆçº§
**ç±»å‹**: ä»£ç è´¨é‡
**é¢„ä¼°å·¥æ—¶**: 2-3 å°æ—¶
**å½±å“èŒƒå›´**: å¤šä¸ª Service å’Œ Repository

---

## é—®é¢˜æè¿°

`getActiveSkillsByIds` ä½¿ç”¨å¾ªç¯æŸ¥è¯¢ï¼Œå­˜åœ¨ N+1 æŸ¥è¯¢é—®é¢˜ã€‚å¦‚æœ `skillIds` æœ‰ 10 ä¸ªï¼Œä¼šæ‰§è¡Œ 10 æ¬¡æ•°æ®åº“æŸ¥è¯¢ã€‚

---

## è¿è§„ä½ç½®

**æ–‡ä»¶**: `apps/api/src/services/skill.service.ts:583-598`

```typescript
// âŒ N+1 æŸ¥è¯¢é—®é¢˜
export async function getActiveSkillsByIds(orgId: string, skillIds: string[]): Promise<Skill[]> {
  const uniqueSkillIds = Array.from(new Set(skillIds.filter(Boolean)))
  if (uniqueSkillIds.length === 0) {
    return []
  }

  // å¾ªç¯æŸ¥è¯¢ - æ¯ä¸ª ID ä¸€æ¬¡æŸ¥è¯¢
  const rows = await Promise.all(
    uniqueSkillIds.map((skillId) => skillRepository.findById(skillId))
  )

  return rows
    .filter((row): row is skillRepository.SkillRow => {
      if (!row) return false
      if (!row.is_active) return false
      return row.org_id === orgId || row.is_builtin
    })
    .map(rowToSkill)
}
```

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. Repository å±‚æ·»åŠ æ‰¹é‡æŸ¥è¯¢æ–¹æ³•

```typescript
// apps/api/src/repositories/skill.repository.ts

/**
 * æ‰¹é‡æŸ¥è¯¢ Skill
 * @param ids Skill ID æ•°ç»„
 * @returns Skill æ•°ç»„ï¼ˆä¿æŒåŸé¡ºåºï¼‰
 */
export async function findByIds(ids: string[]): Promise<SkillRow[]> {
  if (ids.length === 0) {
    return []
  }

  const result = await sql`
    SELECT * FROM skills
    WHERE id = ANY(${ids})
    AND deleted_at IS NULL
  `

  return result as unknown as SkillRow[]
}

/**
 * æ‰¹é‡æŸ¥è¯¢æŒ‡å®šç»„ç»‡çš„æ´»è·ƒ Skillï¼ˆåŒ…æ‹¬å†…ç½®ï¼‰
 * @param ids Skill ID æ•°ç»„
 * @param orgId ç»„ç»‡ ID
 * @returns æ´»è·ƒçš„ Skill æ•°ç»„
 */
export async function findActiveByIdsAndOrg(
  ids: string[],
  orgId: string
): Promise<SkillRow[]> {
  if (ids.length === 0) {
    return []
  }

  const result = await sql`
    SELECT * FROM skills
    WHERE id = ANY(${ids})
    AND is_active = true
    AND (org_id = ${orgId} OR is_builtin = true)
    AND deleted_at IS NULL
  `

  return result as unknown as SkillRow[]
}
```

### 2. Service å±‚ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢

```typescript
// apps/api/src/services/skill.service.ts

// âœ… ä¿®å¤å - å•æ¬¡æŸ¥è¯¢
export async function getActiveSkillsByIds(orgId: string, skillIds: string[]): Promise<Skill[]> {
  const uniqueSkillIds = Array.from(new Set(skillIds.filter(Boolean)))
  if (uniqueSkillIds.length === 0) {
    return []
  }

  // å•æ¬¡æ‰¹é‡æŸ¥è¯¢
  const rows = await skillRepository.findActiveByIdsAndOrg(uniqueSkillIds, orgId)

  return rows.map(rowToSkill)
}
```

---

## å…¶ä»–æ½œåœ¨çš„ N+1 é—®é¢˜

### 1. Agent å…³è”æŸ¥è¯¢
```typescript
// æ£€æŸ¥ Agent å…³è”çš„ Skills å’Œ Tools
// å¦‚æœå­˜åœ¨ç±»ä¼¼çš„å¾ªç¯æŸ¥è¯¢ï¼Œéœ€è¦ä¿®å¤
```

### 2. Session æ¶ˆæ¯æŸ¥è¯¢
```typescript
// æ£€æŸ¥è·å– Session åˆ—è¡¨æ—¶æ˜¯å¦å¾ªç¯è·å–æ¶ˆæ¯æ•°é‡
```

### 3. Memory æ‰¹é‡æ“ä½œ
```typescript
// æ£€æŸ¥ Memory çš„æ‰¹é‡æ“ä½œ
```

---

## æ‰¹é‡æŸ¥è¯¢æ¨¡æ¿

### PostgreSQL ANY æŸ¥è¯¢
```typescript
// ä½¿ç”¨ ANY è¿›è¡Œæ‰¹é‡ ID æŸ¥è¯¢
export async function findByIds(ids: string[]): Promise<Row[]> {
  if (ids.length === 0) return []

  return await sql`
    SELECT * FROM table_name
    WHERE id = ANY(${ids})
    AND deleted_at IS NULL
  `
}
```

### ä¿æŒé¡ºåºçš„æ‰¹é‡æŸ¥è¯¢
```typescript
// å¦‚æœéœ€è¦ä¿æŒè¾“å…¥é¡ºåº
export async function findByIdsOrdered(ids: string[]): Promise<Row[]> {
  if (ids.length === 0) return []

  const rows = await sql`
    SELECT * FROM table_name
    WHERE id = ANY(${ids})
    AND deleted_at IS NULL
  `

  // æŒ‰è¾“å…¥é¡ºåºæ’åº
  const rowMap = new Map(rows.map(r => [r.id, r]))
  return ids.map(id => rowMap.get(id)).filter(Boolean)
}
```

### å¸¦åˆ†é¡µçš„æ‰¹é‡æŸ¥è¯¢
```typescript
// å¤§é‡ ID æ—¶åˆ†æ‰¹æŸ¥è¯¢
export async function findByIdsBatched(
  ids: string[],
  batchSize = 100
): Promise<Row[]> {
  if (ids.length === 0) return []

  const results: Row[] = []
  for (let i = 0; i < ids.length; i += batchSize) {
    const batch = ids.slice(i, i + batchSize)
    const rows = await sql`
      SELECT * FROM table_name
      WHERE id = ANY(${batch})
      AND deleted_at IS NULL
    `
    results.push(...rows)
  }

  return results
}
```

---

## æµ‹è¯•éªŒè¯

### 1. æ€§èƒ½æµ‹è¯•
```typescript
describe('N+1 æŸ¥è¯¢ä¼˜åŒ–', () => {
  it('æ‰¹é‡æŸ¥è¯¢åº”è¯¥åªæ‰§è¡Œä¸€æ¬¡ SQL', async () => {
    const sqlSpy = jest.spyOn(sql, 'query')

    const skillIds = Array(10).fill(null).map(() => uuid())
    // åˆ›å»ºæµ‹è¯•æ•°æ®
    for (const id of skillIds) {
      await skillRepository.create({ id, orgId, name: `Skill ${id}` })
    }

    // æ‰§è¡Œæ‰¹é‡æŸ¥è¯¢
    await skillService.getActiveSkillsByIds(orgId, skillIds)

    // åº”è¯¥åªæœ‰ä¸€æ¬¡æŸ¥è¯¢ï¼ˆä¸æ˜¯ 10 æ¬¡ï¼‰
    expect(sqlSpy).toHaveBeenCalledTimes(1)
  })

  it('æ‰¹é‡æŸ¥è¯¢æ€§èƒ½åº”è¯¥ä¼˜äºå¾ªç¯æŸ¥è¯¢', async () => {
    const skillIds = Array(100).fill(null).map(() => uuid())
    // åˆ›å»ºæµ‹è¯•æ•°æ®...

    const start = Date.now()
    await skillService.getActiveSkillsByIds(orgId, skillIds)
    const duration = Date.now() - start

    // æ‰¹é‡æŸ¥è¯¢åº”è¯¥åœ¨ 100ms å†…å®Œæˆ
    expect(duration).toBeLessThan(100)
  })
})
```

### 2. æ­£ç¡®æ€§æµ‹è¯•
```typescript
describe('æ‰¹é‡æŸ¥è¯¢æ­£ç¡®æ€§', () => {
  it('åº”è¯¥åªè¿”å›æ´»è·ƒçš„ Skill', async () => {
    const activeSkill = await createSkill({ isActive: true })
    const inactiveSkill = await createSkill({ isActive: false })

    const result = await skillService.getActiveSkillsByIds(
      orgId,
      [activeSkill.id, inactiveSkill.id]
    )

    expect(result).toHaveLength(1)
    expect(result[0].id).toBe(activeSkill.id)
  })

  it('åº”è¯¥åªè¿”å›æœ¬ç»„ç»‡æˆ–å†…ç½®çš„ Skill', async () => {
    const ownSkill = await createSkill({ orgId })
    const builtinSkill = await createSkill({ isBuiltin: true })
    const otherOrgSkill = await createSkill({ orgId: otherOrgId })

    const result = await skillService.getActiveSkillsByIds(
      orgId,
      [ownSkill.id, builtinSkill.id, otherOrgSkill.id]
    )

    expect(result).toHaveLength(2)
    expect(result.map(s => s.id)).toContain(ownSkill.id)
    expect(result.map(s => s.id)).toContain(builtinSkill.id)
    expect(result.map(s => s.id)).not.toContain(otherOrgSkill.id)
  })
})
```

---

## ä¿®å¤æ¸…å•

### Repository å±‚
- [ ] `skill.repository.ts` - æ·»åŠ  `findByIds`
- [ ] `skill.repository.ts` - æ·»åŠ  `findActiveByIdsAndOrg`
- [ ] `agent.repository.ts` - æ£€æŸ¥å¹¶æ·»åŠ æ‰¹é‡æŸ¥è¯¢ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] `tool.repository.ts` - æ£€æŸ¥å¹¶æ·»åŠ æ‰¹é‡æŸ¥è¯¢ï¼ˆå¦‚éœ€è¦ï¼‰

### Service å±‚
- [ ] `skill.service.ts` - ä¿®æ”¹ `getActiveSkillsByIds`
- [ ] æ£€æŸ¥å…¶ä»–å¯èƒ½çš„ N+1 é—®é¢˜

### æµ‹è¯•
- [ ] æ·»åŠ æ‰¹é‡æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
- [ ] æ·»åŠ æ‰¹é‡æŸ¥è¯¢æ­£ç¡®æ€§æµ‹è¯•

---

## å®Œæˆæ ‡å‡†

- [ ] æ¶ˆé™¤æ‰€æœ‰ N+1 æŸ¥è¯¢
- [ ] æ‰¹é‡æŸ¥è¯¢ä½¿ç”¨ PostgreSQL `ANY` è¯­æ³•
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] æ­£ç¡®æ€§æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [PostgreSQL ANY æ–‡æ¡£](https://www.postgresql.org/docs/current/functions-comparisons.html)
