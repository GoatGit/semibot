# ä»»åŠ¡ï¼šé”™è¯¯å¤„ç†ç»Ÿä¸€

**ä¼˜å…ˆçº§**: ğŸŸ¢ P2 - ä¸­ä¼˜å…ˆçº§
**ç±»å‹**: ç¼–ç è§„èŒƒ
**é¢„ä¼°å·¥æ—¶**: 2-3 å°æ—¶
**å½±å“èŒƒå›´**: å¤šä¸ª Service æ–‡ä»¶

---

## é—®é¢˜æè¿°

é”™è¯¯å¤„ç†æ–¹å¼ä¸ç»Ÿä¸€ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. éƒ¨åˆ†ä½¿ç”¨ `throw new Error()`
2. éƒ¨åˆ†ä½¿ç”¨ `createError()`
3. é”™è¯¯ç ä¸è§„èŒƒ
4. é”™è¯¯æ¶ˆæ¯ä¸ä¸€è‡´

---

## è¿è§„ä½ç½®ç¤ºä¾‹

```typescript
// âŒ ç›´æ¥æŠ›å‡º Error
throw new Error('Agent not found')

// âŒ ä¸è§„èŒƒçš„é”™è¯¯ç 
throw createError(400, 'error', 'å‚æ•°é”™è¯¯')

// âŒ é”™è¯¯æ¶ˆæ¯ä¸ä¸€è‡´ï¼ˆä¸­è‹±æ··ç”¨ï¼‰
throw createError(404, 'NOT_FOUND', 'Agent not found')
throw createError(404, 'NOT_FOUND', 'Agent ä¸å­˜åœ¨')
```

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. å®šä¹‰æ ‡å‡†é”™è¯¯ç 

```typescript
// apps/api/src/constants/errors.ts

export const ErrorCodes = {
  // è®¤è¯é”™è¯¯ (401)
  UNAUTHORIZED: 'UNAUTHORIZED',
  TOKEN_EXPIRED: 'TOKEN_EXPIRED',
  INVALID_TOKEN: 'INVALID_TOKEN',

  // æˆæƒé”™è¯¯ (403)
  FORBIDDEN: 'FORBIDDEN',
  INSUFFICIENT_PERMISSIONS: 'INSUFFICIENT_PERMISSIONS',

  // èµ„æºé”™è¯¯ (404)
  AGENT_NOT_FOUND: 'AGENT_NOT_FOUND',
  SESSION_NOT_FOUND: 'SESSION_NOT_FOUND',
  SKILL_NOT_FOUND: 'SKILL_NOT_FOUND',
  TOOL_NOT_FOUND: 'TOOL_NOT_FOUND',
  USER_NOT_FOUND: 'USER_NOT_FOUND',

  // éªŒè¯é”™è¯¯ (400)
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  INVALID_INPUT: 'INVALID_INPUT',
  INVALID_UUID: 'INVALID_UUID',

  // å†²çªé”™è¯¯ (409)
  VERSION_CONFLICT: 'VERSION_CONFLICT',
  DUPLICATE_ENTRY: 'DUPLICATE_ENTRY',
  EMAIL_EXISTS: 'EMAIL_EXISTS',

  // é…é¢é”™è¯¯ (429)
  RATE_LIMIT_EXCEEDED: 'RATE_LIMIT_EXCEEDED',
  QUOTA_EXCEEDED: 'QUOTA_EXCEEDED',

  // æœåŠ¡å™¨é”™è¯¯ (500)
  INTERNAL_ERROR: 'INTERNAL_ERROR',
  DATABASE_ERROR: 'DATABASE_ERROR',
  EXTERNAL_SERVICE_ERROR: 'EXTERNAL_SERVICE_ERROR'
} as const

export type ErrorCode = typeof ErrorCodes[keyof typeof ErrorCodes]

// é”™è¯¯æ¶ˆæ¯æ¨¡æ¿ï¼ˆç»Ÿä¸€ä½¿ç”¨ä¸­æ–‡ï¼‰
export const ErrorMessages: Record<ErrorCode, string> = {
  UNAUTHORIZED: 'æœªè®¤è¯ï¼Œè¯·ç™»å½•',
  TOKEN_EXPIRED: 'Token å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
  INVALID_TOKEN: 'æ— æ•ˆçš„ Token',
  FORBIDDEN: 'æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ',
  INSUFFICIENT_PERMISSIONS: 'æƒé™ä¸è¶³',
  AGENT_NOT_FOUND: 'Agent ä¸å­˜åœ¨',
  SESSION_NOT_FOUND: 'ä¼šè¯ä¸å­˜åœ¨',
  SKILL_NOT_FOUND: 'Skill ä¸å­˜åœ¨',
  TOOL_NOT_FOUND: 'Tool ä¸å­˜åœ¨',
  USER_NOT_FOUND: 'ç”¨æˆ·ä¸å­˜åœ¨',
  VALIDATION_ERROR: 'è¾“å…¥éªŒè¯å¤±è´¥',
  INVALID_INPUT: 'è¾“å…¥å‚æ•°æ— æ•ˆ',
  INVALID_UUID: 'æ— æ•ˆçš„ ID æ ¼å¼',
  VERSION_CONFLICT: 'æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•',
  DUPLICATE_ENTRY: 'æ•°æ®å·²å­˜åœ¨',
  EMAIL_EXISTS: 'é‚®ç®±å·²è¢«æ³¨å†Œ',
  RATE_LIMIT_EXCEEDED: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
  QUOTA_EXCEEDED: 'é…é¢å·²ç”¨å®Œ',
  INTERNAL_ERROR: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
  DATABASE_ERROR: 'æ•°æ®åº“é”™è¯¯',
  EXTERNAL_SERVICE_ERROR: 'å¤–éƒ¨æœåŠ¡é”™è¯¯'
}
```

### 2. å¢å¼º createError å‡½æ•°

```typescript
// apps/api/src/lib/errors.ts

import { ErrorCode, ErrorCodes, ErrorMessages } from '../constants/errors'

export class AppError extends Error {
  constructor(
    public readonly statusCode: number,
    public readonly code: ErrorCode,
    public readonly message: string,
    public readonly details?: unknown
  ) {
    super(message)
    this.name = 'AppError'
    Error.captureStackTrace(this, this.constructor)
  }
}

/**
 * åˆ›å»ºåº”ç”¨é”™è¯¯
 * @param statusCode HTTP çŠ¶æ€ç 
 * @param code é”™è¯¯ç 
 * @param message å¯é€‰çš„è‡ªå®šä¹‰æ¶ˆæ¯
 * @param details å¯é€‰çš„è¯¦ç»†ä¿¡æ¯
 */
export function createError(
  statusCode: number,
  code: ErrorCode,
  message?: string,
  details?: unknown
): AppError {
  const msg = message || ErrorMessages[code] || 'æœªçŸ¥é”™è¯¯'
  return new AppError(statusCode, code, msg, details)
}

// ä¾¿æ·å‡½æ•°
export const errors = {
  unauthorized: (message?: string) =>
    createError(401, ErrorCodes.UNAUTHORIZED, message),

  forbidden: (message?: string) =>
    createError(403, ErrorCodes.FORBIDDEN, message),

  notFound: (resource: 'Agent' | 'Session' | 'Skill' | 'Tool' | 'User') => {
    const codeMap = {
      Agent: ErrorCodes.AGENT_NOT_FOUND,
      Session: ErrorCodes.SESSION_NOT_FOUND,
      Skill: ErrorCodes.SKILL_NOT_FOUND,
      Tool: ErrorCodes.TOOL_NOT_FOUND,
      User: ErrorCodes.USER_NOT_FOUND
    }
    return createError(404, codeMap[resource])
  },

  validation: (details?: unknown) =>
    createError(400, ErrorCodes.VALIDATION_ERROR, undefined, details),

  conflict: (message?: string) =>
    createError(409, ErrorCodes.VERSION_CONFLICT, message),

  rateLimit: () =>
    createError(429, ErrorCodes.RATE_LIMIT_EXCEEDED),

  internal: (message?: string) =>
    createError(500, ErrorCodes.INTERNAL_ERROR, message)
}
```

### 3. ä½¿ç”¨ç¤ºä¾‹

```typescript
// apps/api/src/services/agent.service.ts

import { errors, createError, ErrorCodes } from '../lib/errors'

export async function getAgentById(id: string, orgId: string): Promise<Agent> {
  const agent = await agentRepository.findByIdAndOrg(id, orgId)

  if (!agent) {
    // âœ… ä½¿ç”¨ä¾¿æ·å‡½æ•°
    throw errors.notFound('Agent')
  }

  return rowToAgent(agent)
}

export async function updateAgent(
  id: string,
  orgId: string,
  data: UpdateAgentInput,
  version: number
): Promise<Agent> {
  const updated = await agentRepository.update(id, orgId, data, version)

  if (!updated) {
    const existing = await agentRepository.findByIdAndOrg(id, orgId)
    if (!existing) {
      throw errors.notFound('Agent')
    }
    // âœ… ç‰ˆæœ¬å†²çª
    throw errors.conflict()
  }

  return rowToAgent(updated)
}
```

---

## ä¿®å¤æ¸…å•

### é”™è¯¯å®šä¹‰
- [ ] åˆ›å»º `constants/errors.ts`
- [ ] å®šä¹‰æ‰€æœ‰é”™è¯¯ç 
- [ ] å®šä¹‰æ‰€æœ‰é”™è¯¯æ¶ˆæ¯

### é”™è¯¯å·¥å…·
- [ ] å¢å¼º `lib/errors.ts`
- [ ] æ·»åŠ ä¾¿æ·å‡½æ•°

### Service ä¿®å¤
- [ ] `agent.service.ts` - ç»Ÿä¸€é”™è¯¯å¤„ç†
- [ ] `session.service.ts` - ç»Ÿä¸€é”™è¯¯å¤„ç†
- [ ] `skill.service.ts` - ç»Ÿä¸€é”™è¯¯å¤„ç†
- [ ] `tool.service.ts` - ç»Ÿä¸€é”™è¯¯å¤„ç†
- [ ] `auth.service.ts` - ç»Ÿä¸€é”™è¯¯å¤„ç†
- [ ] `mcp.service.ts` - ç»Ÿä¸€é”™è¯¯å¤„ç†

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰é”™è¯¯ä½¿ç”¨ `createError` æˆ–ä¾¿æ·å‡½æ•°
- [ ] é”™è¯¯ç è§„èŒƒç»Ÿä¸€
- [ ] é”™è¯¯æ¶ˆæ¯è¯­è¨€ç»Ÿä¸€ï¼ˆä¸­æ–‡ï¼‰
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [ç¼–ç è§„èŒƒ - é”™è¯¯å¤„ç†](.claude/rules/coding-standards.md#é”™è¯¯å¤„ç†)
- [API è§„èŒƒ - å“åº”æ ¼å¼](.claude/rules/api-standards.md#å“åº”æ ¼å¼)
