# TASK-62: 使用量配额限制系统

## 优先级: P1 — 商业化基础能力

## PRD

[使用量配额限制系统](../PRDS/missing-usage-quota.md)

## 描述

当前已实现使用量查询统计，但缺少配额定义、配额检查和超限拦截。用户可以无限制消耗资源。需要实现配额方案管理、请求前配额检查、超限 429 响应。

## 涉及文件

- 新增 `docs/sql/018_quotas.sql`
- 新增 `apps/api/src/middleware/quota.ts`
- 新增 `apps/api/src/services/quota.service.ts`
- 新增 `apps/api/src/repositories/quota.repository.ts`
- 新增 `apps/api/src/routes/v1/quotas.ts`
- 修改 `apps/api/src/routes/v1/chat.ts` — 接入配额检查
- 修改 `apps/api/src/routes/v1/index.ts` — 注册路由

## 修复方式

1. 创建 `quota_plans` 和 `org_quotas` 表
2. 实现配额检查中间件（Redis 缓存当前用量）
3. Chat 请求前检查 Token 配额
4. 超限返回 429 + 明确错误信息
5. 接近配额（80%）时响应头添加警告
6. 实现配额查询 API

## 验收标准

- [ ] 配额方案可定义和查询
- [ ] Chat 请求前检查 Token 配额
- [ ] 超限返回 429 + 明确错误信息
- [ ] 接近配额时响应头包含警告
- [ ] Redis 缓存用量数据
- [ ] 单元测试覆盖

## 状态: 待处理
