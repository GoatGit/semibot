# ä»»åŠ¡ï¼šè¡¥å……è¾¹ç•Œæ—¥å¿—

**ä¼˜å…ˆçº§**: ğŸŸ¡ P1 - é«˜ä¼˜å…ˆçº§
**ç±»å‹**: ç¼–ç è§„èŒƒ
**é¢„ä¼°å·¥æ—¶**: 2-3 å°æ—¶
**å½±å“èŒƒå›´**: 15 ä¸ª Repository æ–‡ä»¶ï¼Œçº¦ 30+ å¤„ä¿®æ”¹

---

## é—®é¢˜æè¿°

æ‰€æœ‰ `Math.min/max` å’Œ `slice` ç­‰è¾¹ç•Œæ“ä½œç¼ºå°‘æ—¥å¿—è®°å½•ã€‚æ ¹æ®ç¼–ç è§„èŒƒï¼Œæ‰€æœ‰è§¦åŠè¾¹ç•Œã€æœ€å¤§/æœ€å°é™åˆ¶çš„ä»£ç ä½ç½®ï¼Œå¿…é¡»æ‰“å°æ—¥å¿—ä»¥ä¾¿æµ‹è¯•å’Œè°ƒè¯•ã€‚

---

## è§„èŒƒè¦æ±‚

æ ¹æ® `.claude/rules/coding-standards.md`:

```typescript
// âŒ é”™è¯¯ - è¾¹ç•Œæ£€æŸ¥æ— æ—¥å¿—
if (items.length >= MAX_ITEMS) {
  return false
}
const truncated = content.slice(0, MAX_LENGTH)

// âœ… æ­£ç¡® - è¾¹ç•Œæ£€æŸ¥æœ‰æ—¥å¿—
if (items.length >= MAX_ITEMS) {
  logger.warn('[Module] æ•°é‡å·²è¾¾ä¸Šé™ï¼Œæ“ä½œè¢«æ‹’ç»', {
    current: items.length,
    limit: MAX_ITEMS
  })
  return false
}
if (content.length > MAX_LENGTH) {
  logger.warn('[Module] å†…å®¹è¶…å‡ºé™åˆ¶ï¼Œå·²æˆªæ–­', {
    originalLength: content.length,
    limit: MAX_LENGTH
  })
}
const truncated = content.slice(0, MAX_LENGTH)
```

---

## ç¼ºå¤±æ—¥å¿—çš„ä½ç½®

### 1. Repository å±‚ - åˆ†é¡µé™åˆ¶ï¼ˆ10+ å¤„ï¼‰

**æ–‡ä»¶**: å¤šä¸ª Repository æ–‡ä»¶

```typescript
// âŒ é”™è¯¯ - Math.min æ— æ—¥å¿—
const actualLimit = Math.min(limit, MAX_PAGE_SIZE)

// âœ… ä¿®å¤
const actualLimit = Math.min(limit, MAX_PAGE_SIZE)
if (limit > MAX_PAGE_SIZE) {
  logger.warn('[Repository] åˆ†é¡µå¤§å°è¶…å‡ºé™åˆ¶ï¼Œå·²æˆªæ–­', {
    requested: limit,
    actual: actualLimit,
    max: MAX_PAGE_SIZE,
    repository: 'AgentRepository'
  })
}
```

**å½±å“æ–‡ä»¶**:
- `apps/api/src/repositories/logs.repository.ts:162`
- `apps/api/src/repositories/agent.repository.ts:148`
- `apps/api/src/repositories/skill-definition.repository.ts:161`
- `apps/api/src/repositories/skill-install-log.repository.ts:164`
- `apps/api/src/repositories/skill-package.repository.ts:208`
- `apps/api/src/repositories/memory.repository.ts:115`
- `apps/api/src/repositories/mcp.repository.ts:144`
- `apps/api/src/repositories/skill.repository.ts:138`
- `apps/api/src/repositories/tool.repository.ts:117`
- `apps/api/src/repositories/session.repository.ts:114`

### 2. Service å±‚ - æ•°ç»„æˆªæ–­ï¼ˆ5+ å¤„ï¼‰

**æ–‡ä»¶**: `apps/api/src/services/skill.service.ts`

```typescript
// âŒ é”™è¯¯ - slice æˆªæ–­æ— æ—¥å¿— (ç¬¬ 232 è¡Œ)
.slice(0, 20)

// âœ… ä¿®å¤
const keywords = input.triggerKeywords ?? [normalizedSkillId]
if (keywords.length > MAX_SKILL_KEYWORDS) {
  logger.warn('[SkillService] å…³é”®è¯æ•°é‡è¶…å‡ºé™åˆ¶ï¼Œå·²æˆªæ–­', {
    original: keywords.length,
    limit: MAX_SKILL_KEYWORDS,
    skillId: normalizedSkillId
  })
}
const triggerKeywords = keywords.slice(0, MAX_SKILL_KEYWORDS)
```

**å…¶ä»–ä½ç½®**:
- `skill.service.ts:456` - Skill åç§°æˆªæ–­
- `skill.service.ts:459` - å…³é”®è¯æ•°ç»„æˆªæ–­
- `skill-retry-rollback.service.ts:348` - åŒ…ç‰ˆæœ¬æˆªæ–­

### 3. Web å±‚ - å­—ç¬¦ä¸²æˆªæ–­

**æ–‡ä»¶**: `apps/web/lib/utils.ts:128`

```typescript
// âŒ é”™è¯¯ - å­—ç¬¦ä¸²æˆªæ–­æ— æ—¥å¿—
return str.slice(0, maxLength - suffix.length) + suffix

// âœ… ä¿®å¤
export function truncateString(str: string, maxLength: number, suffix = '...'): string {
  if (str.length <= maxLength) {
    return str
  }

  console.warn('[Utils] å­—ç¬¦ä¸²è¶…å‡ºé™åˆ¶ï¼Œå·²æˆªæ–­', {
    originalLength: str.length,
    maxLength,
    truncatedLength: maxLength - suffix.length
  })

  return str.slice(0, maxLength - suffix.length) + suffix
}
```

---

## ä¿®å¤æ­¥éª¤

### Phase 1: Repository å±‚ä¿®å¤

åˆ›å»ºç»Ÿä¸€çš„æ—¥å¿—è¾…åŠ©å‡½æ•°ï¼š

```typescript
// apps/api/src/lib/logger.ts

export function logPaginationLimit(
  repository: string,
  requested: number,
  actual: number,
  max: number
): void {
  if (requested > max) {
    logger.warn('[Repository] åˆ†é¡µå¤§å°è¶…å‡ºé™åˆ¶ï¼Œå·²æˆªæ–­', {
      repository,
      requested,
      actual,
      max
    })
  }
}
```

åœ¨æ¯ä¸ª Repository ä¸­ä½¿ç”¨ï¼š

```typescript
import { logPaginationLimit } from '../lib/logger'

export async function findAll(params: ListParams): Promise<PaginatedResult<Row>> {
  const { limit = DEFAULT_PAGE_SIZE } = params
  const actualLimit = Math.min(limit, MAX_PAGE_SIZE)

  // âœ… æ·»åŠ æ—¥å¿—
  logPaginationLimit('AgentRepository', limit, actualLimit, MAX_PAGE_SIZE)

  // ... æŸ¥è¯¢é€»è¾‘
}
```

### Phase 2: Service å±‚ä¿®å¤

```typescript
// apps/api/src/services/skill.service.ts

// ä¿®å¤å…³é”®è¯æˆªæ–­
const keywords = input.triggerKeywords ?? [normalizedSkillId]
if (keywords.length > MAX_SKILL_KEYWORDS) {
  logger.warn('[SkillService] å…³é”®è¯æ•°é‡è¶…å‡ºé™ï¿½ï¿½ï¼Œå·²æˆªæ–­', {
    skillId: normalizedSkillId,
    original: keywords.length,
    limit: MAX_SKILL_KEYWORDS,
    dropped: keywords.length - MAX_SKILL_KEYWORDS
  })
}
const triggerKeywords = keywords.slice(0, MAX_SKILL_KEYWORDS)

// ä¿®å¤åç§°æˆªæ–­
const rawName = input.name?.trim() || `anthropic-${normalizedSkillId}`
if (rawName.length > MAX_SKILL_NAME_LENGTH) {
  logger.warn('[SkillService] Skill åç§°è¶…å‡ºé™åˆ¶ï¼Œå·²æˆªæ–­', {
    skillId: normalizedSkillId,
    original: rawName.length,
    limit: MAX_SKILL_NAME_LENGTH
  })
}
const skillName = rawName.slice(0, MAX_SKILL_NAME_LENGTH)
```

### Phase 3: Web å±‚ä¿®å¤

```typescript
// apps/web/lib/utils.ts

export function truncateString(str: string, maxLength: number, suffix = '...'): string {
  if (str.length <= maxLength) {
    return str
  }

  // âœ… æ·»åŠ æ—¥å¿—ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
  if (process.env.NODE_ENV === 'development') {
    console.warn('[Utils] å­—ç¬¦ä¸²æˆªæ–­', {
      originalLength: str.length,
      maxLength,
      preview: str.slice(0, 20) + '...'
    })
  }

  return str.slice(0, maxLength - suffix.length) + suffix
}
```

---

## ä¿®å¤æ¸…å•

### Repository å±‚ï¼ˆ10 ä¸ªæ–‡ä»¶ï¼‰
- [ ] `logs.repository.ts` - åˆ†é¡µé™åˆ¶æ—¥å¿—
- [ ] `agent.repository.ts` - åˆ†é¡µé™åˆ¶æ—¥å¿—
- [ ] `skill-definition.repository.ts` - åˆ†é¡µé™åˆ¶æ—¥å¿—
- [ ] `skill-install-log.repository.ts` - åˆ†é¡µé™åˆ¶æ—¥å¿—
- [ ] `skill-package.repository.ts` - åˆ†é¡µé™åˆ¶æ—¥å¿—
- [ ] `memory.repository.ts` - åˆ†é¡µé™åˆ¶æ—¥å¿—
- [ ] `mcp.repository.ts` - åˆ†é¡µé™åˆ¶æ—¥å¿—
- [ ] `skill.repository.ts` - åˆ†é¡µé™åˆ¶æ—¥å¿—
- [ ] `tool.repository.ts` - åˆ†é¡µé™åˆ¶æ—¥å¿—
- [ ] `session.repository.ts` - åˆ†é¡µé™åˆ¶æ—¥å¿—

### Service å±‚ï¼ˆ2 ä¸ªæ–‡ä»¶ï¼‰
- [ ] `skill.service.ts` - æ•°ç»„å’Œå­—ç¬¦ä¸²æˆªæ–­æ—¥å¿—
- [ ] `skill-retry-rollback.service.ts` - åŒ…ç‰ˆæœ¬æˆªæ–­æ—¥å¿—

### Web å±‚ï¼ˆ1 ä¸ªæ–‡ä»¶ï¼‰
- [ ] `utils.ts` - å­—ç¬¦ä¸²æˆªæ–­æ—¥å¿—

### è¾…åŠ©å‡½æ•°
- [ ] åˆ›å»º `logPaginationLimit` è¾…åŠ©å‡½æ•°
- [ ] åˆ›å»º `logArrayTruncation` è¾…åŠ©å‡½æ•°
- [ ] åˆ›å»º `logStringTruncation` è¾…åŠ©å‡½æ•°

---

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
```typescript
describe('è¾¹ç•Œæ—¥å¿—æµ‹è¯•', () => {
  it('åˆ†é¡µè¶…å‡ºé™åˆ¶æ—¶åº”è¯¥æ‰“å°æ—¥å¿—', async () => {
    const logSpy = jest.spyOn(logger, 'warn')

    await agentRepository.findAll({
      orgId,
      limit: 200  // è¶…è¿‡ MAX_PAGE_SIZE (100)
    })

    expect(logSpy).toHaveBeenCalledWith(
      expect.stringContaining('åˆ†é¡µå¤§å°è¶…å‡ºé™åˆ¶'),
      expect.objectContaining({
        requested: 200,
        actual: 100,
        max: 100
      })
    )
  })

  it('æ•°ç»„æˆªæ–­æ—¶åº”è¯¥æ‰“å°æ—¥å¿—', async () => {
    const logSpy = jest.spyOn(logger, 'warn')

    const keywords = Array(30).fill('keyword')  // è¶…è¿‡ MAX_SKILL_KEYWORDS (20)

    await skillService.create({
      ...data,
      triggerKeywords: keywords
    })

    expect(logSpy).toHaveBeenCalledWith(
      expect.stringContaining('å…³é”®è¯æ•°é‡è¶…å‡ºé™åˆ¶'),
      expect.objectContaining({
        original: 30,
        limit: 20
      })
    )
  })
})
```

### 2. é›†æˆæµ‹è¯•
```bash
# è¿è¡Œæµ‹è¯•å¹¶æ£€æŸ¥æ—¥å¿—è¾“å‡º
cd apps/api
pnpm test 2>&1 | grep "è¶…å‡ºé™åˆ¶"
```

---

## æ³¨æ„äº‹é¡¹

1. **æ—¥å¿—çº§åˆ«**
   - è¾¹ç•Œè§¦å‘ä½¿ç”¨ WARN çº§åˆ«
   - åŒ…å«å…³é”®ä¸Šä¸‹æ–‡ä¿¡æ¯
   - é¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²

2. **æ€§èƒ½è€ƒè™‘**
   - æ—¥å¿—ä¸åº”å½±å“æ€§èƒ½
   - é¿å…åœ¨å¾ªç¯ä¸­é¢‘ç¹æ‰“å°
   - è€ƒè™‘ä½¿ç”¨é‡‡æ ·ï¼ˆé«˜é¢‘åœºæ™¯ï¼‰

3. **æ—¥å¿—å†…å®¹**
   - åŒ…å«åŸå§‹å€¼å’Œé™åˆ¶å€¼
   - åŒ…å«æ¨¡å—/åŠŸèƒ½æ ‡è¯†
   - åŒ…å«å…³é”® IDï¼ˆå¦‚ userId, orgIdï¼‰

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰ Math.min/max æ“ä½œéƒ½æœ‰æ—¥å¿—
- [ ] æ‰€æœ‰ slice æˆªæ–­æ“ä½œéƒ½æœ‰æ—¥å¿—
- [ ] æ—¥å¿—åŒ…å«å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [ç¼–ç è§„èŒƒ - è¾¹ç•Œæ£€æŸ¥æ—¥å¿—](.claude/rules/coding-standards.md#è¾¹ç•Œæ£€æŸ¥å¿…é¡»æ‰“å°æ—¥å¿—)
- [æ—¥å¿—è§„èŒƒ](.claude/rules/coding-standards.md#æ—¥å¿—è§„èŒƒ)
