# ä»»åŠ¡ï¼šä¿®å¤ç«æ€æ¡ä»¶

**ä¼˜å…ˆçº§**: ğŸ”´ P0 - ä¸¥é‡
**ç±»å‹**: å¹¶å‘è§„èŒƒ
**é¢„ä¼°å·¥æ—¶**: 0.5-1 å°æ—¶
**å½±å“èŒƒå›´**: 1 ä¸ªæ–‡ä»¶

---

## é—®é¢˜æè¿°

`auth.service.ts` ä¸­çš„å¯†ç é‡ç½®è¯·æ±‚é™æµå­˜åœ¨ç«æ€æ¡ä»¶ã€‚`exists` å’Œ `setWithExpiry` æ˜¯ä¸¤ä¸ªç‹¬ç«‹æ“ä½œï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¤šä¸ªè¯·æ±‚å¯èƒ½åŒæ—¶é€šè¿‡æ£€æŸ¥ã€‚

---

## è¿è§„ä½ç½®

**æ–‡ä»¶**: `apps/api/src/services/auth.service.ts:368-372`

```typescript
// âŒ é”™è¯¯ - å­˜åœ¨ç«æ€æ¡ä»¶
const hasRecentRequest = await redis.exists(requestThrottleKey)
if (hasRecentRequest) {
    return
}
await redis.setWithExpiry(requestThrottleKey, '1', PASSWORD_RESET_REQUEST_TTL_SECONDS)
```

**é—®é¢˜åˆ†æ**:
1. è¯·æ±‚ A æ‰§è¡Œ `exists` â†’ è¿”å› false
2. è¯·æ±‚ B æ‰§è¡Œ `exists` â†’ è¿”å› falseï¼ˆA è¿˜æœª setï¼‰
3. è¯·æ±‚ A æ‰§è¡Œ `setWithExpiry`
4. è¯·æ±‚ B æ‰§è¡Œ `setWithExpiry`
5. ç»“æœï¼šä¸¤ä¸ªè¯·æ±‚éƒ½é€šè¿‡äº†é™æµ

---

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä½¿ç”¨ Redis SET NX EXï¼ˆæ¨èï¼‰

```typescript
// âœ… æ­£ç¡® - åŸå­æ“ä½œ
const result = await redis.set(
  requestThrottleKey,
  '1',
  'EX',
  PASSWORD_RESET_REQUEST_TTL_SECONDS,
  'NX'  // Only set if Not eXists
)

if (!result) {
  // Key å·²å­˜åœ¨ï¼Œè¯´æ˜æœ€è¿‘æœ‰è¯·æ±‚
  return
}

// Key è®¾ç½®æˆåŠŸï¼Œç»§ç»­å¤„ç†
```

**ä¼˜ç‚¹**:
- åŸå­æ“ä½œï¼Œæ— ç«æ€æ¡ä»¶
- Redis åŸç”Ÿæ”¯æŒ
- æ€§èƒ½æœ€ä¼˜

### æ–¹æ¡ˆ 2: ä½¿ç”¨ Lua è„šæœ¬

```typescript
// âœ… æ­£ç¡® - Lua è„šæœ¬ä¿è¯åŸå­æ€§
const THROTTLE_SCRIPT = `
  local key = KEYS[1]
  local ttl = tonumber(ARGV[1])

  if redis.call('EXISTS', key) == 1 then
    return 0  -- Key exists, throttled
  end

  redis.call('SETEX', key, ttl, '1')
  return 1  -- Success
`

const result = await redis.eval(
  THROTTLE_SCRIPT,
  1,
  requestThrottleKey,
  PASSWORD_RESET_REQUEST_TTL_SECONDS
)

if (result === 0) {
  return  // Throttled
}
```

**ä¼˜ç‚¹**:
- åŸå­æ“ä½œ
- æ›´çµæ´»ï¼Œå¯ä»¥æ·»åŠ å¤æ‚é€»è¾‘

**ç¼ºç‚¹**:
- éœ€è¦ç»´æŠ¤ Lua è„šæœ¬
- ç¨å¾®å¤æ‚

---

## å®Œæ•´ä¿®å¤ä»£ç 

```typescript
// apps/api/src/services/auth.service.ts

export async function requestPasswordReset(email: string): Promise<void> {
  // 1. æŸ¥æ‰¾ç”¨æˆ·
  const user = await userRepository.findByEmail(email)
  if (!user) {
    // ä¸æš´éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    return
  }

  // 2. æ£€æŸ¥è¯·æ±‚é™æµï¼ˆä¿®å¤ç«æ€æ¡ä»¶ï¼‰
  const requestThrottleKey = `password_reset_request:${user.id}`

  // âœ… ä½¿ç”¨ SET NX EX åŸå­æ“ä½œ
  const canProceed = await redis.set(
    requestThrottleKey,
    '1',
    'EX',
    PASSWORD_RESET_REQUEST_TTL_SECONDS,
    'NX'
  )

  if (!canProceed) {
    logger.warn('å¯†ç é‡ç½®è¯·æ±‚è¿‡äºé¢‘ç¹', {
      userId: user.id,
      email: user.email
    })
    return
  }

  // 3. ç”Ÿæˆé‡ç½® Token
  const resetToken = generateSecureToken()
  const resetTokenHash = await hashToken(resetToken)

  // 4. ä¿å­˜åˆ° Redis
  const resetKey = `password_reset:${resetToken}`
  await redis.setWithExpiry(
    resetKey,
    JSON.stringify({
      userId: user.id,
      email: user.email,
      createdAt: Date.now()
    }),
    PASSWORD_RESET_TOKEN_TTL_SECONDS
  )

  // 5. å‘é€é‚®ä»¶
  await emailService.sendPasswordResetEmail(user.email, resetToken)

  logger.info('å¯†ç é‡ç½®é‚®ä»¶å·²å‘é€', {
    userId: user.id,
    email: user.email
  })
}
```

---

## Redis å®¢æˆ·ç«¯é€‚é…

æ£€æŸ¥ `apps/api/src/lib/redis.ts` æ˜¯å¦æ”¯æŒ SET NX EXï¼š

```typescript
// å¦‚æœä½¿ç”¨ ioredis
export async function setNX(
  key: string,
  value: string,
  ttlSeconds: number
): Promise<boolean> {
  const result = await redis.set(key, value, 'EX', ttlSeconds, 'NX')
  return result === 'OK'
}

// æˆ–è€…ç›´æ¥ä½¿ç”¨
const result = await redis.set(key, value, 'EX', ttl, 'NX')
```

---

## æµ‹è¯•éªŒè¯

### 1. å•å…ƒæµ‹è¯•
```typescript
describe('requestPasswordReset ç«æ€æ¡ä»¶æµ‹è¯•', () => {
  it('å¹¶å‘è¯·æ±‚åº”è¯¥åªæœ‰ä¸€ä¸ªæˆåŠŸ', async () => {
    const email = 'test@example.com'

    // å¹¶å‘å‘é€ 10 ä¸ªè¯·æ±‚
    const promises = Array(10).fill(null).map(() =>
      authService.requestPasswordReset(email)
    )

    await Promise.all(promises)

    // éªŒè¯åªå‘é€äº†ä¸€å°é‚®ä»¶
    expect(emailService.sendPasswordResetEmail).toHaveBeenCalledTimes(1)
  })

  it('è¶…è¿‡ TTL ååº”è¯¥å¯ä»¥å†æ¬¡è¯·æ±‚', async () => {
    const email = 'test@example.com'

    // ç¬¬ä¸€æ¬¡è¯·æ±‚
    await authService.requestPasswordReset(email)
    expect(emailService.sendPasswordResetEmail).toHaveBeenCalledTimes(1)

    // ç«‹å³å†æ¬¡è¯·æ±‚ï¼Œåº”è¯¥è¢«é™æµ
    await authService.requestPasswordReset(email)
    expect(emailService.sendPasswordResetEmail).toHaveBeenCalledTimes(1)

    // ç­‰å¾… TTL è¿‡æœŸ
    await new Promise(resolve => setTimeout(resolve, PASSWORD_RESET_REQUEST_TTL_SECONDS * 1000 + 100))

    // å†æ¬¡è¯·æ±‚ï¼Œåº”è¯¥æˆåŠŸ
    await authService.requestPasswordReset(email)
    expect(emailService.sendPasswordResetEmail).toHaveBeenCalledTimes(2)
  })
})
```

### 2. å‹åŠ›æµ‹è¯•
```typescript
describe('é«˜å¹¶å‘å‹åŠ›æµ‹è¯•', () => {
  it('1000 ä¸ªå¹¶å‘è¯·æ±‚åº”è¯¥åªæœ‰ä¸€ä¸ªæˆåŠŸ', async () => {
    const email = 'test@example.com'

    const promises = Array(1000).fill(null).map(() =>
      authService.requestPasswordReset(email)
    )

    await Promise.all(promises)

    expect(emailService.sendPasswordResetEmail).toHaveBeenCalledTimes(1)
  })
})
```

---

## ä¿®å¤æ¸…å•

- [x] æ£€æŸ¥ Redis å®¢æˆ·ç«¯æ˜¯å¦æ”¯æŒ SET NX EX
- [x] ä¿®æ”¹ `requestPasswordReset` æ–¹æ³•
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•
- [ ] æ·»åŠ å¹¶å‘æµ‹è¯•
- [ ] è¿è¡Œæµ‹è¯•éªŒè¯
- [ ] ä»£ç å®¡æŸ¥

---

## æ³¨æ„äº‹é¡¹

1. **Redis ç‰ˆæœ¬è¦æ±‚**
   - SET NX EX éœ€è¦ Redis 2.6.12+
   - é¡¹ç›®åº”è¯¥æ»¡è¶³æ­¤è¦æ±‚

2. **é”™è¯¯å¤„ç†**
   - Redis è¿æ¥å¤±è´¥æ—¶çš„é™çº§ç­–ç•¥
   - è€ƒè™‘ä½¿ç”¨å†…å­˜å›é€€ï¼ˆä½†ä¼šå¤±å»åˆ†å¸ƒå¼é™æµï¼‰

3. **æ—¥å¿—è®°å½•**
   - è®°å½•é™æµè§¦å‘äº‹ä»¶
   - ä¾¿äºç›‘æ§å’Œè°ƒè¯•

---

## å®Œæˆæ ‡å‡†

- [x] ç«æ€æ¡ä»¶å·²ä¿®å¤
- [x] ä½¿ç”¨ Redis åŸå­æ“ä½œ
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] å¹¶å‘æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [å¹¶å‘è§„èŒƒ - Redis åŸå­æ“ä½œ](.claude/rules/concurrency.md#redis-åŸå­æ“ä½œ)
- [Redis SET å‘½ä»¤æ–‡æ¡£](https://redis.io/commands/set/)
