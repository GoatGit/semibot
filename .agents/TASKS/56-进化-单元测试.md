# ä»»åŠ¡ï¼šè¿›åŒ–ç³»ç»Ÿ â€” å•å…ƒæµ‹è¯•

**ä¼˜å…ˆçº§**: ğŸŸ¡ P1 - é‡è¦
**ç±»å‹**: æµ‹è¯•è¦†ç›–
**é¢„ä¼°å·¥æ—¶**: 3-4 å¤©
**å½±å“èŒƒå›´**: runtime/tests/evolution/ã€apps/api/tests/

---

## é—®é¢˜æè¿°

è¿›åŒ–ç³»ç»Ÿæ˜¯ Agent è‡ªå­¦ä¹ çš„æ ¸å¿ƒæ¨¡å—ï¼Œæ¶‰åŠ LLM è°ƒç”¨ã€å‘é‡æ£€ç´¢ã€æ•°æ®åº“å†™å…¥ç­‰å…³é”®æ“ä½œï¼Œå¿…é¡»æœ‰å……åˆ†çš„å•å…ƒæµ‹è¯•è¦†ç›–ã€‚ç›®æ ‡è¦†ç›–ç‡ 80%+ã€‚

---

## éœ€è¦è¡¥å……çš„æµ‹è¯•

### 1. SkillDraft æ•°æ®ç±»æµ‹è¯•

```python
# runtime/tests/evolution/test_models.py

import pytest
from src.evolution.models import SkillDraft


class TestSkillDraft:
    """SkillDraft æ•°æ®ç±»æµ‹è¯•"""

    def test_create_valid_draft(self):
        """æµ‹è¯•åˆ›å»ºæœ‰æ•ˆçš„æŠ€èƒ½è‰ç¨¿"""
        draft = SkillDraft(
            name="æŸ¥è¯¢è®¢å•çŠ¶æ€",
            description="æ ¹æ®è®¢å•å·æŸ¥è¯¢è®¢å•çš„å½“å‰çŠ¶æ€",
            trigger_keywords=["è®¢å•", "æŸ¥è¯¢", "çŠ¶æ€"],
            steps=[
                {"order": 1, "action": "æŸ¥è¯¢è®¢å•", "tool": "order_query", "params_template": {"order_id": "{order_id}"}},
                {"order": 2, "action": "æ ¼å¼åŒ–ç»“æœ", "tool": "formatter", "params_template": {}},
            ],
            tools_used=["order_query", "formatter"],
            parameters={"order_id": {"type": "string", "description": "è®¢å•å·", "required": True}},
            preconditions={"required_tools": ["order_query"]},
            expected_outcome="è¿”å›è®¢å•çŠ¶æ€ä¿¡æ¯",
        )
        assert draft.name == "æŸ¥è¯¢è®¢å•çŠ¶æ€"
        assert draft.is_valid() is True

    def test_invalid_draft_missing_name(self):
        """æµ‹è¯•ç¼ºå°‘åç§°çš„è‰ç¨¿"""
        draft = SkillDraft(
            name="",
            description="æè¿°",
            steps=[{"order": 1, "action": "test", "tool": "t"}],
            tools_used=["t"],
        )
        assert draft.is_valid() is False

    def test_invalid_draft_missing_steps(self):
        """æµ‹è¯•ç¼ºå°‘æ­¥éª¤çš„è‰ç¨¿"""
        draft = SkillDraft(
            name="æµ‹è¯•æŠ€èƒ½",
            description="æè¿°",
            steps=[],
            tools_used=["t"],
        )
        assert draft.is_valid() is False

    def test_invalid_draft_missing_tools(self):
        """æµ‹è¯•ç¼ºå°‘å·¥å…·çš„è‰ç¨¿"""
        draft = SkillDraft(
            name="æµ‹è¯•æŠ€èƒ½",
            description="æè¿°",
            steps=[{"order": 1, "action": "test", "tool": "t"}],
            tools_used=[],
        )
        assert draft.is_valid() is False

    def test_to_dict(self):
        """æµ‹è¯•åºåˆ—åŒ–ä¸ºå­—å…¸"""
        draft = SkillDraft(
            name="æµ‹è¯•",
            description="æè¿°",
            steps=[{"order": 1}],
            tools_used=["t"],
            quality_score=0.85,
        )
        d = draft.to_dict()
        assert d["name"] == "æµ‹è¯•"
        assert d["quality_score"] == 0.85
        assert isinstance(d["steps"], list)

    def test_default_values(self):
        """æµ‹è¯•é»˜è®¤å€¼"""
        draft = SkillDraft(name="test", description="desc")
        assert draft.trigger_keywords == []
        assert draft.steps == []
        assert draft.tools_used == []
        assert draft.parameters == {}
        assert draft.preconditions == {}
        assert draft.quality_score == 0.0
        assert draft.reusability_score == 0.0
```

### 2. EvolutionEngine._should_evolve æµ‹è¯•

```python
# runtime/tests/evolution/test_engine.py

import pytest
from unittest.mock import Mock, AsyncMock, patch
from src.evolution.engine import EvolutionEngine


class TestShouldEvolve:
    """_should_evolve è§¦å‘æ¡ä»¶æµ‹è¯•"""

    @pytest.fixture
    def engine(self):
        return EvolutionEngine(
            llm=Mock(),
            memory_system=Mock(),
            skill_registry=Mock(),
            db_pool=Mock(),
        )

    def _make_state(self, **overrides):
        """æ„é€ æµ‹è¯•ç”¨ state"""
        base = {
            "reflection": {"success": True},
            "tool_results": [{"r": 1}, {"r": 2}, {"r": 3}],
            "agent_config": {"evolution": {"enabled": True}},
            "agent_id": "agent-001",
            "org_id": "org-001",
            "session_id": "session-001",
            "messages": [],
            "plan": {},
        }
        base.update(overrides)
        return base

    def test_should_evolve_all_conditions_met(self, engine):
        """æ‰€æœ‰æ¡ä»¶æ»¡è¶³æ—¶åº”è§¦å‘è¿›åŒ–"""
        engine._check_cooldown = Mock(return_value=True)
        engine._check_rate_limit = Mock(return_value=True)
        state = self._make_state()
        assert engine._should_evolve(state) is True

    def test_skip_when_task_failed(self, engine):
        """ä»»åŠ¡å¤±è´¥æ—¶ä¸è§¦å‘"""
        state = self._make_state(reflection={"success": False})
        assert engine._should_evolve(state) is False

    def test_skip_when_reflection_missing(self, engine):
        """åæ€ç¼ºå¤±æ—¶ä¸è§¦å‘"""
        state = self._make_state(reflection={})
        assert engine._should_evolve(state) is False

    def test_skip_when_steps_insufficient(self, engine):
        """æ­¥éª¤æ•°ä¸è¶³æ—¶ä¸è§¦å‘"""
        state = self._make_state(tool_results=[{"r": 1}, {"r": 2}])
        assert engine._should_evolve(state) is False

    def test_skip_when_evolution_disabled(self, engine):
        """è¿›åŒ–æœªå¯ç”¨æ—¶ä¸è§¦å‘"""
        state = self._make_state(
            agent_config={"evolution": {"enabled": False}}
        )
        assert engine._should_evolve(state) is False

    def test_skip_when_no_evolution_config(self, engine):
        """æ— è¿›åŒ–é…ç½®æ—¶ä¸è§¦å‘"""
        state = self._make_state(agent_config={})
        assert engine._should_evolve(state) is False

    def test_skip_when_cooldown_active(self, engine):
        """å†·å´æœŸå†…ä¸è§¦å‘"""
        engine._check_cooldown = Mock(return_value=False)
        engine._check_rate_limit = Mock(return_value=True)
        state = self._make_state()
        assert engine._should_evolve(state) is False

    def test_skip_when_rate_limited(self, engine):
        """é¢‘ç‡è¶…é™æ—¶ä¸è§¦å‘"""
        engine._check_cooldown = Mock(return_value=True)
        engine._check_rate_limit = Mock(return_value=False)
        state = self._make_state()
        assert engine._should_evolve(state) is False

    def test_boundary_exactly_3_steps(self, engine):
        """æ°å¥½ 3 æ­¥æ—¶åº”è§¦å‘"""
        engine._check_cooldown = Mock(return_value=True)
        engine._check_rate_limit = Mock(return_value=True)
        state = self._make_state(
            tool_results=[{"r": 1}, {"r": 2}, {"r": 3}]
        )
        assert engine._should_evolve(state) is True
```

### 3. EvolutionEngine._extract æµ‹è¯•

```python
# runtime/tests/evolution/test_extract.py

import pytest
import json
from unittest.mock import Mock, AsyncMock
from src.evolution.engine import EvolutionEngine
from src.evolution.models import SkillDraft


class TestExtract:
    """_extract æŠ€èƒ½æå–æµ‹è¯•"""

    @pytest.fixture
    def engine(self):
        llm = Mock()
        llm.chat = AsyncMock()
        return EvolutionEngine(
            llm=llm,
            memory_system=Mock(),
            skill_registry=Mock(),
            db_pool=Mock(),
        )

    @pytest.mark.asyncio
    async def test_extract_success(self, engine):
        """æˆåŠŸæå–æŠ€èƒ½"""
        engine.llm.chat.return_value = json.dumps({
            "name": "æŸ¥è¯¢è®¢å•",
            "description": "æŸ¥è¯¢è®¢å•çŠ¶æ€",
            "trigger_keywords": ["è®¢å•"],
            "steps": [{"order": 1, "action": "æŸ¥è¯¢", "tool": "query"}],
            "tools_used": ["query"],
            "parameters": {},
            "preconditions": {},
            "expected_outcome": "è¿”å›è®¢å•çŠ¶æ€",
            "reusability_score": 0.8,
        })

        state = {
            "reflection": {"success": True, "summary": "ä»»åŠ¡å®Œæˆ"},
            "plan": {"steps": []},
            "tool_results": [{"r": 1}],
            "messages": [{"role": "user", "content": "æŸ¥è¯¢è®¢å•"}],
        }

        draft = await engine._extract(state)
        assert draft is not None
        assert draft.name == "æŸ¥è¯¢è®¢å•"
        assert draft.reusability_score == 0.8

    @pytest.mark.asyncio
    async def test_extract_invalid_json(self, engine):
        """LLM è¿”å›æ— æ•ˆ JSON"""
        engine.llm.chat.return_value = "è¿™ä¸æ˜¯ JSON"

        state = {
            "reflection": {}, "plan": {},
            "tool_results": [], "messages": [],
        }

        draft = await engine._extract(state)
        assert draft is None

    @pytest.mark.asyncio
    async def test_extract_missing_required_fields(self, engine):
        """LLM è¿”å›ç¼ºå°‘å¿…å¡«å­—æ®µçš„ JSON"""
        engine.llm.chat.return_value = json.dumps({
            "description": "åªæœ‰æè¿°",
        })

        state = {
            "reflection": {}, "plan": {},
            "tool_results": [], "messages": [],
        }

        draft = await engine._extract(state)
        # åº”è¯¥è¿”å› Noneï¼ˆKeyError è¢«æ•è·ï¼‰
        assert draft is None
```

### 4. EvolutionEngine._validate æµ‹è¯•

```python
# runtime/tests/evolution/test_validate.py

import pytest
from unittest.mock import Mock, AsyncMock
from src.evolution.engine import EvolutionEngine
from src.evolution.models import SkillDraft


class TestValidate:
    """_validate æŠ€èƒ½éªŒè¯æµ‹è¯•"""

    @pytest.fixture
    def engine(self):
        memory = Mock()
        memory.search_evolved_skills = AsyncMock(return_value=[])
        engine = EvolutionEngine(
            llm=Mock(),
            memory_system=memory,
            skill_registry=Mock(),
            db_pool=Mock(),
        )
        engine._assess_quality = AsyncMock(
            return_value={"score": 0.8, "reusability": 0.7}
        )
        return engine

    def _make_draft(self, **overrides):
        base = {
            "name": "æµ‹è¯•æŠ€èƒ½",
            "description": "æµ‹è¯•æè¿°",
            "steps": [{"order": 1, "action": "test", "tool": "t"}],
            "tools_used": ["t"],
        }
        base.update(overrides)
        return SkillDraft(**base)

    @pytest.mark.asyncio
    async def test_validate_success(self, engine):
        """éªŒè¯é€šè¿‡"""
        draft = self._make_draft()
        state = {"agent_config": {"evolution": {"min_quality_score": 0.6}}}
        result = await engine._validate(draft, state)
        assert result is True
        assert draft.quality_score == 0.8

    @pytest.mark.asyncio
    async def test_validate_fail_incomplete(self, engine):
        """å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥"""
        draft = SkillDraft(name="", description="desc")
        state = {"agent_config": {"evolution": {}}}
        result = await engine._validate(draft, state)
        assert result is False

    @pytest.mark.asyncio
    async def test_validate_fail_duplicate(self, engine):
        """å»é‡æ£€æŸ¥å¤±è´¥"""
        engine.memory.search_evolved_skills.return_value = [
            {"name": "å·²æœ‰æŠ€èƒ½", "similarity": 0.9}
        ]
        draft = self._make_draft()
        state = {"agent_config": {"evolution": {}}}
        result = await engine._validate(draft, state)
        assert result is False

    @pytest.mark.asyncio
    async def test_validate_fail_low_quality(self, engine):
        """è´¨é‡è¯„åˆ†ä¸è¶³"""
        engine._assess_quality.return_value = {"score": 0.4, "reusability": 0.3}
        draft = self._make_draft()
        state = {"agent_config": {"evolution": {"min_quality_score": 0.6}}}
        result = await engine._validate(draft, state)
        assert result is False

    @pytest.mark.asyncio
    async def test_validate_fail_unsafe(self, engine):
        """å®‰å…¨æ£€æŸ¥å¤±è´¥"""
        draft = self._make_draft(
            steps=[{"order": 1, "action": "rm -rf /", "tool": "shell"}],
            tools_used=["shell"],
        )
        state = {"agent_config": {"evolution": {}}}
        result = await engine._validate(draft, state)
        assert result is False
```

### 5. SafetyChecker æµ‹è¯•

```python
# runtime/tests/evolution/test_safety.py

import pytest
from src.evolution.validators import SafetyChecker, SafetyResult
from src.evolution.models import SkillDraft


class TestSafetyChecker:
    """å®‰å…¨æ£€æŸ¥å™¨æµ‹è¯•"""

    @pytest.fixture
    def checker(self):
        return SafetyChecker()

    def _make_draft(self, steps=None, tools_used=None, parameters=None):
        return SkillDraft(
            name="test",
            description="test",
            steps=steps or [],
            tools_used=tools_used or [],
            parameters=parameters or {},
        )

    def test_safe_skill(self, checker):
        """å®‰å…¨æŠ€èƒ½é€šè¿‡æ£€æŸ¥"""
        draft = self._make_draft(
            steps=[{"order": 1, "action": "æŸ¥è¯¢æ•°æ®", "tool": "query", "params_template": {}}],
            tools_used=["query"],
        )
        result = checker.check(draft)
        assert result.is_safe is True

    def test_dangerous_rm_rf(self, checker):
        """æ£€æµ‹ rm -rf"""
        draft = self._make_draft(
            steps=[{"order": 1, "action": "rm -rf /tmp", "tool": "shell"}],
            tools_used=["shell"],
        )
        result = checker.check(draft)
        assert result.is_safe is False
        assert "rm -rf" in result.reason

    def test_dangerous_drop_table(self, checker):
        """æ£€æµ‹ DROP TABLE"""
        draft = self._make_draft(
            steps=[{"order": 1, "action": "DROP TABLE users", "tool": "sql"}],
            tools_used=["sql"],
        )
        result = checker.check(draft)
        assert result.is_safe is False

    def test_dangerous_eval(self, checker):
        """æ£€æµ‹ eval"""
        draft = self._make_draft(
            steps=[{"order": 1, "action": "eval(user_input)", "tool": "exec"}],
            tools_used=["exec"],
        )
        result = checker.check(draft)
        assert result.is_safe is False

    def test_dangerous_tool(self, checker):
        """æ£€æµ‹å±é™©å·¥å…·"""
        draft = self._make_draft(
            steps=[{"order": 1, "action": "æ‰§è¡Œ", "tool": "shell_exec"}],
            tools_used=["shell_exec"],
        )
        result = checker.check(draft)
        assert result.is_safe is False

    def test_dangerous_os_system(self, checker):
        """æ£€æµ‹ os.system"""
        draft = self._make_draft(
            steps=[{"order": 1, "action": "os.system('ls')", "tool": "py"}],
            tools_used=["py"],
        )
        result = checker.check(draft)
        assert result.is_safe is False

    def test_dangerous_subprocess(self, checker):
        """æ£€æµ‹ subprocess"""
        draft = self._make_draft(
            steps=[{"order": 1, "action": "subprocess.run(['ls'])", "tool": "py"}],
            tools_used=["py"],
        )
        result = checker.check(draft)
        assert result.is_safe is False
```

### 6. EvolvedSkillRepository æµ‹è¯•ï¼ˆTypeScriptï¼‰

```typescript
// apps/api/tests/repositories/evolved-skill.repository.test.ts

// æµ‹è¯•è¦ç‚¹ï¼š
// - findByIdAndOrg: æ­£ç¡®è¿”å› + org_id éš”ç¦»
// - findByOrg: åˆ†é¡µ + è¿‡æ»¤
// - create: æ­£ç¡®å†™å…¥æ‰€æœ‰å­—æ®µï¼ŒJSONB ä½¿ç”¨ sql.json()
// - update: ä¹è§‚é”å†²çªè¿”å› 409
// - softDelete: è®¾ç½® deleted_at è€Œéç‰©ç†åˆ é™¤
// - findByEmbedding: å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢ + é˜ˆå€¼è¿‡æ»¤
// - updateReviewStatus: çŠ¶æ€æµè½¬æ­£ç¡®
// - incrementUseCount: åŸå­æ›´æ–°
// - incrementSuccessCount: åŸå­æ›´æ–°
```

---

## æµ‹è¯•ç›®å½•ç»“æ„

```
runtime/tests/evolution/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ conftest.py                 # pytest fixtures
â”œâ”€â”€ test_models.py              # SkillDraft æ•°æ®ç±»æµ‹è¯•
â”œâ”€â”€ test_engine.py              # _should_evolve è§¦å‘æ¡ä»¶æµ‹è¯•
â”œâ”€â”€ test_extract.py             # _extract æå–æµ‹è¯•
â”œâ”€â”€ test_validate.py            # _validate éªŒè¯æµ‹è¯•
â”œâ”€â”€ test_safety.py              # SafetyChecker å®‰å…¨æ£€æŸ¥æµ‹è¯•
â”œâ”€â”€ test_register.py            # _register æ³¨å†Œæµ‹è¯•
â””â”€â”€ test_index.py               # _index ç´¢å¼•æµ‹è¯•

apps/api/tests/
â”œâ”€â”€ repositories/
â”‚   â””â”€â”€ evolved-skill.repository.test.ts
â””â”€â”€ services/
    â””â”€â”€ evolved-skill.service.test.ts
```

---

## ä¿®å¤æ¸…å•

- [ ] åˆ›å»º `runtime/tests/evolution/` ç›®å½•å’Œ `conftest.py`
- [ ] åˆ›å»º `test_models.py` â€” SkillDraft æµ‹è¯•ï¼ˆ6 ä¸ªç”¨ä¾‹ï¼‰
- [ ] åˆ›å»º `test_engine.py` â€” _should_evolve æµ‹è¯•ï¼ˆ9 ä¸ªç”¨ä¾‹ï¼‰
- [ ] åˆ›å»º `test_extract.py` â€” _extract æµ‹è¯•ï¼ˆ3 ä¸ªç”¨ä¾‹ï¼‰
- [ ] åˆ›å»º `test_validate.py` â€” _validate æµ‹è¯•ï¼ˆ5 ä¸ªç”¨ä¾‹ï¼‰
- [ ] åˆ›å»º `test_safety.py` â€” SafetyChecker æµ‹è¯•ï¼ˆ7 ä¸ªç”¨ä¾‹ï¼‰
- [ ] åˆ›å»º `test_register.py` â€” _register æµ‹è¯•
- [ ] åˆ›å»º `test_index.py` â€” _index æµ‹è¯•
- [ ] åˆ›å»º `evolved-skill.repository.test.ts` â€” Repository æµ‹è¯•
- [ ] åˆ›å»º `evolved-skill.service.test.ts` â€” Service æµ‹è¯•
- [ ] è¿è¡Œæµ‹è¯•å¹¶ç¡®ä¿é€šè¿‡
- [ ] æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡ >= 80%

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] Runtime ä¾§æµ‹è¯•è¦†ç›–ç‡ >= 80%
- [ ] API ä¾§æµ‹è¯•è¦†ç›–ç‡ >= 80%
- [ ] å¤–éƒ¨ä¾èµ–å…¨éƒ¨ mockï¼ˆLLMã€æ•°æ®åº“ã€Redisï¼‰
- [ ] æµ‹è¯•å¯ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å¤–éƒ¨ç¯å¢ƒ
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•è§„èŒƒ](.claude/rules/testing.md)
- [PRD: è¿›åŒ– Runtime å¼•æ“](.agents/PRDS/evolution-runtime-engine.md)
- [PRD: è¿›åŒ– API](.agents/PRDS/evolution-api.md)
