# 最近 2 次提交 Code Review（2026-02-14）

## 审查对象
1. `a883479` `refactor: 规范化端口与 URL 环境变量命名`
2. `c071a0c` `feat: 实现 SubAgent 委派链路打通（Task 0-7）`

## 结论摘要
- High: 1
- Medium: 3
- 主要风险：SubAgent MCP 鉴权参数丢失、部署兼容性回归、跨平台脚本兼容、性能退化

## 发现清单（按严重级别）

### 1. [High] SubAgent 委派链路丢失 `auth_config`，导致需要鉴权的 MCP 无法连接
- 位置：
  - `runtime/src/server/routes.py:203`
  - `runtime/src/orchestrator/context.py:50`
  - `runtime/src/agents/delegator.py:160`
  - `runtime/src/server/routes.py:67`
- 问题描述：
  - API 输入模型 `McpServerInput` 支持 `auth_config`，且 `_connect_single_mcp` 依赖它构造鉴权头。
  - 但 SubAgent 路径在 `McpServerInput -> McpServerDefinition -> McpServerInput` 转换过程中未透传 `auth_config`。
- 影响：
  - 子 Agent 访问受保护 MCP 服务时连接失败或能力降级。
- 建议修复：
  - 在 `McpServerDefinition` 增加 `auth_config` 字段；
  - 在 `routes.py` 构建 `sub_agents` 时保留该字段；
  - 在 `delegator.py` 重建 `McpServerInput` 时透传该字段。

### 2. [Medium] 端口变量重命名后未兼容 `PORT`，存在部署回归风险
- 位置：
  - `apps/api/src/constants/config.ts:42`
- 问题描述：
  - 代码仅读取 `API_PORT`，忽略常见平台默认注入的 `PORT`。
- 影响：
  - 在仅提供 `PORT` 的环境中 API 可能绑定错误端口，导致健康检查失败。
- 建议修复：
  - 采用兼容读取顺序：`API_PORT ?? PORT ?? 3001`。

### 3. [Medium] `package.json` 使用 POSIX 变量展开，Windows/npm 环境不可用
- 位置：
  - `apps/web/package.json:6`
  - `runtime/package.json:6`
- 问题描述：
  - 脚本使用 `${WEB_PORT:-3000}` / `${RUNTIME_PORT:-8801}`。
- 影响：
  - 在 Windows 默认 `cmd` 下变量不展开，启动命令失败。
- 建议修复：
  - 使用 `cross-env` 或 Node 启动脚本统一处理环境变量。

### 4. [Medium] SubAgent 候选池构建存在串行 N+1 查询，可能显著增加首包延迟
- 位置：
  - `apps/api/src/services/agent.service.ts:341`
  - `apps/api/src/services/agent.service.ts:352`
  - `apps/api/src/services/agent.service.ts:355`
- 问题描述：
  - 候选 Agent、每个 Skill definition/package、每个 Agent MCP 拉取均串行执行。
- 影响：
  - 候选 Agent 和 Skill 增多时，对话请求延迟线性上升。
- 建议修复：
  - 批量查询 + 并行拉取；
  - 对候选池大小设置明确上限并考虑缓存。

## 开放问题
1. 产品上是否要求 SubAgent 访问“需要鉴权”的 MCP？若是，该链路需优先修复。  
2. 环境变量重命名是否需要过渡兼容窗口（同时支持旧变量）？

## 备注
- 本文档基于静态代码审查。
- 未执行自动化测试与性能压测。
