# ä»»åŠ¡ï¼šè¿›åŒ–ç³»ç»Ÿ â€” æ•°æ®åº“è¿ç§»

**ä¼˜å…ˆçº§**: ğŸ”´ P0 - ä¸¥é‡
**ç±»å‹**: åŠŸèƒ½å®ç°
**é¢„ä¼°å·¥æ—¶**: 1-2 å¤©
**å½±å“èŒƒå›´**: docs/sql/ã€apps/api/src/repositories/ã€packages/shared-types/

---

## é—®é¢˜æè¿°

è¿›åŒ–ç³»ç»Ÿéœ€è¦ä¸¤å¼ æ ¸å¿ƒæ•°æ®è¡¨ï¼š`evolved_skills`ï¼ˆè¿›åŒ–æŠ€èƒ½ï¼‰å’Œ `evolution_logs`ï¼ˆè¿›åŒ–æ—¥å¿—ï¼‰ï¼Œä»¥åŠå¯¹åº”çš„ç´¢å¼•ã€çº¦æŸå’Œ Repository å±‚å®ç°ã€‚è¿™æ˜¯è¿›åŒ–ç³»ç»Ÿæ‰€æœ‰åç»­åŠŸèƒ½çš„åŸºç¡€ä¾èµ–ã€‚

---

## è¯¦ç»†å®ç°

### 1. åˆ›å»º 014_evolved_skills.sql

```sql
-- docs/sql/014_evolved_skills.sql
-- è¿›åŒ–æŠ€èƒ½è¡¨

CREATE TABLE IF NOT EXISTS evolved_skills (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL,                    -- æ‰€å±ç»„ç»‡
    agent_id UUID NOT NULL,                  -- äº§ç”Ÿæ­¤æŠ€èƒ½çš„ Agent
    session_id UUID NOT NULL,                -- äº§ç”Ÿæ­¤æŠ€èƒ½çš„ä¼šè¯

    -- æŠ€èƒ½å®šä¹‰
    name VARCHAR(200) NOT NULL,              -- æŠ€èƒ½åç§°
    description TEXT NOT NULL,               -- æŠ€èƒ½æè¿°
    trigger_keywords TEXT[] DEFAULT '{}',    -- è§¦å‘å…³é”®è¯
    steps JSONB NOT NULL,                    -- æ‰§è¡Œæ­¥éª¤åºåˆ—
    tools_used TEXT[] DEFAULT '{}',          -- ä½¿ç”¨çš„å·¥å…·åˆ—è¡¨
    parameters JSONB DEFAULT '{}',           -- å¯å‚æ•°åŒ–çš„å˜é‡
    preconditions JSONB DEFAULT '{}',        -- å‰ç½®æ¡ä»¶
    expected_outcome TEXT,                   -- é¢„æœŸç»“æœ

    -- å‘é‡ç´¢å¼•
    embedding VECTOR(1536),                  -- æŠ€èƒ½æè¿°çš„å‘é‡è¡¨ç¤º

    -- è´¨é‡ä¸çŠ¶æ€
    quality_score FLOAT DEFAULT 0,           -- è´¨é‡è¯„åˆ† (0-1)
    reusability_score FLOAT DEFAULT 0,       -- å¤ç”¨ä»·å€¼è¯„åˆ† (0-1)
    status VARCHAR(20) DEFAULT 'pending_review'
        CHECK (status IN ('pending_review', 'approved', 'rejected', 'auto_approved', 'deprecated')),

    -- ä½¿ç”¨ç»Ÿè®¡
    use_count INTEGER DEFAULT 0,             -- è¢«å¤ç”¨æ¬¡æ•°
    success_count INTEGER DEFAULT 0,         -- å¤ç”¨æˆåŠŸæ¬¡æ•°
    last_used_at TIMESTAMPTZ,                -- æœ€åä½¿ç”¨æ—¶é—´

    -- å®¡æ ¸
    reviewed_by UUID,                        -- å®¡æ ¸äºº
    reviewed_at TIMESTAMPTZ,                 -- å®¡æ ¸æ—¶é—´
    review_comment TEXT,                     -- å®¡æ ¸æ„è§

    -- å®¡è®¡å­—æ®µ
    version INTEGER NOT NULL DEFAULT 1,      -- ç‰ˆæœ¬å·ï¼ˆä¹è§‚é”ï¼‰
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    deleted_at TIMESTAMPTZ,                  -- è½¯åˆ é™¤
    deleted_by UUID                          -- åˆ é™¤äºº
);

-- ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_evolved_skills_org ON evolved_skills(org_id);
CREATE INDEX IF NOT EXISTS idx_evolved_skills_agent ON evolved_skills(agent_id);
CREATE INDEX IF NOT EXISTS idx_evolved_skills_status ON evolved_skills(status);
CREATE INDEX IF NOT EXISTS idx_evolved_skills_quality ON evolved_skills(quality_score DESC);
CREATE INDEX IF NOT EXISTS idx_evolved_skills_embedding ON evolved_skills
    USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
CREATE INDEX IF NOT EXISTS idx_evolved_skills_use_count ON evolved_skills(use_count DESC);
CREATE INDEX IF NOT EXISTS idx_evolved_skills_org_status ON evolved_skills(org_id, status, created_at DESC);
```

### 2. åˆ›å»º 015_evolution_logs.sql

```sql
-- docs/sql/015_evolution_logs.sql
-- è¿›åŒ–æ—¥å¿—è¡¨

CREATE TABLE IF NOT EXISTS evolution_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    org_id UUID NOT NULL,
    agent_id UUID NOT NULL,
    session_id UUID NOT NULL,

    -- è¿›åŒ–è¿‡ç¨‹
    stage VARCHAR(20) NOT NULL               -- EXTRACT/VALIDATE/REGISTER/INDEX
        CHECK (stage IN ('extract', 'validate', 'register', 'index')),
    status VARCHAR(20) NOT NULL              -- é˜¶æ®µçŠ¶æ€
        CHECK (status IN ('started', 'completed', 'failed', 'skipped')),

    -- ç»“æœ
    evolved_skill_id UUID,                   -- äº§ç”Ÿçš„æŠ€èƒ½IDï¼ˆå¦‚æœ‰ï¼‰
    input_data JSONB,                        -- è¾“å…¥æ•°æ®
    output_data JSONB,                       -- è¾“å‡ºæ•°æ®
    error_message TEXT,                      -- é”™è¯¯ä¿¡æ¯

    -- æŒ‡æ ‡
    duration_ms INTEGER,                     -- è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
    tokens_used INTEGER DEFAULT 0,           -- Token æ¶ˆè€—

    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_evolution_logs_org ON evolution_logs(org_id);
CREATE INDEX IF NOT EXISTS idx_evolution_logs_agent ON evolution_logs(agent_id);
CREATE INDEX IF NOT EXISTS idx_evolution_logs_session ON evolution_logs(session_id);
CREATE INDEX IF NOT EXISTS idx_evolution_logs_stage ON evolution_logs(stage);
CREATE INDEX IF NOT EXISTS idx_evolution_logs_skill ON evolution_logs(evolved_skill_id);
CREATE INDEX IF NOT EXISTS idx_evolution_logs_created ON evolution_logs(created_at DESC);
```

### 3. shared-types ç±»å‹å®šä¹‰

```typescript
// packages/shared-types/src/evolution.ts

export interface EvolvedSkill {
  id: string;
  orgId: string;
  agentId: string;
  sessionId: string;
  name: string;
  description: string;
  triggerKeywords: string[];
  steps: EvolvedSkillStep[];
  toolsUsed: string[];
  parameters: Record<string, EvolvedSkillParam>;
  preconditions: Record<string, unknown>;
  expectedOutcome: string | null;
  embedding: number[] | null;
  qualityScore: number;
  reusabilityScore: number;
  status: EvolvedSkillStatus;
  useCount: number;
  successCount: number;
  lastUsedAt: string | null;
  reviewedBy: string | null;
  reviewedAt: string | null;
  reviewComment: string | null;
  version: number;
  createdAt: string;
  updatedAt: string;
  deletedAt: string | null;
  deletedBy: string | null;
}

export type EvolvedSkillStatus =
  | 'pending_review'
  | 'approved'
  | 'rejected'
  | 'auto_approved'
  | 'deprecated';

export interface EvolvedSkillStep {
  order: number;
  action: string;
  tool: string;
  paramsTemplate: Record<string, unknown>;
}

export interface EvolvedSkillParam {
  type: string;
  description: string;
  required: boolean;
}

export interface EvolutionLog {
  id: string;
  orgId: string;
  agentId: string;
  sessionId: string;
  stage: EvolutionStage;
  status: EvolutionLogStatus;
  evolvedSkillId: string | null;
  inputData: Record<string, unknown> | null;
  outputData: Record<string, unknown> | null;
  errorMessage: string | null;
  durationMs: number | null;
  tokensUsed: number;
  createdAt: string;
}

export type EvolutionStage = 'extract' | 'validate' | 'register' | 'index';
export type EvolutionLogStatus = 'started' | 'completed' | 'failed' | 'skipped';

export interface EvolutionConfig {
  enabled: boolean;
  autoApprove: boolean;
  minQualityScore: number;
  maxEvolvePerHour: number;
  cooldownMinutes: number;
}
```

### 4. EvolvedSkillRepository

```typescript
// apps/api/src/repositories/evolved-skill.repository.ts

// æ ‡å‡† Repository æ¥å£å®ç°:
// - findById(id: string): Promise<EvolvedSkill | null>
// - findByIdAndOrg(id: string, orgId: string): Promise<EvolvedSkill | null>
// - findByOrg(orgId: string, options: PaginationOptions): Promise<PaginatedResult<EvolvedSkill>>
// - create(input: CreateEvolvedSkillInput): Promise<EvolvedSkill>
// - update(id: string, input: UpdateEvolvedSkillInput, version: number): Promise<EvolvedSkill>
// - softDelete(id: string, deletedBy: string): Promise<void>
// - countByOrg(orgId: string): Promise<number>
// - findByIds(ids: string[]): Promise<EvolvedSkill[]>

// æ‰©å±•æ–¹æ³•:
// - findByEmbedding(embedding: number[], orgId: string, limit: number, threshold: number): Promise<EvolvedSkillWithScore[]>
// - findByStatus(orgId: string, status: EvolvedSkillStatus, options: PaginationOptions): Promise<PaginatedResult<EvolvedSkill>>
// - updateReviewStatus(id: string, action: 'approve' | 'reject', reviewedBy: string, comment?: string): Promise<EvolvedSkill>
// - incrementUseCount(id: string): Promise<void>
// - incrementSuccessCount(id: string): Promise<void>
// - findDeprecationCandidates(orgId: string): Promise<EvolvedSkill[]>
```

---

## ä¿®å¤æ¸…å•

- [ ] åˆ›å»º `docs/sql/014_evolved_skills.sql` â€” evolved_skills è¡¨å®Œæ•´ DDL
- [ ] åˆ›å»º `docs/sql/015_evolution_logs.sql` â€” evolution_logs è¡¨å®Œæ•´ DDL
- [ ] åˆ›å»º `packages/shared-types/src/evolution.ts` â€” ç±»å‹å®šä¹‰
- [ ] æ›´æ–° `packages/shared-types/src/index.ts` â€” å¯¼å‡ºè¿›åŒ–ç±»å‹
- [ ] æ›´æ–° `packages/shared-types/src/dto.ts` â€” æ–°å¢è¿›åŒ–ç›¸å…³ DTO
- [ ] åˆ›å»º `apps/api/src/repositories/evolved-skill.repository.ts`
- [ ] åˆ›å»º `apps/api/src/repositories/evolution-log.repository.ts`
- [ ] éªŒè¯è¿ç§»è„šæœ¬å¹‚ç­‰æ€§ï¼ˆ`IF NOT EXISTS`ï¼‰
- [ ] éªŒè¯ JSONB å­—æ®µä½¿ç”¨ `sql.json()` å†™å…¥
- [ ] éªŒè¯æ‰€æœ‰æŸ¥è¯¢åŒ…å« `org_id` ç§Ÿæˆ·éš”ç¦»

---

## å®Œæˆæ ‡å‡†

- [ ] è¿ç§»è„šæœ¬å¯é‡å¤æ‰§è¡Œæ— æŠ¥é”™
- [ ] pgvector å‘é‡ç´¢å¼•æ­£å¸¸å·¥ä½œ
- [ ] Repository æ‰€æœ‰æ ‡å‡†æ–¹æ³•å®ç°å®Œæ•´
- [ ] ä¹è§‚é”å’Œè½¯åˆ é™¤æœºåˆ¶æ­£å¸¸
- [ ] shared-types ç±»å‹å®šä¹‰å®Œæ•´ä¸”å­—æ®µä½¿ç”¨ camelCase
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [è¿›åŒ–ç³»ç»Ÿè®¾è®¡](docs/design/EVOLUTION.md) ç¬¬ 4 èŠ‚
- [æ•°æ®åº“è§„èŒƒ](.claude/rules/database.md)
- [PRD: è¿›åŒ–æ•°æ®æ¨¡å‹](.agents/PRDS/evolution-data-model.md)
