# 代码审查问题清单（2026-02-14）

## 审查范围
- API: `apps/api/src/**`
- Runtime: `runtime/src/**`
- 路由与中间件、认证链路、技能上传链路、MCP 客户端

## 发现摘要
- Critical: 1
- High: 3
- Medium: 4
- 主要风险面：认证失效、敏感信息泄露、上传链路安全、权限语义回归、流式健壮性

## 详细发现（按严重级别）

### 1. [Critical] 登出后 Token 未真正失效，刷新令牌可继续换新 Token
- 位置:
  - `apps/api/src/routes/v1/auth.ts:281`
  - `apps/api/src/services/auth.service.ts:305`
- 问题描述:
  - `/auth/logout` 只传入 `userId`，未传当前 access token / refresh token 给 `authService.logout()`。
  - `refreshToken()` 未检查 refresh token 是否已被拉黑（blacklist）。
- 影响:
  - 用户“登出”后，已泄露 token 仍可继续访问或续期，存在会话失效逻辑绕过。
- 修复建议:
  - 在路由层提取并传递当前 token（以及可选 refresh token）给 `logout()`。
  - 在 `refreshToken()` 中增加 `isBlacklisted(token)` 校验。

### 2. [High] 统一错误日志输出完整请求体，可能泄露密码/令牌/密钥
- 位置:
  - `apps/api/src/middleware/errorHandler.ts:175`
- 问题描述:
  - 错误日志直接记录 `req.body`、`req.query`。
- 影响:
  - 登录、重置密码、API Key 等敏感字段可能进入日志系统。
- 修复建议:
  - 对敏感字段做脱敏（如 `password`, `token`, `refreshToken`, `authorization`, `apiKey`）。
  - 优先白名单日志策略（仅记录必要字段）。

### 3. [High] 上传包先解压后校验大小，存在压缩炸弹与磁盘耗尽风险
- 位置:
  - `apps/api/src/services/skill-upload.service.ts:100`
  - `apps/api/src/services/skill-upload.service.ts:107`
  - `apps/api/src/utils/archive-extractor.ts:61`
  - `apps/api/src/utils/archive-extractor.ts:121`
- 问题描述:
  - 先完整解压，再计算目录总大小并判断上限。
- 影响:
  - 小体积恶意压缩包可在解压阶段占满磁盘/IO，造成 DoS。
- 修复建议:
  - 解压过程中增加硬限制：总解压字节、文件数量、单文件大小、目录深度。
  - 超限立即中断并清理。

### 4. [High] `skill-definitions` 管理接口权限表达式错误（admin 被误拒）
- 位置:
  - `apps/api/src/routes/v1/skill-definitions.ts:75`
  - `apps/api/src/routes/v1/skill-definitions.ts:126`
  - `apps/api/src/routes/v1/skill-definitions.ts:178`
  - `apps/api/src/routes/v1/skill-definitions.ts:268`
  - `apps/api/src/routes/v1/skill-definitions.ts:302`
  - `apps/api/src/routes/v1/skill-definitions.ts:327`
  - `apps/api/src/routes/v1/skill-definitions.ts:365`
  - 对照权限签发：`apps/api/src/services/auth.service.ts:145`
- 问题描述:
  - 代码使用 `requirePermission('admin')`，但系统权限为 `resource:action`（如 `skills:*`）。
  - `admin` 角色不具备裸权限字符串 `admin`。
- 影响:
  - 标记“仅管理员”的接口对 `admin` 角色不可用，形成权限回归。
- 修复建议:
  - 改为 `requireRole('admin', 'owner')`，或统一引入 `admin:*` 权限语义。

### 5. [Medium] 上传中间件可能多次调用 `next()`
- 位置:
  - `apps/api/src/middleware/upload.ts:151`
  - `apps/api/src/middleware/upload.ts:171`
  - `apps/api/src/middleware/upload.ts:216`
  - `apps/api/src/middleware/upload.ts:224`
- 问题描述:
  - 错误分支调用 `next(err)` 后，`finish`/`tryFinalize` 仍可能再次调用 `next()`。
- 影响:
  - 可能导致重复响应、`headers already sent`、错误链路污染。
- 修复建议:
  - 引入一次性终态标记（例如 `completed`），保证 `next()` 只触发一次。

### 6. [Medium] Tool arguments 直接 `JSON.parse`，异常会中断对话
- 位置:
  - `apps/api/src/services/chat.service.ts:642`
  - `apps/api/src/services/chat.service.ts:721`
  - `apps/api/src/services/chat.service.ts:766`
- 问题描述:
  - 对模型返回的 `toolCall.function.arguments` 无防护直接解析。
- 影响:
  - 非法 JSON 会抛异常，打断 SSE 对话流程。
- 修复建议:
  - 使用安全解析（try/catch + fallback `{}` + 错误事件上报）。

### 7. [Medium] MCP 连接失败场景未统一关闭 `AsyncExitStack`
- 位置:
  - `runtime/src/mcp/client.py:112`
  - `runtime/src/mcp/client.py:176`
  - `runtime/src/mcp/client.py:189`
- 问题描述:
  - `__aenter__()` 之后如果初始化/握手失败，异常路径未保证 `aclose()`。
- 影响:
  - 重复失败后可能造成资源泄漏（句柄/协程上下文残留）。
- 修复建议:
  - 在 `try/except/finally` 中确保未接管的 `exit_stack` 被关闭。

### 8. [Medium] CORS 配置 `origin=*` + `credentials=true` 组合不规范
- 位置:
  - `apps/api/src/index.ts:42`
  - `apps/api/src/index.ts:43`
- 问题描述:
  - 浏览器对该组合存在规范限制，行为不一致。
- 影响:
  - 跨域认证请求可能在不同环境表现不一致，出现登录态问题。
- 修复建议:
  - 使用明确 origin 白名单；启用 credentials 时不要使用 `*`。

## 测试覆盖缺口
- `logout` 服务层有测试，但路由层未验证是否传 token 到 `logout()`：
  - `apps/api/src/__tests__/auth.service.test.ts:292`
  - `apps/api/src/routes/v1/auth.ts:279`
- 未见针对 `requirePermission('admin')` 权限语义回归的路由测试。
- 未见上传中间件“重复 next”与压缩炸弹限制的专项测试。

## 建议修复优先级
1. 先修复认证失效链路（问题 1）。
2. 立即处理敏感日志泄露（问题 2）。
3. 修复上传链路 DoS 风险（问题 3）。
4. 修复管理员权限语义回归（问题 4）。
5. 补齐健壮性问题与回归测试（问题 5~8）。

## 备注
- 本文档基于静态审查结论，未执行全量自动化测试与压力测试。
