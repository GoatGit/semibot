# ä»»åŠ¡ï¼šå¸¸é‡å®šä¹‰è§„èŒƒåŒ–

**ä¼˜å…ˆçº§**: ğŸŸ¡ P1 - é«˜ä¼˜å…ˆçº§
**ç±»å‹**: ä»£ç è´¨é‡
**é¢„ä¼°å·¥æ—¶**: 2-3 å°æ—¶
**å½±å“èŒƒå›´**: å¤šä¸ª Service æ–‡ä»¶

---

## é—®é¢˜æè¿°

å¤šä¸ª Service æ–‡ä»¶ä¸­å­˜åœ¨å±€éƒ¨å¸¸é‡å®šä¹‰ï¼Œè¿åäº†ç¼–ç è§„èŒƒã€‚æ‰€æœ‰å¸¸é‡åº”è¯¥é›†ä¸­å®šä¹‰åœ¨ `constants/config.ts` ä¸­ã€‚

---

## è¿è§„ä½ç½®

### 1. agent.service.ts
```typescript
// ç¬¬ 97 è¡Œ
const MAX_AGENTS_PER_ORG = 100
```

### 2. skill.service.ts
```typescript
// ç¬¬ 137 è¡Œ
const MAX_SKILLS_PER_ORG = 50
```

### 3. mcp.service.ts
```typescript
// ç¬¬ 100 è¡Œ
const MAX_MCP_SERVERS_PER_ORG = 20
```

### 4. tool.service.ts
```typescript
// ç¬¬ 83 è¡Œ
const MAX_TOOLS_PER_ORG = 100
```

### 5. auth.service.ts
```typescript
// ç¬¬ 85 è¡Œ
const PASSWORD_RESET_TTL_SECONDS = 15 * 60
```

### 6. skill-retry-rollback.service.ts
```typescript
// ç¬¬ 34-35 è¡Œ
const DEFAULT_MAX_RETRIES = 3
const DEFAULT_RETRY_DELAY = 1000
```

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. åœ¨ config.ts ä¸­é›†ä¸­å®šä¹‰

```typescript
// apps/api/src/constants/config.ts

// ============================================================
// èµ„æºé™åˆ¶
// ============================================================

/** æ¯ä¸ªç»„ç»‡æœ€å¤šå¯åˆ›å»ºçš„ Agent æ•°é‡ */
export const MAX_AGENTS_PER_ORG = 100

/** æ¯ä¸ªç»„ç»‡æœ€å¤šå¯åˆ›å»ºçš„ Skill æ•°é‡ */
export const MAX_SKILLS_PER_ORG = 50

/** æ¯ä¸ªç»„ç»‡æœ€å¤šå¯åˆ›å»ºçš„ Tool æ•°é‡ */
export const MAX_TOOLS_PER_ORG = 100

/** æ¯ä¸ªç»„ç»‡æœ€å¤šå¯é…ç½®çš„ MCP æœåŠ¡å™¨æ•°é‡ */
export const MAX_MCP_SERVERS_PER_ORG = 20

/** æ¯ä¸ªç»„ç»‡æœ€å¤šå¯åˆ›å»ºçš„ Session æ•°é‡ */
export const MAX_SESSIONS_PER_ORG = 1000

/** æ¯ä¸ªç»„ç»‡æœ€å¤šå¯åˆ›å»ºçš„ Memory æ•°é‡ */
export const MAX_MEMORIES_PER_ORG = 10000

// ============================================================
// è®¤è¯ç›¸å…³
// ============================================================

/** å¯†ç é‡ç½® Token æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼š15 åˆ†é’Ÿ */
export const PASSWORD_RESET_TOKEN_TTL_SECONDS = 15 * 60

/** å¯†ç é‡ç½®è¯·æ±‚é™æµï¼ˆç§’ï¼‰ï¼š1 åˆ†é’Ÿå†…åªèƒ½è¯·æ±‚ä¸€æ¬¡ */
export const PASSWORD_RESET_REQUEST_TTL_SECONDS = 60

/** JWT Access Token æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼š1 å°æ—¶ */
export const ACCESS_TOKEN_TTL_SECONDS = 60 * 60

/** JWT Refresh Token æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼š7 å¤© */
export const REFRESH_TOKEN_TTL_SECONDS = 7 * 24 * 60 * 60

// ============================================================
// é‡è¯•é…ç½®
// ============================================================

/** é»˜è®¤æœ€å¤§é‡è¯•æ¬¡æ•° */
export const DEFAULT_MAX_RETRIES = 3

/** é»˜è®¤é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ */
export const DEFAULT_RETRY_DELAY_MS = 1000

/** æœ€å¤§é‡è¯•å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ */
export const MAX_RETRY_DELAY_MS = 30000

/** é‡è¯•å»¶è¿Ÿå€æ•° */
export const RETRY_BACKOFF_MULTIPLIER = 2

// ============================================================
// Skill ç›¸å…³
// ============================================================

/** Skill å®‰è£…è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼š5 åˆ†é’Ÿ */
export const SKILL_INSTALL_TIMEOUT_MS = 5 * 60 * 1000

/** Skill æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼š30 ç§’ */
export const SKILL_EXECUTION_TIMEOUT_MS = 30 * 1000

/** ä¿ç•™çš„ Skill åŒ…ç‰ˆæœ¬æ•°é‡ */
export const SKILL_PACKAGE_KEEP_COUNT = 5
```

### 2. åœ¨ Service ä¸­å¯¼å…¥ä½¿ç”¨

```typescript
// apps/api/src/services/agent.service.ts

import {
  MAX_AGENTS_PER_ORG
} from '../constants/config'

export async function createAgent(orgId: string, data: CreateAgentInput): Promise<Agent> {
  // æ£€æŸ¥é…é¢
  const currentCount = await agentRepository.countByOrg(orgId)
  if (currentCount >= MAX_AGENTS_PER_ORG) {
    logger.warn('[AgentService] Agent æ•°é‡å·²è¾¾ä¸Šé™', {
      orgId,
      current: currentCount,
      limit: MAX_AGENTS_PER_ORG
    })
    throw createError(QUOTA_EXCEEDED, `Agent æ•°é‡å·²è¾¾ä¸Šé™ (${MAX_AGENTS_PER_ORG})`)
  }

  // ... åˆ›å»ºé€»è¾‘
}
```

```typescript
// apps/api/src/services/skill-retry-rollback.service.ts

import {
  DEFAULT_MAX_RETRIES,
  DEFAULT_RETRY_DELAY_MS,
  MAX_RETRY_DELAY_MS,
  RETRY_BACKOFF_MULTIPLIER
} from '../constants/config'

export async function retrySkillInstall(
  skillId: string,
  options: RetryOptions = {}
): Promise<void> {
  const maxRetries = options.maxRetries ?? DEFAULT_MAX_RETRIES
  const retryDelay = options.retryDelay ?? DEFAULT_RETRY_DELAY_MS

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      await installSkill(skillId)
      return
    } catch (error) {
      if (attempt === maxRetries) {
        throw error
      }

      const delay = Math.min(
        retryDelay * Math.pow(RETRY_BACKOFF_MULTIPLIER, attempt - 1),
        MAX_RETRY_DELAY_MS
      )

      logger.warn('[SkillRetry] å®‰è£…å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•', {
        skillId,
        attempt,
        maxRetries,
        nextRetryIn: delay
      })

      await sleep(delay)
    }
  }
}
```

---

## ä¿®å¤æ¸…å•

### 1. æ·»åŠ å¸¸é‡å®šä¹‰
- [ ] åœ¨ `constants/config.ts` ä¸­æ·»åŠ èµ„æºé™åˆ¶å¸¸é‡
- [ ] åœ¨ `constants/config.ts` ä¸­æ·»åŠ è®¤è¯ç›¸å…³å¸¸é‡
- [ ] åœ¨ `constants/config.ts` ä¸­æ·»åŠ é‡è¯•é…ç½®å¸¸é‡
- [ ] ä¸ºæ¯ä¸ªå¸¸é‡æ·»åŠ æ³¨é‡Šè¯´æ˜

### 2. ä¿®æ”¹ Service æ–‡ä»¶
- [ ] `agent.service.ts` - å¯¼å…¥ `MAX_AGENTS_PER_ORG`
- [ ] `skill.service.ts` - å¯¼å…¥ `MAX_SKILLS_PER_ORG`
- [ ] `mcp.service.ts` - å¯¼å…¥ `MAX_MCP_SERVERS_PER_ORG`
- [ ] `tool.service.ts` - å¯¼å…¥ `MAX_TOOLS_PER_ORG`
- [ ] `auth.service.ts` - å¯¼å…¥è®¤è¯ç›¸å…³å¸¸é‡
- [ ] `skill-retry-rollback.service.ts` - å¯¼å…¥é‡è¯•é…ç½®å¸¸é‡

### 3. åˆ é™¤å±€éƒ¨å¸¸é‡
- [ ] åˆ é™¤å„æ–‡ä»¶ä¸­çš„å±€éƒ¨å¸¸é‡å®šä¹‰

---

## å¸¸é‡å‘½åè§„èŒƒ

| ç±»å‹ | å‘½åæ ¼å¼ | ç¤ºä¾‹ |
|------|----------|------|
| æ•°é‡é™åˆ¶ | `MAX_XXX_PER_YYY` | `MAX_AGENTS_PER_ORG` |
| æ—¶é—´ï¼ˆç§’ï¼‰ | `XXX_TTL_SECONDS` | `PASSWORD_RESET_TOKEN_TTL_SECONDS` |
| æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | `XXX_TIMEOUT_MS` | `SKILL_INSTALL_TIMEOUT_MS` |
| é»˜è®¤å€¼ | `DEFAULT_XXX` | `DEFAULT_MAX_RETRIES` |
| å€æ•°/æ¯”ä¾‹ | `XXX_MULTIPLIER` | `RETRY_BACKOFF_MULTIPLIER` |

---

## æµ‹è¯•éªŒè¯

```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å±€éƒ¨å¸¸é‡
grep -rn "const MAX_" apps/api/src/services --include="*.ts"
grep -rn "const DEFAULT_" apps/api/src/services --include="*.ts"

# è¿è¡Œæµ‹è¯•
cd apps/api
pnpm test
```

---

## å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰å¸¸é‡é›†ä¸­åœ¨ `constants/config.ts`
- [ ] æ‰€æœ‰å¸¸é‡éƒ½æœ‰æ³¨é‡Šè¯´æ˜
- [ ] Service æ–‡ä»¶ä¸­æ— å±€éƒ¨å¸¸é‡å®šä¹‰
- [ ] å¸¸é‡å‘½åç¬¦åˆè§„èŒƒ
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [ç¼–ç è§„èŒƒ - ç¦æ­¢ç¡¬ç¼–ç ](.claude/rules/coding-standards.md#ç¦æ­¢ç¡¬ç¼–ç å€¼å’Œé­”æ³•æ•°å­—)
- [ä»»åŠ¡ 02 - æ¶ˆé™¤ç¡¬ç¼–ç ](02-ç¼–ç è§„èŒƒ-æ¶ˆé™¤ç¡¬ç¼–ç .md)
