# ä»»åŠ¡ï¼šè¿›åŒ–ç³»ç»Ÿ â€” å®¡æ ¸ä¸æ²»ç†

**ä¼˜å…ˆçº§**: ğŸŸ¡ P1 - é‡è¦
**ç±»å‹**: åŠŸèƒ½å®ç°
**é¢„ä¼°å·¥æ—¶**: 2-3 å¤©
**å½±å“èŒƒå›´**: apps/api/src/services/ã€apps/api/src/jobs/ã€runtime/src/evolution/

---

## é—®é¢˜æè¿°

è¿›åŒ–ç³»ç»Ÿäº§ç”Ÿçš„æŠ€èƒ½éœ€è¦ç»è¿‡è´¨é‡æŠŠå…³æ‰èƒ½è¢«å¤ç”¨ã€‚éœ€è¦å®ç°äººå·¥å®¡æ ¸å·¥ä½œæµã€è‡ªåŠ¨å®¡æ‰¹é€»è¾‘ã€å®‰å…¨æ£€æŸ¥ã€è´¨é‡é€€åŒ–è‡ªåŠ¨å¤„ç†ï¼ˆä½æˆåŠŸç‡æŠ€èƒ½è‡ªåŠ¨åºŸå¼ƒï¼‰ï¼Œä»¥åŠå®šæ—¶æ¸…ç†ä»»åŠ¡ã€‚

---

## è¯¦ç»†å®ç°

### 1. å®¡æ ¸å·¥ä½œæµ Service

```typescript
// apps/api/src/services/evolution-governance.service.ts

import { logger } from '@/lib/logger';
import { createError } from '@/lib/errors';
import { EvolvedSkillRepository } from '@/repositories/evolved-skill.repository';

// è´¨é‡é€€åŒ–é˜ˆå€¼å¸¸é‡
const DEPRECATION_MIN_USE_COUNT = 5;
const DEPRECATION_MAX_SUCCESS_RATE = 0.5;
const STALE_SKILL_DAYS = 30;
const CONSECUTIVE_FAILURE_LIMIT = 3;

export class EvolutionGovernanceService {

  /**
   * è´¨é‡é€€åŒ–æ£€æŸ¥ â€” å®šæ—¶ä»»åŠ¡è°ƒç”¨
   */
  static async checkQualityDegradation(orgId: string): Promise<void> {
    // 1. ä½æˆåŠŸç‡è‡ªåŠ¨åºŸå¼ƒ
    const lowSuccessSkills = await EvolvedSkillRepository.findLowSuccessRate(
      orgId, DEPRECATION_MAX_SUCCESS_RATE, DEPRECATION_MIN_USE_COUNT
    );
    for (const skill of lowSuccessSkills) {
      await EvolvedSkillRepository.updateStatus(skill.id, 'deprecated');
      logger.warn(
        `[Governance] æŠ€èƒ½å› ä½æˆåŠŸç‡è‡ªåŠ¨åºŸå¼ƒ ` +
        `(id=${skill.id}, name=${skill.name}, ` +
        `successRate=${skill.successCount / skill.useCount}, ` +
        `useCount=${skill.useCount})`
      );
      // è§¦å‘ Webhook: evolution.skill_deprecated
    }

    // 2. é•¿æœŸæœªä½¿ç”¨æ ‡è®°å€™é€‰æ¸…ç†
    const staleSkills = await EvolvedSkillRepository.findStaleSkills(
      orgId, STALE_SKILL_DAYS
    );
    for (const skill of staleSkills) {
      logger.info(
        `[Governance] æŠ€èƒ½é•¿æœŸæœªä½¿ç”¨ï¼Œæ ‡è®°ä¸ºå€™é€‰æ¸…ç† ` +
        `(id=${skill.id}, name=${skill.name}, ` +
        `createdAt=${skill.createdAt})`
      );
      // å¯é€‰ï¼šè‡ªåŠ¨åºŸå¼ƒæˆ–ä»…æ ‡è®°
    }

    // 3. è¿ç»­å¤±è´¥ä¸´æ—¶ç¦ç”¨
    const consecutiveFailSkills = await EvolvedSkillRepository
      .findConsecutiveFailures(orgId, CONSECUTIVE_FAILURE_LIMIT);
    for (const skill of consecutiveFailSkills) {
      await EvolvedSkillRepository.updateStatus(skill.id, 'pending_review');
      logger.warn(
        `[Governance] æŠ€èƒ½è¿ç»­å¤ç”¨å¤±è´¥ï¼Œä¸´æ—¶ç¦ç”¨ç­‰å¾…å®¡æ ¸ ` +
        `(id=${skill.id}, name=${skill.name}, ` +
        `consecutiveFailures=${CONSECUTIVE_FAILURE_LIMIT})`
      );
    }
  }

  /**
   * è‡ªåŠ¨å®¡æ‰¹åˆ¤å®š â€” åœ¨ REGISTER é˜¶æ®µè°ƒç”¨
   */
  static shouldAutoApprove(
    qualityScore: number,
    evolutionConfig: { autoApprove?: boolean }
  ): boolean {
    return qualityScore >= 0.8 && (evolutionConfig.autoApprove ?? false);
  }
}
```

### 2. å®šæ—¶æ¸…ç†ä»»åŠ¡

```typescript
// apps/api/src/jobs/evolution-cleanup.job.ts

import { logger } from '@/lib/logger';
import { EvolutionGovernanceService } from '@/services/evolution-governance.service';

// æ¯æ—¥æ‰§è¡Œä¸€æ¬¡
const EVOLUTION_CLEANUP_CRON = '0 3 * * *'; // æ¯å¤©å‡Œæ™¨ 3 ç‚¹

export function registerEvolutionCleanupJob(scheduler: JobScheduler): void {
  scheduler.register({
    name: 'evolution-quality-cleanup',
    cron: EVOLUTION_CLEANUP_CRON,
    handler: async () => {
      logger.info('[Job] å¼€å§‹æ‰§è¡Œè¿›åŒ–è´¨é‡é€€åŒ–æ£€æŸ¥');
      const startTime = Date.now();

      try {
        // è·å–æ‰€æœ‰ç»„ç»‡ IDï¼ˆæˆ–æŒ‰éœ€è¿‡æ»¤ï¼‰
        const orgIds = await getActiveOrgIds();

        for (const orgId of orgIds) {
          await EvolutionGovernanceService.checkQualityDegradation(orgId);
        }

        const duration = Date.now() - startTime;
        logger.info(`[Job] è¿›åŒ–è´¨é‡é€€åŒ–æ£€æŸ¥å®Œæˆ (è€—æ—¶: ${duration}ms)`);
      } catch (error) {
        logger.error('[Job] è¿›åŒ–è´¨é‡é€€åŒ–æ£€æŸ¥å¤±è´¥', { error: (error as Error).message });
      }
    },
  });
}
```

### 3. å®‰å…¨æ£€æŸ¥æ¨¡å—ï¼ˆRuntime ä¾§ï¼‰

```python
# runtime/src/evolution/safety.py

from dataclasses import dataclass
from src.utils.logging import get_logger

logger = get_logger(__name__)

# å±é™©æ“ä½œæ¨¡å¼
DANGEROUS_ACTION_PATTERNS = [
    "rm -rf", "DROP TABLE", "DELETE FROM", "TRUNCATE TABLE",
    "os.system", "subprocess.run", "subprocess.call",
    "eval(", "exec(", "__import__",
    "shutil.rmtree", "os.remove", "os.unlink",
]

# éœ€è¦ç™½åå•çš„æ•æ„Ÿæ“ä½œ
SENSITIVE_OPERATIONS = [
    "send_email", "send_notification",
    "external_api_call", "webhook_trigger",
    "file_write", "database_write",
]

# å±é™©å·¥å…·é»‘åå•
DANGEROUS_TOOLS = [
    "shell_exec", "file_delete", "database_drop",
    "system_command", "raw_sql",
]


@dataclass
class SafetyResult:
    is_safe: bool
    reason: str = ""
    warnings: list[str] = None

    def __post_init__(self):
        if self.warnings is None:
            self.warnings = []


class EvolutionSafetyChecker:
    """è¿›åŒ–æŠ€èƒ½å®‰å…¨æ£€æŸ¥å™¨"""

    def __init__(self, whitelist: list[str] | None = None):
        self.whitelist = set(whitelist or [])

    def check(self, draft) -> SafetyResult:
        """å…¨é¢å®‰å…¨æ£€æŸ¥"""
        warnings = []

        # 1. æ£€æŸ¥æ­¥éª¤ä¸­çš„å±é™©æ¨¡å¼
        for step in draft.steps:
            action = str(step.get("action", ""))
            params = str(step.get("params_template", {}))
            combined = f"{action} {params}"

            for pattern in DANGEROUS_ACTION_PATTERNS:
                if pattern.lower() in combined.lower():
                    return SafetyResult(
                        is_safe=False,
                        reason=f"æ­¥éª¤åŒ…å«å±é™©æ“ä½œ: {pattern}"
                    )

        # 2. æ£€æŸ¥å±é™©å·¥å…·
        for tool in draft.tools_used:
            if tool in DANGEROUS_TOOLS:
                return SafetyResult(
                    is_safe=False,
                    reason=f"ä½¿ç”¨äº†å±é™©å·¥å…·: {tool}"
                )

        # 3. æ£€æŸ¥æ•æ„Ÿæ“ä½œï¼ˆéœ€ç™½åå•ï¼‰
        for step in draft.steps:
            tool = step.get("tool", "")
            action = step.get("action", "")
            for sensitive_op in SENSITIVE_OPERATIONS:
                if sensitive_op in tool or sensitive_op in action:
                    if sensitive_op not in self.whitelist:
                        warnings.append(
                            f"åŒ…å«æ•æ„Ÿæ“ä½œ '{sensitive_op}'ï¼Œå»ºè®®äººå·¥å®¡æ ¸"
                        )

        # 4. æ£€æŸ¥å‚æ•°æ³¨å…¥é£é™©
        for param_name, param_def in draft.parameters.items():
            param_type = param_def.get("type", "")
            if param_type not in ("string", "number", "boolean", "array", "object"):
                return SafetyResult(
                    is_safe=False,
                    reason=f"å‚æ•° '{param_name}' ç±»å‹ä¸åˆæ³•: {param_type}"
                )

        return SafetyResult(is_safe=True, warnings=warnings)
```

### 4. Repository æ‰©å±•æ–¹æ³•

```typescript
// apps/api/src/repositories/evolved-skill.repository.ts â€” æ–°å¢æ–¹æ³•

// æŸ¥æ‰¾ä½æˆåŠŸç‡æŠ€èƒ½
async findLowSuccessRate(
  orgId: string,
  maxSuccessRate: number,
  minUseCount: number
): Promise<EvolvedSkill[]> {
  return sql`
    SELECT * FROM evolved_skills
    WHERE org_id = ${orgId}
      AND status IN ('approved', 'auto_approved')
      AND use_count >= ${minUseCount}
      AND deleted_at IS NULL
      AND (success_count::float / use_count) < ${maxSuccessRate}
  `;
}

// æŸ¥æ‰¾é•¿æœŸæœªä½¿ç”¨æŠ€èƒ½
async findStaleSkills(orgId: string, staleDays: number): Promise<EvolvedSkill[]> {
  return sql`
    SELECT * FROM evolved_skills
    WHERE org_id = ${orgId}
      AND status IN ('approved', 'auto_approved')
      AND use_count = 0
      AND deleted_at IS NULL
      AND created_at < NOW() - INTERVAL '${staleDays} days'
  `;
}

// æŸ¥æ‰¾è¿ç»­å¤±è´¥æŠ€èƒ½ï¼ˆéœ€è¦é¢å¤–çš„å¤±è´¥è®°å½•è¡¨æˆ–å­—æ®µï¼‰
async findConsecutiveFailures(
  orgId: string,
  failureLimit: number
): Promise<EvolvedSkill[]> {
  // åŸºäº evolution_logs ä¸­çš„å¤ç”¨å¤±è´¥è®°å½•æŸ¥è¯¢
  ...
}
```

---

## ä¿®å¤æ¸…å•

- [ ] åˆ›å»º `apps/api/src/services/evolution-governance.service.ts` â€” è´¨é‡é€€åŒ–æ£€æŸ¥
- [ ] åˆ›å»º `apps/api/src/jobs/evolution-cleanup.job.ts` â€” å®šæ—¶æ¸…ç†ä»»åŠ¡
- [ ] åˆ›å»º `runtime/src/evolution/safety.py` â€” å®‰å…¨æ£€æŸ¥æ¨¡å—
- [ ] æ‰©å±• `EvolvedSkillRepository` â€” æ–°å¢ `findLowSuccessRate`ã€`findStaleSkills`ã€`findConsecutiveFailures`
- [ ] æ³¨å†Œå®šæ—¶ä»»åŠ¡åˆ° `apps/api/src/jobs/index.ts`
- [ ] å®ç°è‡ªåŠ¨å®¡æ‰¹åˆ¤å®šé€»è¾‘
- [ ] å®ç°ä½æˆåŠŸç‡è‡ªåŠ¨åºŸå¼ƒï¼ˆ`success_rate < 50%` ä¸” `use_count >= 5`ï¼‰
- [ ] å®ç°é•¿æœŸæœªä½¿ç”¨å€™é€‰æ¸…ç†ï¼ˆ`use_count = 0` ä¸”åˆ›å»ºè¶…è¿‡ 30 å¤©ï¼‰
- [ ] å®ç°è¿ç»­å¤±è´¥ä¸´æ—¶ç¦ç”¨ï¼ˆè¿ç»­ 3 æ¬¡å¤ç”¨å¤±è´¥ï¼‰
- [ ] æ‰€æœ‰é€€åŒ–æ“ä½œè®°å½•æ—¥å¿—
- [ ] æ‰€æœ‰æŸ¥è¯¢åŒ…å« `org_id` ç§Ÿæˆ·éš”ç¦»

---

## å®Œæˆæ ‡å‡†

- [ ] å®¡æ ¸å·¥ä½œæµçŠ¶æ€æµè½¬æ­£ç¡®
- [ ] è‡ªåŠ¨å®¡æ‰¹åœ¨æ»¡è¶³æ¡ä»¶æ—¶æ­£ç¡®è§¦å‘
- [ ] å®‰å…¨æ£€æŸ¥è¦†ç›–æ‰€æœ‰å±é™©æ“ä½œç±»å‹
- [ ] è´¨é‡é€€åŒ–è‡ªåŠ¨å¤„ç†é€»è¾‘æ­£ç¡®
- [ ] å®šæ—¶æ¸…ç†ä»»åŠ¡å¯æ­£å¸¸æ‰§è¡Œ
- [ ] æ‰€æœ‰è¾¹ç•Œæ£€æŸ¥æœ‰æ—¥å¿—
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [è¿›åŒ–ç³»ç»Ÿè®¾è®¡](docs/design/EVOLUTION.md) ç¬¬ 7 èŠ‚
- [å®‰å…¨è§„èŒƒ](.claude/rules/security.md)
- [PRD: è¿›åŒ–è´¨é‡æ²»ç†](.agents/PRDS/evolution-quality-governance.md)
