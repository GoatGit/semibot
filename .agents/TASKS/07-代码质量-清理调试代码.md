# ä»»åŠ¡ï¼šæ¸…ç†è°ƒè¯•ä»£ç 

**ä¼˜å…ˆçº§**: ğŸ”´ P0 - ä¸¥é‡
**ç±»å‹**: ä»£ç è´¨é‡
**é¢„ä¼°å·¥æ—¶**: 1-2 å°æ—¶
**å½±å“èŒƒå›´**: 1 ä¸ªæ–‡ä»¶ï¼ˆä¸»è¦ï¼‰ï¼Œå…¶ä»–æ–‡ä»¶å°‘é‡

---

## é—®é¢˜æè¿°

`agent.repository.ts` å­˜åœ¨å¤§é‡è°ƒè¯•æ—¥å¿—å’Œè°ƒè¯•å‡½æ•°ï¼Œå½±å“ä»£ç å¯è¯»æ€§å’Œæ€§èƒ½ã€‚è¿™äº›è°ƒè¯•ä»£ç åº”è¯¥åœ¨å¼€å‘å®Œæˆåç§»é™¤ã€‚

---

## è¿è§„ä½ç½®

**æ–‡ä»¶**: `apps/api/src/repositories/agent.repository.ts`

### 1. è°ƒè¯•æ—¥å¿—ï¼ˆ9 å¤„ï¼‰

```typescript
// ç¬¬ 118-122 è¡Œ
console.log('[AgentRepo] findByIdAndOrg - id:', id, 'orgId:', orgId)
console.log('[AgentRepo] findByIdAndOrg result length:', result.length)

// ç¬¬ 135-139 è¡Œ
console.log('[AgentRepo] debugFindByOrgId - orgId:', orgId)
console.log('[AgentRepo] debugFindByOrgId result length:', result.length)

// ç¬¬ 151 è¡Œ
console.log('[AgentRepo] findByOrg called with orgId:', orgId)

// ç¬¬ 197 è¡Œ
console.log('[AgentRepo] Executing basic query for orgId:', orgId)

// ç¬¬ 201 è¡Œ
console.log('[AgentRepo] Basic query result length:', result.length)

// ç¬¬ 208 è¡Œ
console.log('[AgentRepo] Count result:', countResult)

// ç¬¬ 214 è¡Œ
console.log('[AgentRepo] Returning result with', result.length, 'agents')
```

### 2. è°ƒè¯•å‡½æ•°

```typescript
// ç¬¬ 134-141 è¡Œ - åº”è¯¥åˆ é™¤
export async function debugFindByOrgId(orgId: string): Promise<AgentRow[]> {
  console.log('[AgentRepo] debugFindByOrgId - orgId:', orgId)
  const result = await sql`SELECT * FROM agents WHERE org_id = ${orgId}`
  console.log('[AgentRepo] debugFindByOrgId result length:', result.length)
  return result as unknown as AgentRow[]
}
```

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. åˆ é™¤æ‰€æœ‰è°ƒè¯•æ—¥å¿—

```typescript
// âŒ åˆ é™¤è¿™äº›è¡Œ
console.log('[AgentRepo] findByIdAndOrg - id:', id, 'orgId:', orgId)
console.log('[AgentRepo] findByIdAndOrg result length:', result.length)
// ... å…¶ä»– console.log
```

### 2. åˆ é™¤è°ƒè¯•å‡½æ•°

```typescript
// âŒ åˆ é™¤æ•´ä¸ªå‡½æ•°
export async function debugFindByOrgId(orgId: string): Promise<AgentRow[]> {
  // ...
}
```

### 3. å¦‚æœéœ€è¦ä¿ç•™æ—¥å¿—ï¼Œä½¿ç”¨ logger

```typescript
// âœ… ä½¿ç”¨é¡¹ç›® loggerï¼Œè®¾ç½®ä¸º DEBUG çº§åˆ«
import { createLogger } from '../lib/logger'

const logger = createLogger('agent-repository')

export async function findByIdAndOrg(id: string, orgId: string): Promise<AgentRow | null> {
  logger.debug('æŸ¥è¯¢ Agent', { id, orgId })

  const result = await sql`
    SELECT * FROM agents
    WHERE id = ${id} AND org_id = ${orgId}
  `

  logger.debug('æŸ¥è¯¢ç»“æœ', { found: result.length > 0 })

  return result[0] || null
}
```

---

## å®Œæ•´ä¿®å¤ä»£ç 

```typescript
// apps/api/src/repositories/agent.repository.ts

import { sql } from '../lib/db'
import { createLogger } from '../lib/logger'

const logger = createLogger('agent-repository')

export interface AgentRow {
  id: string
  org_id: string
  name: string
  description: string | null
  system_prompt: string
  // ... å…¶ä»–å­—æ®µ
}

/**
 * æ ¹æ® ID å’Œç»„ç»‡ ID æŸ¥è¯¢ Agent
 */
export async function findByIdAndOrg(id: string, orgId: string): Promise<AgentRow | null> {
  // âœ… ç§»é™¤è°ƒè¯•æ—¥å¿—ï¼Œæˆ–ä½¿ç”¨ logger.debug
  const result = await sql`
    SELECT * FROM agents
    WHERE id = ${id} AND org_id = ${orgId} AND deleted_at IS NULL
  `

  return result[0] as AgentRow || null
}

/**
 * æ ¹æ®ç»„ç»‡ ID æŸ¥è¯¢ Agent åˆ—è¡¨
 */
export async function findByOrg(params: ListAgentParams): Promise<PaginatedResult<AgentRow>> {
  const { orgId, page = 1, limit = 20, search, isActive } = params

  // âœ… ç§»é™¤è°ƒè¯•æ—¥å¿—
  const offset = (page - 1) * limit
  const actualLimit = Math.min(limit, MAX_PAGE_SIZE)

  // æ„å»ºæŸ¥è¯¢
  let result: AgentRow[]
  let countResult: { count: number }[]

  if (search && isActive !== undefined) {
    result = await sql`
      SELECT * FROM agents
      WHERE org_id = ${orgId}
      AND name ILIKE ${`%${search}%`}
      AND is_active = ${isActive}
      AND deleted_at IS NULL
      ORDER BY created_at DESC
      LIMIT ${actualLimit} OFFSET ${offset}
    `
    countResult = await sql`
      SELECT COUNT(*) as count FROM agents
      WHERE org_id = ${orgId}
      AND name ILIKE ${`%${search}%`}
      AND is_active = ${isActive}
      AND deleted_at IS NULL
    `
  } else if (search) {
    // ... å…¶ä»–æƒ…å†µ
  }

  // âœ… ç§»é™¤è°ƒè¯•æ—¥å¿—
  return {
    data: result,
    meta: {
      total: Number(countResult[0].count),
      page,
      limit: actualLimit,
      totalPages: Math.ceil(Number(countResult[0].count) / actualLimit)
    }
  }
}

// âŒ åˆ é™¤ debugFindByOrgId å‡½æ•°
```

---

## ä¿®å¤æ¸…å•

### åˆ é™¤è°ƒè¯•æ—¥å¿—
- [x] ç¬¬ 118 è¡Œ: `console.log('[AgentRepo] findByIdAndOrg - id:...')`
- [x] ç¬¬ 122 è¡Œ: `console.log('[AgentRepo] findByIdAndOrg result length:...')`
- [x] ç¬¬ 135 è¡Œ: `console.log('[AgentRepo] debugFindByOrgId - orgId:...')`
- [x] ç¬¬ 139 è¡Œ: `console.log('[AgentRepo] debugFindByOrgId result length:...')`
- [x] ç¬¬ 151 è¡Œ: `console.log('[AgentRepo] findByOrg called with orgId:...')`
- [x] ç¬¬ 197 è¡Œ: `console.log('[AgentRepo] Executing basic query...')`
- [x] ç¬¬ 201 è¡Œ: `console.log('[AgentRepo] Basic query result length:...')`
- [x] ç¬¬ 208 è¡Œ: `console.log('[AgentRepo] Count result:...')`
- [x] ç¬¬ 214 è¡Œ: `console.log('[AgentRepo] Returning result with...')`

### åˆ é™¤è°ƒè¯•å‡½æ•°
- [x] åˆ é™¤ `debugFindByOrgId` å‡½æ•°ï¼ˆç¬¬ 134-141 è¡Œï¼‰

### æ£€æŸ¥å…¶ä»–æ–‡ä»¶
- [ ] æœç´¢å…¶ä»–æ–‡ä»¶ä¸­çš„è°ƒè¯•ä»£ç 
- [ ] ç¡®ä¿æ²¡æœ‰å…¶ä»– `debug*` å‡½æ•°

---

## æµ‹è¯•éªŒè¯

### 1. ä»£ç æ£€æŸ¥
```bash
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰è°ƒè¯•æ—¥å¿—
grep -rn "console.log.*AgentRepo" apps/api/src

# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ debug å‡½æ•°
grep -rn "debugFind" apps/api/src
```

### 2. è¿è¡Œæµ‹è¯•
```bash
cd apps/api
pnpm test
```

### 3. åŠŸèƒ½éªŒè¯
- [ ] Agent åˆ—è¡¨æŸ¥è¯¢æ­£å¸¸
- [ ] Agent è¯¦æƒ…æŸ¥è¯¢æ­£å¸¸
- [ ] Agent åˆ›å»º/æ›´æ–°/åˆ é™¤æ­£å¸¸

---

## æ³¨æ„äº‹é¡¹

1. **ä¸è¦åˆ é™¤æœ‰ç”¨çš„æ—¥å¿—**
   - é”™è¯¯æ—¥å¿—åº”ä¿ç•™
   - è¾¹ç•Œæ¡ä»¶æ—¥å¿—åº”ä¿ç•™ï¼ˆç”¨ logger.warnï¼‰
   - åªåˆ é™¤çº¯è°ƒè¯•ç”¨é€”çš„æ—¥å¿—

2. **ä½¿ç”¨æ­£ç¡®çš„æ—¥å¿—çº§åˆ«**
   - DEBUG: å¼€å‘è°ƒè¯•ä¿¡æ¯ï¼ˆç”Ÿäº§ç¯å¢ƒä¸è¾“å‡ºï¼‰
   - INFO: æ­£å¸¸æ“ä½œä¿¡æ¯
   - WARN: è¾¹ç•Œæ¡ä»¶ã€æ½œåœ¨é—®é¢˜
   - ERROR: é”™è¯¯å’Œå¼‚å¸¸

3. **ç¡®ä¿åŠŸèƒ½ä¸å—å½±å“**
   - åˆ é™¤è°ƒè¯•ä»£ç å‰ç¡®è®¤åŠŸèƒ½æ­£å¸¸
   - åˆ é™¤åè¿è¡Œå®Œæ•´æµ‹è¯•

---

## å®Œæˆæ ‡å‡†

- [x] æ‰€æœ‰è°ƒè¯• console.log å·²åˆ é™¤
- [x] debugFindByOrgId å‡½æ•°å·²åˆ é™¤
- [ ] æ²¡æœ‰å…¶ä»–è°ƒè¯•ä»£ç æ®‹ç•™
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] åŠŸèƒ½éªŒè¯é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ç›¸å…³æ–‡æ¡£

- [ç¼–ç è§„èŒƒ - æ—¥å¿—è§„èŒƒ](.claude/rules/coding-standards.md#æ—¥å¿—è§„èŒƒ)
- [ä»»åŠ¡ 01 - ç»Ÿä¸€æ—¥å¿—ä½¿ç”¨](01-ç¼–ç è§„èŒƒ-ç»Ÿä¸€æ—¥å¿—ä½¿ç”¨.md)
