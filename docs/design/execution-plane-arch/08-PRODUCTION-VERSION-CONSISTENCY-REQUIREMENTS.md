# 08 - 生产环境版本一致性关键需求

> 目标：确保执行平面在生产与分布式环境中实现“可发布、可升级、可验证、可回滚”，避免“重启后仍是旧代码”或“多节点版本漂移”。

---

## 1. 问题定义

当前执行平面在本地可通过重启加载磁盘代码，但在生产分布式环境中，`rebootstrap/restart` 不等于代码升级。若缺少统一版本发布与一致性校验，会出现：

- 不同节点运行不同代码版本（新旧混跑）
- 会话命中旧实例导致行为不一致
- 故障后无法快速定位“实例实际运行版本”

---

## 2. 必须实现的关键需求（MUST）

### R1. 版本化发布不可省略

- Runtime/API/Web 必须通过**不可变版本**发布（建议：`image digest` 或 `git sha`）。
- 禁止以 `latest/current` 作为生产运行时版本标识。
- 控制平面在分配执行实例时，必须记录并返回实例运行版本。

**验收标准**

- 任意运行实例可查询到唯一版本标识（非空、可追溯到构建产物）。
- 发布后可通过版本号定位对应代码与构建记录。

### R2. 重启与升级语义分离

- 明确定义两类操作：
- `restart`: 仅重启当前实例，不改变运行版本。
- `rollout`: 升级到指定版本，替换实例。
- `POST /api/v1/vm/rebootstrap` 需显式声明是 restart 还是 rollout，避免语义歧义。

**验收标准**

- 调用 restart 前后版本一致。
- 调用 rollout 后版本变更为目标版本，且旧版本实例被逐步摘除。

### R3. 分布式版本一致性保障

- 控制平面维护“目标版本（desired version）”。
- 调度器只允许分配满足目标版本的执行实例。
- 对不匹配实例执行隔离策略（摘流、重建、标记 unhealthy）。

**验收标准**

- 发布完成后，在线实例版本一致率达到 100%（允许短暂滚动窗口）。
- 新建会话不再分配到旧版本实例。

### R4. 版本探针与健康探针

- 执行平面必须暴露可机器读取的探针（如 `/healthz`、`/version` 或 WS `runtime_info`）。
- 探针至少包含：`service`, `version`, `build_time`, `git_sha`, `ready`。
- API 层与运维脚本必须消费该探针做就绪判断与发布验证。

**验收标准**

- 可以批量拉取所有实例版本并与目标版本比对。
- 任意 1 个会话可回查其执行实例版本。

### R5. 发布后自动校验（Post-deploy Verification）

- 每次 rollout 后自动执行冒烟链路（至少：搜索 + xlsx/pdf 文件生成 + 文件下载）。
- 若校验失败，自动中止后续扩容并触发回滚流程。

**验收标准**

- CI/CD 或发布脚本中有强制校验步骤，失败即发布失败。

### R6. 一键回滚

- 必须支持回滚到上一个稳定版本（控制平面与执行平面都可回滚）。
- 回滚动作完成后需再次执行自动校验。

**验收标准**

- 故障场景下可在目标时间内恢复（建议 < 10 分钟）。
- 回滚后实例版本与目标回滚版本一致。

### R7. 审计与可观测

- 记录版本相关关键事件：`deploy_started/deploy_completed/restart/rollout/rollback/version_mismatch_detected`。
- 指标至少包括：版本分布、版本漂移实例数、rollout 成功率、回滚次数。

**验收标准**

- 通过日志/指标可回答“某次请求由哪个版本处理”。

---

## 3. 推荐实现（SHOULD）

- 引入金丝雀发布（按用户比例或实例比例逐步放量）。
- 版本不一致时对用户提示“系统正在升级，请稍后重试”而不是静默失败。
- 在会话元数据中写入 `runtime_version`，用于问题复盘。

---

## 4. 对现有实现的落地改造清单

1. 将 `version: 'current'` 替换为真实构建版本字段并贯通 API ↔ Runtime ↔ WS 协议。
2. 为 Runtime 增加版本探针与就绪探针，并更新部署健康检查依赖该探针。
3. 在调度器引入 `desired_version` 约束与不匹配实例摘流逻辑。
4. 扩展 `rebootstrap` 接口：支持 `mode=restart|rollout` 与 `target_version`。
5. 在发布流程中加入自动冒烟与失败回滚。

---

## 5. 非目标（当前阶段）

- 不在本阶段实现多区域发布编排。
- 不在本阶段实现跨云容灾调度。

